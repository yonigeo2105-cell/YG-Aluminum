<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× PRO</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0d47a1; --primary-light: #42a5f5; --bg: #f0f4f8; --card: #ffffff; --text-dark: #1a202c; --whatsapp: #25D366; --border: #cbd5e0; --input-bg: #f7fafc; --danger: #e53e3e; }
        body { font-family: 'Rubik', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text-dark); -webkit-tap-highlight-color: transparent; height: 100vh; overflow-x: hidden; }
        
        /* ××¡×š ×›× ×™×¡×” */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0d47a1 0%, #002171 100%); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .login-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box h2 { color: var(--primary); margin-top: 0; margin-bottom: 10px; }
        .login-box p { color: #555; margin-bottom: 15px; font-weight: 500; } 
        .btn-login { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .login-box input { width: 90%; margin-bottom: 10px; text-align: center; font-size: 20px; letter-spacing: 2px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }

        /* ×›×•×ª×¨×ª - ×ª×™×§×•×Ÿ ×’×œ×™×œ×” */
        header { background: linear-gradient(135deg, var(--primary) 0%, #1976d2 100%); color: white; padding: 30px 20px 30px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100; }
        header h1 { margin: 0; font-size: 28px; font-weight: 800; }
        
        .container { padding: 20px; max-width: 650px; margin: 0 auto; padding-bottom: 140px; }
        
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid white; }
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--primary); }
        .btn-delete { background: #fff5f5; color: var(--danger); border: 1px solid #fed7d7; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background-color: var(--input-bg); margin-bottom: 15px; font-family: 'Rubik', sans-serif; box-sizing: border-box; }
        
        .row { display: flex; gap: 12px; } .row > div { flex: 1; }
        .btn-add-item { width: 100%; background: white; color: var(--primary); border: 2px dashed var(--primary-light); padding: 15px; border-radius: 15px; font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
        
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px 25px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); z-index: 100; border-radius: 20px 20px 0 0; display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; text-align: center; }
        .btn-calc { background: linear-gradient(90deg, var(--primary) 0%, #1565c0 100%); color: white; }
        .btn-pdf { background: #e53e3e; color: white; }

        .result-box { background: white; border-radius: 20px; border: 2px solid var(--primary-light); margin-top: 25px; display: none; overflow: hidden; margin-bottom: 20px; }
        .result-header { background: var(--primary-light); color: white; padding: 15px; text-align: center; font-weight: 700; }
        .result-body { padding: 20px; }
        .price-line { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .total-line { font-size: 24px; font-weight: 800; color: var(--primary); border-top: 2px dashed #cbd5e0; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-between; }

        .color-tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; border-radius: 9px; cursor: pointer; color: #718096; transition: all 0.2s; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .extra-panel { background: #f8fafc; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e2e8f0; display: none; }
        .notch-grid { display: flex; gap: 10px; margin-bottom: 10px; }
        .notch-btn { flex: 1; padding: 10px; border: 1px solid var(--border); background: white; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; }
        .notch-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .btn-download-sketch { background-color: #2d3748; color: white; padding: 12px; border-radius: 8px; font-size: 15px; border: none; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .modal-overlay { position: fixed; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 90vh; display: flex; flex-direction: column; overflow-y: auto; }
        canvas#drawingPad { border: 2px dashed #cbd5e0; border-radius: 10px; touch-action: none; background: white; cursor: crosshair; width: 100%; height: 300px; }

        /* ×¡×’× ×•×Ÿ ×œ××•×“×œ PDF */
        .pdf-preview-content { background: white; width: 100%; max-width: 800px; padding: 0; border-radius: 0; height: 100%; overflow-y: auto; }
        .pdf-paper { background: white; padding: 30px; font-family: 'Arial', sans-serif; direction: rtl; min-height: 800px; }
        .pdf-paper table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 20px; }
        .pdf-paper th { background-color: #0d47a1; color: white; padding: 12px; text-align: right; border: 1px solid #ddd; font-size: 14px; }
        .pdf-paper td { padding: 12px; border: 1px solid #ddd; vertical-align: middle; font-size: 14px; }
        .pdf-paper tr:nth-child(even) { background-color: #f9f9f9; }
        .invoice-header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #0d47a1; padding-bottom: 20px; }
        .summary-box { float: left; width: 350px; margin-top: 30px; background: #f8f9fa; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 15px; }
        .summary-row.total { font-weight: bold; font-size: 18px; border-top: 2px solid #0d47a1; border-bottom: none; margin-top: 10px; padding-top: 10px; color: #0d47a1; }

    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
        <h2>×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
        <p>× × ×œ×”×§×™×© ×¡×™×¡××”</p> <input type="password" id="passwordInput" placeholder="****" inputmode="numeric">
        <button class="btn-login" onclick="checkLogin()">×”×™×›× ×¡</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">×¡×™×¡××” ×©×’×•×™×”</p>
    </div>
</div>

<header>
    <h1>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</h1>
    <p style="margin:5px 0 0; opacity:0.9;">××¢×¨×›×ª ×”×¦×¢×•×ª ××—×™×¨</p>
</header>

<div class="container" id="mainApp" style="display:none">
    <div class="card">
        <div class="card-title">ğŸ‘¤ ×¤×¨×˜×™ ×œ×§×•×—</div>
        <label>×©× ×”×œ×§×•×—:</label>
        <input type="text" id="clientName" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
        <div class="row">
            <div style="flex:1"><label>×ª××¨×™×š:</label><input type="date" id="quoteDate"></div>
            <div style="flex:1"><label>××¡' ×”×¦×¢×”:</label><input type="number" id="quoteNumber" style="font-weight:700;text-align:center"></div>
        </div>
    </div>
    
    <div id="itemsContainer"></div>
    
    <button class="btn-add-item" onclick="addItem()">â• ×”×•×¡×£ ××•×¦×¨ ×—×“×©</button>
    
    <div class="card" style="background:#ebf8ff; border:1px solid #bee3f8;">
        <div class="card-title">ğŸ› ï¸ ×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”</div>
        <label>×¢×œ×•×ª ×”×•×‘×œ×”, ×”×ª×§× ×” ×•×¤×™×¨×•×§ (â‚ª):</label>
        <input type="number" id="installationCost" placeholder="0">
    </div>
    
    <div class="result-box" id="resultBox">
        <div class="result-header">×¡×™×›×•× ×”×–×× ×”</div>
        <div class="result-body">
            <div class="price-line"><span>×¡×”"×› ××•×¦×¨×™×:</span><span id="itemsSubtotal">0 â‚ª</span></div>
            <div class="price-line"><span>×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”:</span><span id="installSubtotal">0 â‚ª</span></div>
            <div class="price-line" style="border-top:1px solid #eee; padding-top:10px;"><span>×¡×”"×› ×œ×¤× ×™ ××¢"×:</span><span id="totalSub">0 â‚ª</span></div>
            <div class="price-line"><span>××¢"× (18%):</span><span id="totalVat">0 â‚ª</span></div>
            <div class="total-line"><span>×¡×”"×› ×œ×ª×©×œ×•×:</span><span id="totalFinal">0 â‚ª</span></div>
            
            <button class="btn-add-item" style="margin-top:20px; background:var(--whatsapp); color:white; border:none;" onclick="openPreview()">×©×œ×— ×”×¦×¢×” ×‘×•×•××˜×¡××¤</button>
        </div>
    </div>
</div>

<div class="bottom-actions" id="bottomNav" style="display:none">
    <button class="btn-action btn-calc" onclick="calculateAll()">×—×©×‘ ×¡×”"×› ×œ×ª×©×œ×•×</button>
    <button class="btn-action btn-pdf" onclick="showPdfPreview()">ğŸ“„ ×”×¦×’ ×•×”×•×¨×“ PDF</button>
</div>

<div class="modal-overlay" id="previewModal">
    <div class="modal-content">
        <h3 style="text-align:center;margin:0 0 15px 0;color:var(--primary)">×˜×™×•×˜×ª ×”×•×“×¢×”</h3>
        <textarea id="previewText" style="width:100%; height:150px; font-family:sans-serif; border:1px solid #ccc; padding:10px; border-radius:10px;"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-login" style="background:#ccc; color:black" onclick="document.getElementById('previewModal').style.display='none'">×¡×’×•×¨</button>
            <button class="btn-login" style="background:var(--whatsapp)" onclick="sendWhatsapp()">×©×œ×—</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="pdfPreviewModal" style="background: white;">
    <div class="pdf-preview-content">
        <div style="background: #eee; padding: 10px; display: flex; gap: 10px; position:sticky; top:0; border-bottom:1px solid #ccc;">
            <button class="btn-login" style="background:#e53e3e; margin:0; flex:1" onclick="document.getElementById('pdfPreviewModal').style.display='none'">×¡×’×•×¨</button>
            <button class="btn-login" style="background:var(--primary); margin:0; flex:2" onclick="downloadActualPdf()">â¬‡ï¸ ×”×•×¨×“ ×§×•×‘×¥ PDF</button>
        </div>
        
        <div id="pdfPaperContent" class="pdf-paper"></div>
    </div>
</div>

<div class="modal-overlay" id="drawingModal">
    <div class="modal-content" style="max-width:500px">
        <h3 style="text-align:center;margin:0 0 10px 0;">×œ×•×— ×©×¨×˜×•×˜ ×™×“× ×™</h3>
        <canvas id="drawingPad" width="450" height="300"></canvas>
        <div class="row" style="margin-top:15px">
             <button class="btn-login" style="background:#e53e3e; flex:1" onclick="clearCanvas()">× ×§×”</button>
             <button class="btn-login" style="background:var(--whatsapp); flex:1" onclick="saveDrawing()">×©××•×¨ ×©×¨×˜×•×˜</button>
             <button class="btn-login" style="background:#ccc; flex:1" onclick="closeDrawing()">×‘×™×˜×•×œ</button>
        </div>
    </div>
</div>

<script>
    const profilesDB = {
        "sliding": ["×§×œ×™×œ 7000 ×§×œ××¡×™", "×§×œ×™×œ 9000", "×§×œ×™×œ 9200", "×§×œ×™×œ 1700 ×‘×œ×’×™", "×§×œ×™×œ 2200 ××•×¤×™×¡"],
        "pocket": ["×›×™×¡ ×‘×•×“×“ (2 × ×ª×™×‘×™×)", "×›×™×¡ ×‘×•×“×“ (3 × ×ª×™×‘×™×)", "×›×™×¡ ×›×¤×•×œ (2 × ×ª×™×‘×™×)", "×›×™×¡ ×›×¤×•×œ (3 × ×ª×™×‘×™×)"],
        "hinge": ["×§×œ×™×œ 4500 ×§×œ××¡×™", "×§×œ×™×œ 4300 ×‘×œ×’×™", "×§×œ×™×œ 5500 ×‘××•×”××•×¡", "×§×œ×™×œ 4400"],
        "kipp": ["×§×œ×™×œ 4500 ×§×™×¤", "×§×œ×™×œ 4300 ×§×™×¤", "×§×œ×™×œ 5500 ×§×™×¤"],
        "tilt_turn": ["×§×œ×™×œ 4500 ×“×¨×™×™-×§×™×¤", "×§×œ×™×œ 4300 ×“×¨×™×™-×§×™×¤", "×§×œ×™×œ 5500 ×“×¨×™×™-×§×™×¤"],
        "fixed": ["×§×œ×™×œ 4300 ×‘×œ×’×™ FIX", "×§×œ×™×œ 4500 ×§×œ××¡×™ FIX", "×§×œ×™×œ 2000 ×‘×™×™×¡×™×§ FIX", "×§×œ×™×œ 5500 ××•×¤×™×¡ FIX"],
        "door": ["×“×œ×ª 2000 ×¤× ×œ", "×“×œ×ª ×œ×•×‘×™ ×–×›×•×›×™×ª", "×“×œ×ª ×¦×™×¨ ×‘×œ×’×™ 4300", "×“×œ×ª ××™× ×˜×¨×§×•×", "×“×œ×ª 4500"],
        "shutter": ["×©×œ×‘ 8 (×¨×’×™×œ)", "×©×œ×‘ ××•×¨ (××™× ×™)", "×©×œ×‘ ××•×§×¦×£"],
        "screen_roll": ["×¨×©×ª ×’×œ×™×œ×” (×× ×›×™×ª)", "×¨×©×ª ×”×–×–×”", "×¨×©×ª ×§×‘×•×¢×”"],
        "pergola": ["×¤×¨×•×¤×™×œ ×”×™×™×˜×§ 120/40", "×¤×¨×•×¤×™×œ ×”×™×™×˜×§ 150/50", "×¤×¨×•×¤×™×œ ×“××‘×œ T (Double T)", "×¤×¨×•×¤×™×œ 100/100", "×¨×¤×¤×•×ª Z", "×¨×¤×¤×•×ª ××œ×™×¤×˜×™×•×ª", "×“××•×™ ×¢×¥"],
        "fence": ["×’×“×¨ ×©×œ×‘×™× ××•×¤×§×™×™×", "×’×“×¨ ×”×™×™×˜×§"],
        "shower": ["××§×œ×—×•×Ÿ ×—×–×™×ª", "××§×œ×—×•×Ÿ ×¤×™× ×ª×™"],
        "joker": ["×¢×‘×•×“×” ×›×œ×œ×™×ª"]
    };

    const ralColors = ["RAL 9010 (×œ×‘×Ÿ)", "RAL 9016 (×œ×‘×Ÿ ×‘×•×”×§)", "RAL 9005 (×©×—×•×¨)", "RAL 7016 (××¤×•×¨ ×× ×˜×¨×¦×™×˜)", "RAL 1013 (×©×× ×ª)", "RAL 7035 (××¤×•×¨ ×‘×”×™×¨)", "RAL 7000 (××¤×•×¨ ×¡× ××™)"];
    const klilColors = ["×œ×‘×Ÿ ×§×œ×™×œ", "×©×× ×ª ×§×œ×™×œ", "××¤×•×¨ IRON 400", "×©×—×•×¨ IRON 420", "×œ×‘×Ÿ IRON 100", "×‘×–' IRON 200"];

    let itemCount = 0;
    let activeDrawingBtn = null; 
    
    document.addEventListener('DOMContentLoaded', () => { 
        document.getElementById('quoteDate').valueAsDate = new Date();
        const saved = localStorage.getItem('quoteCounter'); 
        document.getElementById('quoteNumber').value = saved ? saved : 1; 
    });

    function checkLogin() {
        if(document.getElementById('passwordInput').value === '1234') {
            document.getElementById('loginScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                document.getElementById('bottomNav').style.display = 'flex';
            }, 500);
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function addItem() {
        itemCount++;
        const container = document.getElementById('itemsContainer');
        const div = document.createElement('div');
        div.className = 'card fade-in item-card';
        div.id = `item-${itemCount}`;
        
        div.innerHTML = `
            <div class="card-header-row">
                <div class="card-title">××•×¦×¨ #${itemCount}</div>
                <button class="btn-delete" onclick="this.closest('.card').remove()">××—×§</button>
            </div>

            <label>×‘×—×¨ ×¡×•×’ ××•×¦×¨:</label>
            <select class="item-type" onchange="updateItemFields(this)">
                <option value="sliding">×—×œ×•×Ÿ ×”×–×–×”</option>
                <option value="pocket">×—×œ×•×Ÿ ×›×™×¡ (Pocket)</option>
                <option value="hinge">×—×œ×•×Ÿ ×¦×™×¨ (×¨×’×™×œ)</option>
                <option value="kipp">×—×œ×•×Ÿ ×§×™×¤ (×¤×ª×™×—×” ×¢×œ×™×•× ×”)</option>
                <option value="tilt_turn">×—×œ×•×Ÿ ×“×¨×™×™-×§×™×¤ (××©×•×œ×‘)</option>
                <option value="fixed">×§×‘×•×¢ / ×•×™×˜×¨×™× ×”</option>
                <option value="door">×“×œ×ª×•×ª ×›× ×™×¡×” / ×œ×•×‘×™</option>
                <option value="shutter">×ª×¨×™×¡×™×</option>
                <option value="screen_roll">×¨×©×ª×•×ª</option>
                <option value="pergola">×¤×¨×’×•×œ×•×ª</option>
                <option value="fence">×’×“×¨×•×ª</option>
                <option value="shower">××§×œ×—×•× ×™×</option>
                <option value="joker">×›×œ×œ×™</option>
            </select>

            <div class="extra-panel"></div>

            <div class="standard-inputs">
                <label>×“×’× ×¤×¨×•×¤×™×œ:</label><select class="profile-select"><option>×‘×—×¨ ××•×¦×¨ ×§×•×“×</option></select>
                
                <label style="margin-top:10px">×’×•×•×Ÿ ××œ×•××™× ×™×•×:</label>
                <div class="color-tabs">
                    <div class="tab active" onclick="switchColorTab(this, 'ral')">RAL (×˜××‘×•×¨)</div>
                    <div class="tab" onclick="switchColorTab(this, 'klil')">×§×œ×™×œ</div>
                </div>
                <select class="color-select">
                    ${ralColors.map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>

                <div class="glass-section">
                    <label style="margin-top:10px">×–×›×•×›×™×ª:</label>
                    <div class="row">
                        <select class="glass-type">
                            <option value="×˜×¨×™×¤×œ×§×¡ 3+3">×˜×¨×™×¤×œ×§×¡ 3+3</option>
                            <option value="×˜×¨×™×¤×œ×§×¡ 4+4">×˜×¨×™×¤×œ×§×¡ 4+4</option>
                            <option value="×‘×™×“×•×“×™×ª 4-6-4">×‘×™×“×•×“×™×ª 4-6-4</option>
                            <option value="×‘×™×“×•×“×™×ª 6-12-6">×‘×™×“×•×“×™×ª 6-12-6</option>
                            <option value="××—×•×¡××ª 6">××—×•×¡××ª 6 ×"×</option>
                        </select>
                        <select class="glass-finish">
                            <option value="×©×§×•×£">×©×§×•×£</option>
                            <option value="×—×œ×‘×™">×—×œ×‘×™</option>
                            <option value="×× ×˜×™-×¡××Ÿ">×× ×˜×™-×¡××Ÿ</option>
                        </select>
                    </div>
                </div>

                <div class="row" style="margin-top:15px">
                    <div><label>×¨×•×—×‘ (×¡"×)</label><input type="number" class="w-input" placeholder="100"></div>
                    <div><label>×’×•×‘×” (×¡"×)</label><input type="number" class="h-input" placeholder="100"></div>
                </div>
                
                <div class="row" style="margin-top:10px;">
                     <div class="opening-dir-container" style="display:none; flex:1">
                        <label>×›×™×•×•×Ÿ ×¤×ª×™×—×”:</label>
                        <select class="open-dir">
                            <option value="right">×™××™×Ÿ</option>
                            <option value="left">×©×××œ</option>
                        </select>
                     </div>
                </div>

                <div class="row">
                    <div><label>×›××•×ª</label><input type="number" class="qty-input" value="1"></div>
                    <div><label style="color:var(--primary)">××—×™×¨ ×™×—' (â‚ª)</label><input type="number" class="price-input" placeholder="××—×™×¨ ×¤×™×§×¡"></div>
                </div>
                
                <button class="btn-download-sketch" onclick="generateSketch(this)">ğŸ“¸ ×¦×•×¨ ×©×¨×˜×•×˜ ××“×¨×™×›×œ×™</button>
            </div>
            
            <div class="joker-panel" style="display:none">
                <label>×›×•×ª×¨×ª ×”×¢×‘×•×“×”:</label><input type="text" class="joker-title">
                <label>×ª×™××•×¨ ××¤×•×¨×˜:</label><textarea class="joker-desc" rows="3"></textarea>
                
                <div class="row" style="margin-top:10px">
                     <button class="btn-login" style="background:#4a5568" onclick="openDrawing(this)">ğŸ¨ ×¦×™×™×¨ ×©×¨×˜×•×˜</button>
                     <div style="flex:1; position:relative; overflow:hidden;">
                        <button class="btn-login" style="background:#2d3748; width:100%">ğŸ“‚ ×”×¢×œ×” ×ª××•× ×”</button>
                        <input type="file" style="position:absolute; top:0; left:0; opacity:0; width:100%; height:100%" accept="image/*" onchange="previewImage(this)">
                     </div>
                </div>
                
                <div class="img-container" style="position:relative; margin-top:10px; display:none">
                    <img class="img-display" style="width:100%; border-radius:10px; border:1px solid #ccc">
                    <button class="btn-delete" style="position:absolute; top:5px; left:5px; background:rgba(255,255,255,0.9)" onclick="clearJokerImage(this)">ğŸ—‘ï¸ ××—×§ ×©×¨×˜×•×˜</button>
                </div>
                
                <div class="row" style="margin-top:15px">
                    <div><label>×›××•×ª</label><input type="number" class="qty-input-joker" value="1"></div>
                    <div><label style="color:var(--primary)">××—×™×¨ ×’×œ×•×‘×œ×™ (â‚ª)</label><input type="number" class="price-input-joker"></div>
                </div>
            </div>
        `;
        container.appendChild(div);
        updateItemFields(div.querySelector('.item-type'));
    }

    function switchColorTab(tab, type) {
        const card = tab.closest('.card');
        card.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const select = card.querySelector('.color-select');
        select.innerHTML = '';
        const list = type === 'ral' ? ralColors : klilColors;
        list.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            select.appendChild(opt);
        });
    }

    function updateItemFields(select) {
        const card = select.closest('.card');
        const type = select.value;
        const extraPanel = card.querySelector('.extra-panel');
        const stdInputs = card.querySelector('.standard-inputs');
        const jokerPanel = card.querySelector('.joker-panel');
        const profSelect = card.querySelector('.profile-select');
        const dirContainer = card.querySelector('.opening-dir-container');
        const glassSection = card.querySelector('.glass-section');

        // ×’'×•×§×¨
        if(type === 'joker') {
            stdInputs.style.display = 'none'; extraPanel.style.display = 'none'; jokerPanel.style.display = 'block'; return;
        }

        stdInputs.style.display = 'block'; jokerPanel.style.display = 'none';
        
        // ×›×™×•×•×Ÿ ×¤×ª×™×—×”
        dirContainer.style.display = (type === 'hinge' || type === 'door' || type === 'tilt_turn') ? 'block' : 'none';

        // ×”×¡×ª×¨×ª ×–×›×•×›×™×•×ª ×‘×¤×¨×’×•×œ×”/×’×“×¨/×¨×©×ª/×ª×¨×™×¡
        if(type === 'pergola' || type === 'fence' || type === 'shutter' || type === 'screen_roll') {
            glassSection.style.display = 'none';
        } else {
            glassSection.style.display = 'block';
        }

        profSelect.innerHTML = "";
        (profilesDB[type] || []).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.innerText = p;
            profSelect.appendChild(opt);
        });

        let html = '';
        if(type === 'sliding') {
            html = `<div class="row"><div><label>××¡' ×›× ×¤×™×™×</label><input type="number" class="sl-sashes" value="2"></div><div><label>×¡×•×’ ××¤×’×©</label><select class="sl-meeting"><option value="side">×¦×“ ×œ×¦×“</option><option value="center">××¤×’×© ××¨×›×–×™ (× ×•×©×§)</option></select></div></div><label>×—×œ×•×§×” ("×‘×œ×’×™"):</label><select class="sl-div"><option value="none">×œ×œ×</option><option value="strips">×¤×¡×™×</option><option value="grid">×§×•×‘×™×•×ª</option></select>`;
        }
        else if(type === 'pocket') {
            html = `<label>×”×¨×›×‘ ×›× ×£:</label><select class="pkt-comp"><option>×–×›×•×›×™×ª ×‘×œ×‘×“</option><option>×–×›×•×›×™×ª + ×ª×¨×™×¡</option><option>×–×›×•×›×™×ª + ×ª×¨×™×¡ + ×¨×©×ª</option></select><label>×¡×•×’ ××¡×™×œ×”:</label><select class="pkt-rail"><option>2 × ×ª×™×‘×™×</option><option>3 × ×ª×™×‘×™×</option></select>`;
        }
        else if(type === 'fixed') {
            html = `<label>×”×× ×™×© ×—×™×ª×•×š/××’×¨×¢×ª?</label><div class="notch-grid"><div class="notch-btn" onclick="selectNotch(this, 'TL')">âŒœ</div><div class="notch-btn" onclick="selectNotch(this, 'TR')">âŒ</div><div class="notch-btn" onclick="selectNotch(this, 'BL')">âŒ</div><div class="notch-btn" onclick="selectNotch(this, 'BR')">âŒŸ</div></div><input type="hidden" class="notch-pos"><div class="row notch-dims" style="display:none"><input type="number" class="notch-w" placeholder="×¨×•×—×‘ ×—×™×ª×•×š"><input type="number" class="notch-h" placeholder="×’×•×‘×” ×—×™×ª×•×š"></div>`;
        }
        else if(type === 'door') {
            html = `<label>×ª×•×¡×¤×•×ª ×§×‘×•×¢×™×:</label><div class="row"><input type="number" class="dr-top" placeholder="×’×•×‘×” ×§×‘×•×¢ ×¢×œ×™×•×Ÿ"><input type="number" class="dr-side" placeholder="×¨×•×—×‘ ×§×‘×•×¢ ×¦×“"></div><label style="margin-top:10px">××—×–×™×¨ ×©××Ÿ:</label><select class="dr-closer"><option value="none">×œ×œ×</option><option value="top">×—×™×¦×•× ×™</option><option value="floor">×¨×¦×¤×ª×™</option></select>`;
        }
        else if(type === 'shutter') {
            html = `<div class="row"><div><label>××¨×’×–</label><select class="sht-box"><option value="hidden">×¤× ×™××™/× ×¡×ª×¨</option><option value="external">×—×™×¦×•× ×™</option></select></div><div><label>×©×œ×‘</label><select class="sht-slat"><option value="light">×©×œ×‘ ××•×¨</option><option value="foam">××•×§×¦×£</option></select></div></div><div class="row" style="margin-top:10px"><div><label>×× ×•×¢</label><select class="sht-motor"><option>×—×©××œ×™</option><option>×™×“× ×™</option><option>×¡×•××¤×™</option></select></div></div>`;
        }
        else if(type === 'pergola') {
            html = `<div class="row"><div><label>×¡×•×’</label><select class="prg-type" onchange="togglePergolaPost(this)"><option value="wall">×ª×œ×•×™×”</option><option value="stand">×¢×•××“×ª</option></select></div><div class="prg-post-div" style="display:none"><label>×’×•×‘×” ×¢××•×“</label><input type="number" class="prg-post-h" placeholder="250"></div></div><div class="row" style="margin-top:10px"><div><label>×›×™×•×•×Ÿ ×”×¦×œ×œ×”</label><select class="prg-dir"><option value="width">×œ×¨×•×—×‘ (×¤×¡×™×)</option><option value="length">×œ××•×¨×š (×¤×¡×™×)</option><option value="grid">×©×ª×™ ×•×¢×¨×‘ (×›×•×•×¨×ª)</option></select></div><div style="display:flex; align-items:center;"><input type="checkbox" class="prg-gutter" style="width:20px; height:20px"> <span style="margin-right:10px">××¨×–×‘</span></div></div>`;
        }
        else if(type === 'fence') {
            html = `<label>××¨×•×•×— ×‘×™×Ÿ ×©×œ×‘×™× (×¡"×):</label><input type="number" class="fence-space" value="2" placeholder="×œ×“×•×’××”: 2">`;
        }
        
        extraPanel.innerHTML = html ? html : '';
        extraPanel.style.display = html ? 'block' : 'none';
    }

    function togglePergolaPost(select) {
        const div = select.closest('.extra-panel').querySelector('.prg-post-div');
        div.style.display = select.value === 'stand' ? 'block' : 'none';
    }

    function selectNotch(btn, pos) {
        const panel = btn.closest('.extra-panel');
        panel.querySelectorAll('.notch-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        panel.querySelector('.notch-pos').value = pos;
        panel.querySelector('.notch-dims').style.display = 'flex';
    }

    // --- ×œ×•×’×™×§×ª ×’'×•×§×¨ ---
    function openDrawing(btn) { activeDrawingBtn = btn; document.getElementById('drawingModal').style.display = 'flex'; initCanvas(); }
    function closeDrawing() { document.getElementById('drawingModal').style.display = 'none'; }
    function previewImage(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const container = input.closest('.joker-panel').querySelector('.img-container');
                const img = container.querySelector('.img-display');
                img.src = e.target.result;
                container.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    function clearJokerImage(btn) {
        const container = btn.closest('.img-container');
        container.querySelector('.img-display').src = "";
        container.style.display = "none";
        btn.closest('.joker-panel').querySelector('input[type="file"]').value = "";
    }
    
    let canvas, ctx, isDrawing = false;
    function initCanvas() {
        canvas = document.getElementById('drawingPad');
        ctx = canvas.getContext('2d');
        ctx.fillStyle = "white"; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.strokeStyle = "black"; ctx.lineWidth = 3; ctx.lineCap = "round";
        canvas.addEventListener('touchstart', startDraw); canvas.addEventListener('touchmove', draw); canvas.addEventListener('touchend', stopDraw);
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw);
    }
    function startDraw(e) { isDrawing = true; draw(e); }
    function stopDraw() { isDrawing = false; ctx.beginPath(); }
    function draw(e) {
        if (!isDrawing) return; e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
    }
    function clearCanvas() { ctx.fillStyle="white"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.beginPath(); }
    function saveDrawing() {
        const dataURL = canvas.toDataURL();
        const container = activeDrawingBtn.closest('.joker-panel').querySelector('.img-container');
        const img = container.querySelector('.img-display');
        img.src = dataURL;
        container.style.display = 'block';
        closeDrawing();
    }

    function calculateAll() {
        let itemsSum = 0;
        document.querySelectorAll('.item-card').forEach(card => {
            const type = card.querySelector('.item-type').value;
            let q, p;
            if(type === 'joker') {
                q = parseFloat(card.querySelector('.qty-input-joker').value) || 1;
                p = parseFloat(card.querySelector('.price-input-joker').value) || 0;
            } else {
                q = parseFloat(card.querySelector('.qty-input').value) || 1;
                p = parseFloat(card.querySelector('.price-input').value) || 0;
            }
            itemsSum += (q * p);
        });
        const install = parseFloat(document.getElementById('installationCost').value) || 0;
        const totalSub = itemsSum + install;
        const vat = totalSub * 0.18; 
        const final = totalSub + vat;
        document.getElementById('itemsSubtotal').innerText = itemsSum.toLocaleString() + " â‚ª";
        document.getElementById('installSubtotal').innerText = install.toLocaleString() + " â‚ª";
        document.getElementById('totalSub').innerText = totalSub.toLocaleString() + " â‚ª";
        document.getElementById('totalVat').innerText = vat.toLocaleString() + " â‚ª";
        document.getElementById('totalFinal').innerText = final.toLocaleString() + " â‚ª";
        document.getElementById('resultBox').style.display = 'block';
        setTimeout(() => document.getElementById('bottomNav').scrollIntoView({behavior:'smooth'}), 200);
    }

    // --- PDF Logic: ×ª×¦×•×’×” ××§×“×™××” ×•×”×•×¨×“×” ---
    function showPdfPreview() {
        const clientName = document.getElementById('clientName').value || "×™×©×¨××œ ×™×©×¨××œ×™";
        const quoteDate = new Date(document.getElementById('quoteDate').value).toLocaleDateString('he-IL');
        const quoteNum = document.getElementById('quoteNumber').value || "1";
        
        // ×‘× ×™×™×ª ×”-HTML ×©×œ ×”-PDF
        let htmlContent = `
            <div class="invoice-header">
                <h1 style="margin:0; color:#0d47a1; font-size: 32px;">×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</h1>
                <p style="margin:5px 0; font-size: 18px; color: #555;">×”×¦×¢×ª ××—×™×¨ ××§×¦×•×¢×™×ª</p>
                <div style="display:flex; justify-content:space-between; margin-top:30px; font-weight:bold; font-size: 16px;">
                    <span>×œ×§×•×—: ${clientName}</span>
                    <span>×ª××¨×™×š: ${quoteDate}</span>
                    <span>××¡' ×”×¦×¢×”: ${quoteNum}</span>
                </div>
            </div>
            <table>
                <thead>
                    <tr><th style="width:5%">#</th><th style="width:45%">×ª×™××•×¨ ××•×¦×¨</th><th style="width:15%">××™×“×•×ª (×¡"×)</th><th style="width:10%">×›××•×ª</th><th style="width:10%">××—×™×¨ ×™×—'</th><th style="width:15%">×¡×”"×›</th></tr>
                </thead>
                <tbody>
        `;

        let index = 1;
        let itemsSum = 0;
        document.querySelectorAll('.item-card').forEach(card => {
            const typeSelect = card.querySelector('.item-type');
            const typeName = typeSelect.options[typeSelect.selectedIndex].text;
            let desc = `<b>${typeName}</b>`;
            let dims = "";
            let qty = 0, price = 0;

            if(typeSelect.value === 'joker') {
                desc += `<br>${card.querySelector('.joker-title').value} - ${card.querySelector('.joker-desc').value}`;
                qty = parseFloat(card.querySelector('.qty-input-joker').value) || 1;
                price = parseFloat(card.querySelector('.price-input-joker').value) || 0;
                dims = "-";
            } else {
                const profile = card.querySelector('.profile-select').value;
                const color = card.querySelector('.color-select').value;
                desc += `<br>×¤×¨×•×¤×™×œ: ${profile}<br>×¦×‘×¢: ${color}`;
                // ×”×•×¡×¤×ª ×–×›×•×›×™×ª ×¨×§ ×× ×”××•×¦×¨ ××™× ×• ×¤×¨×’×•×œ×”/×’×“×¨ ×•×›×•'
                if(typeSelect.value !== 'pergola' && typeSelect.value !== 'fence') {
                    const glass = card.querySelector('.glass-type').value;
                    desc += `, ×–×›×•×›×™×ª: ${glass}`;
                }
                dims = `${card.querySelector('.w-input').value} / ${card.querySelector('.h-input').value}`;
                qty = parseFloat(card.querySelector('.qty-input').value) || 1;
                price = parseFloat(card.querySelector('.price-input').value) || 0;
            }
            const total = qty * price;
            itemsSum += total;

            htmlContent += `<tr>
                <td>${index++}</td><td>${desc}</td><td style="direction:ltr; text-align:center">${dims}</td><td style="text-align:center">${qty}</td><td>${price.toLocaleString()} â‚ª</td><td>${total.toLocaleString()} â‚ª</td>
            </tr>`;
        });

        const install = parseFloat(document.getElementById('installationCost').value) || 0;
        const totalBeforeVat = itemsSum + install;
        const vat = totalBeforeVat * 0.18;
        const finalTotal = totalBeforeVat + vat;

        htmlContent += `
                </tbody>
            </table>
            <div class="summary-box">
                <div class="summary-row"><span>×¡×”"×› ××•×¦×¨×™× + ×”×ª×§× ×”:</span><span>${totalBeforeVat.toLocaleString()} â‚ª</span></div>
                <div class="summary-row"><span>××¢"× (18%):</span><span>${vat.toLocaleString()} â‚ª</span></div>
                <div class="summary-row total"><span>×¡×”"×› ×œ×ª×©×œ×•×:</span><span>${finalTotal.toLocaleString()} â‚ª</span></div>
            </div>
            <div style="clear:both"></div>
            <div style="margin-top:60px; font-size:12px; color:#555; border-top:1px solid #ccc; padding-top:15px; line-height: 1.8;">
                * ×”××—×™×¨ ×›×•×œ×œ ×”×•×‘×œ×” ×•×”×ª×§× ×”.<br>* ×”×¦×¢×ª ××—×™×¨ ×–××ª ××©××©×ª ×›×—×•×–×” ×¢×‘×•×“×”.<br>* ×”×¡×—×•×¨×” ×‘×‘×¢×œ×•×ª ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× ×¢×“ ×”×ª×©×œ×•× ×”××œ×.<br>* ×”×¦×¢×ª ××—×™×¨ ×ª×§×¤×” ×œ-5 ×™××™ ×¢×¡×§×™×.<br><strong>×‘×›×‘×•×“ ×¨×‘, ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</strong>
            </div>
        `;

        document.getElementById('pdfPaperContent').innerHTML = htmlContent;
        document.getElementById('pdfPreviewModal').style.display = 'flex';
    }

    function downloadActualPdf() {
        const element = document.getElementById('pdfPaperContent');
        const clientName = document.getElementById('clientName').value || "×”×¦×¢×”";
        const opt = {
            margin: 0.5,
            filename: `×”×¦×¢×ª_××—×™×¨_${clientName}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    // --- PRO ARCHITECT ENGINE v5.0 ---
    function generateSketch(btn) {
        const card = btn.closest('.card');
        const typeSelect = card.querySelector('.item-type');
        const type = typeSelect.value;
        const typeName = typeSelect.options[typeSelect.selectedIndex].text; 
        const w = parseFloat(card.querySelector('.w-input').value) || 100;
        const h = parseFloat(card.querySelector('.h-input').value) || 100;
        const profile = card.querySelector('.profile-select').value;
        
        const canvas = document.createElement('canvas');
        canvas.width = 1200; canvas.height = 900;
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = "white"; ctx.fillRect(0,0,1200,900);
        ctx.fillStyle = "#0d47a1"; ctx.font = "bold 40px Arial"; ctx.textAlign = "center";
        ctx.fillText("×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×", 600, 60);
        ctx.fillStyle = "#333"; ctx.font = "24px Arial";
        const client = document.getElementById('clientName').value || "×œ×§×•×—";
        ctx.fillText(`×œ×§×•×—: ${client} | ×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}`, 600, 100);
        
        // ×›×•×ª×¨×ª
        let title = `${typeName} - ${profile}`;
        // ×× ×¤×¨×’×•×œ×” - ××•×¡×™×£ ×’×•×‘×” ×¢××•×“ ×œ×›×•×ª×¨×ª
        if(type === 'pergola' && card.querySelector('.prg-type').value === 'stand') {
            const ph = card.querySelector('.prg-post-h').value;
            title += ` | ×’×•×‘×” ×¢××•×“: ${ph} ×¡"×`;
        }
        ctx.font = "20px Arial"; ctx.fillStyle = "#555";
        ctx.fillText(title, 600, 140);

        const maxDrawW = 700; const maxDrawH = 500;
        const ratio = w / h;
        let dw, dh;
        if (ratio > 1) { dw = maxDrawW; dh = maxDrawW / ratio; if(dh > maxDrawH){ dh = maxDrawH; dw = dh * ratio; } }
        else { dh = maxDrawH; dw = maxDrawH * ratio; if(dw > maxDrawW){ dw = maxDrawW; dh = dw / ratio; } }
        
        const startX = (1200 - dw) / 2;
        const startY = 250;
        
        ctx.strokeStyle = "#333"; ctx.lineWidth = 3;

        // ×©×¨×˜×•×˜×™×
        if (type === 'sliding') {
            ctx.strokeRect(startX, startY, dw, dh);
            const sashes = parseInt(card.querySelector('.sl-sashes').value) || 2;
            const sashW = dw / sashes;
            const meeting = card.querySelector('.sl-meeting').value;
            for(let i=0; i<sashes; i++) {
                const offset = (i % 2 === 0) ? 0 : 15;
                ctx.fillStyle = "rgba(230, 240, 255, 0.5)";
                ctx.fillRect(startX+(i*sashW)+offset, startY+10, sashW-10, dh-20);
                ctx.strokeRect(startX+(i*sashW)+offset, startY+10, sashW-10, dh-20);
                ctx.fillStyle = "black";
                if(meeting === 'center' && (i === Math.floor(sashes/2) || i === Math.floor(sashes/2)-1)) {
                     const handleX = (i === Math.floor(sashes/2)-1) ? startX+(i*sashW)+sashW-5 : startX+(i*sashW)+5;
                     ctx.fillRect(handleX+offset, startY+dh/2-15, 6, 30);
                } else if(meeting !== 'center') { ctx.fillRect(startX+(i*sashW)+offset+5, startY+dh/2-15, 6, 30); }
            }
            ctx.beginPath(); ctx.moveTo(startX, startY+dh/2); ctx.lineTo(startX+dw, startY+dh/2); ctx.lineWidth=1; ctx.stroke(); ctx.lineWidth=3;
            ctx.beginPath();
            ctx.moveTo(startX+20, startY+dh/2-10); ctx.lineTo(startX+10, startY+dh/2); ctx.lineTo(startX+20, startY+dh/2+10);
            ctx.moveTo(startX+dw-20, startY+dh/2-10); ctx.lineTo(startX+dw-10, startY+dh/2); ctx.lineTo(startX+dw-20, startY+dh/2+10);
            ctx.stroke();
        }
        else if (type === 'pocket') {
            ctx.setLineDash([15, 10]); ctx.strokeStyle = "#aaa"; 
            ctx.strokeRect(startX+dw, startY, 150, dh); ctx.setLineDash([]); ctx.strokeStyle = "#333";
            ctx.strokeRect(startX, startY, dw, dh); 
            ctx.beginPath(); ctx.moveTo(startX, startY+dh-5); ctx.lineTo(startX+dw+140, startY+dh-5); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(startX+dw-30, startY+dh/2); ctx.lineTo(startX+dw+60, startY+dh/2); ctx.lineTo(startX+dw+40, startY+dh/2-10); ctx.stroke();
            ctx.fillText("×›×™×¡", startX+dw+50, startY+dh/2-20);
        }
        else if (['hinge', 'kipp', 'tilt_turn'].includes(type)) {
            ctx.strokeRect(startX, startY, dw, dh); ctx.strokeRect(startX+10, startY+10, dw-20, dh-20); 
            ctx.setLineDash([15, 15]); ctx.lineWidth = 2; ctx.beginPath();
            const dir = card.querySelector('.open-dir') ? card.querySelector('.open-dir').value : 'right';
            if (type === 'hinge' || type === 'tilt_turn') {
                if (dir === 'right') { ctx.moveTo(startX+dw, startY); ctx.lineTo(startX, startY+dh/2); ctx.lineTo(startX+dw, startY+dh); } 
                else { ctx.moveTo(startX, startY); ctx.lineTo(startX+dw, startY+dh/2); ctx.lineTo(startX, startY+dh); }
            }
            if (type === 'kipp' || type === 'tilt_turn') { ctx.moveTo(startX, startY+dh); ctx.lineTo(startX+dw/2, startY); ctx.lineTo(startX+dw, startY+dh); }
            ctx.stroke(); ctx.setLineDash([]); ctx.lineWidth = 3;
            ctx.fillStyle = "black";
            if(dir === 'right') ctx.fillRect(startX+20, startY+dh/2-20, 10, 40); else ctx.fillRect(startX+dw-30, startY+dh/2-20, 10, 40);
            if(type === 'kipp') ctx.fillRect(startX+dw/2-20, startY+20, 40, 10);
        }
        else if (type === 'fixed') {
             const pos = card.querySelector('.notch-pos')?.value;
             if(pos) {
                 const cutW = (parseFloat(card.querySelector('.notch-w').value) / w) * dw;
                 const cutH = (parseFloat(card.querySelector('.notch-h').value) / h) * dh;
                 ctx.beginPath(); ctx.moveTo(startX, startY);
                 if(pos === 'TR') { ctx.lineTo(startX+dw-cutW, startY); ctx.lineTo(startX+dw-cutW, startY+cutH); ctx.lineTo(startX+dw, startY+cutH); ctx.lineTo(startX+dw, startY+dh); ctx.lineTo(startX, startY+dh); }
                 else if(pos === 'TL') { ctx.moveTo(startX+cutW, startY); ctx.lineTo(startX+dw, startY); ctx.lineTo(startX+dw, startY+dh); ctx.lineTo(startX, startY+dh); ctx.lineTo(startX, startY+cutH); ctx.lineTo(startX+cutW, startY+cutH); }
                 else { ctx.lineTo(startX+dw, startY); ctx.lineTo(startX+dw, startY+dh); ctx.lineTo(startX, startY+dh); }
                 ctx.closePath(); ctx.fillStyle = "#f0f8ff"; ctx.fill(); ctx.stroke();
                 ctx.fillStyle = "red"; ctx.font = "bold 20px Arial";
                 if(pos === 'TR') { ctx.fillText(card.querySelector('.notch-w').value, startX+dw-cutW/2-10, startY-10); ctx.fillText(card.querySelector('.notch-h').value, startX+dw+5, startY+cutH/2); }
             } else { ctx.strokeRect(startX, startY, dw, dh); }
        }
        else if (type === 'door') {
             let curX = startX; let curY = startY; let doorW = dw; let doorH = dh;
             const topH = parseFloat(card.querySelector('.dr-top')?.value) || 0;
             const sideW = parseFloat(card.querySelector('.dr-side')?.value) || 0;
             if(topH > 0) { const dH = (topH/h)*dh; ctx.strokeRect(startX, startY, dw, dH); curY += dH; doorH -= dH; }
             if(sideW > 0) { const dW = (sideW/w)*dw; ctx.strokeRect(startX, curY, dW, doorH); curX += dW; doorW -= dW; }
             ctx.strokeRect(curX, curY, doorW, doorH); 
             const dir = card.querySelector('.open-dir').value;
             ctx.setLineDash([5,5]); ctx.beginPath();
             if(dir === 'right') { ctx.moveTo(curX+doorW, curY); ctx.lineTo(curX, curY+doorH/2); } else { ctx.moveTo(curX, curY); ctx.lineTo(curX+doorW, curY+doorH/2); }
             ctx.stroke(); 
             ctx.beginPath();
             if(dir === 'right') ctx.arc(curX+doorW, curY+doorH/2, doorW, Math.PI, 0.5*Math.PI, true); else ctx.arc(curX, curY+doorH/2, doorW, 0, 0.5*Math.PI, false);
             ctx.stroke(); ctx.setLineDash([]);
             if(card.querySelector('.dr-closer').value !== 'none') {
                 ctx.strokeRect(curX+doorW/2-30, curY, 60, 20); ctx.beginPath(); ctx.moveTo(curX+doorW/2, curY+20); ctx.lineTo(curX+doorW/2+40, curY+50); ctx.stroke();
             }
        }
        else if (type === 'shutter') {
             const isHidden = card.querySelector('.sht-box').value === 'hidden';
             const isLight = card.querySelector('.sht-slat').value === 'light';
             const boxH = dh * 0.15;
             if(isHidden) { ctx.setLineDash([5,5]); ctx.strokeRect(startX, startY-boxH, dw, boxH); ctx.setLineDash([]); }
             else { ctx.fillStyle = "#ddd"; ctx.fillRect(startX, startY-boxH, dw, boxH); ctx.strokeRect(startX, startY-boxH, dw, boxH); }
             ctx.strokeRect(startX, startY, dw, dh);
             const gap = isLight ? 25 : 15;
             for(let y=0; y<dh; y+=gap) { ctx.strokeRect(startX, startY+y, dw, gap-2); }
        }
        
        else if (type === 'pergola') {
            const roofH = dh * 0.15; 
            ctx.fillStyle = "#eee"; ctx.fillRect(startX, startY, dw, roofH); 
            ctx.strokeStyle = "#333"; ctx.lineWidth = 3; ctx.strokeRect(startX, startY, dw, roofH); 

            const dir = card.querySelector('.prg-dir').value;
            ctx.strokeStyle = "#999"; ctx.lineWidth = 1;
            if(dir === 'width' || dir === 'grid') { for(let y=startY; y<startY+roofH; y+=15) { ctx.beginPath(); ctx.moveTo(startX, y); ctx.lineTo(startX+dw, y); ctx.stroke(); } }
            if(dir === 'length' || dir === 'grid') { for(let x=startX; x<startX+dw; x+=15) { ctx.beginPath(); ctx.moveTo(x, startY); ctx.lineTo(x, startY+roofH); ctx.stroke(); } }
            
            ctx.strokeStyle = "#333"; ctx.lineWidth = 3;
            // ×‘×™×˜×•×œ ×¦×™×•×¨ ×¢××•×“×™× - ×¨×§ ×¦×™×•×Ÿ "×§×™×¨" ×× ×ª×œ×•×™×”
            if(card.querySelector('.prg-type').value === 'wall') {
                ctx.setLineDash([10, 5]); ctx.strokeStyle = "#aaa"; ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(startX - 20, startY - 20); ctx.lineTo(startX - 20, startY + dh); ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = "#555"; ctx.font = "14px Arial"; ctx.fillText("×§×™×¨ ×ª×•××š", startX - 60, startY + dh/2);
            }
            if(card.querySelector('.prg-gutter').checked) { ctx.beginPath(); ctx.arc(startX+dw+10, startY+roofH-10, 10, 0, 2*Math.PI); ctx.stroke(); }
        }
        
        else if(type === 'fence') {
             ctx.strokeRect(startX, startY, dw, dh);
             const spaceCm = parseInt(card.querySelector('.fence-space').value) || 2;
             const spacePx = spaceCm * 5; 
             const barH = 10;
             for(let y=10; y<dh; y += (barH + spacePx)) { ctx.fillRect(startX, startY+y, dw, barH); }
        }
        else { ctx.strokeRect(startX, startY, dw, dh); ctx.strokeRect(startX+10, startY+10, dw-20, dh-20); }

        ctx.strokeStyle = "#0000aa"; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(startX, startY+dh+20); ctx.lineTo(startX, startY+dh+50); ctx.moveTo(startX+dw, startY+dh+20); ctx.lineTo(startX+dw, startY+dh+50); ctx.moveTo(startX, startY+dh+35); ctx.lineTo(startX+dw, startY+dh+35); ctx.stroke();
        ctx.fillStyle = "#0000aa"; ctx.font = "bold 30px Arial"; ctx.textAlign = "center"; ctx.fillText(`${w}`, startX+dw/2, startY+dh+65);
        ctx.beginPath(); ctx.moveTo(startX+dw+20, startY); ctx.lineTo(startX+dw+50, startY); ctx.moveTo(startX+dw+20, startY+dh); ctx.lineTo(startX+dw+50, startY+dh); ctx.moveTo(startX+dw+35, startY); ctx.lineTo(startX+dw+35, startY+dh); ctx.stroke();
        ctx.save(); ctx.translate(startX+dw+65, startY+dh/2); ctx.rotate(-Math.PI/2); ctx.fillText(`${h}`, 0, 0); ctx.restore();

        const link = document.createElement('a');
        link.download = `Sketch_${client}_${type}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }

    function openPreview() {
        let txt = `*×”×¦×¢×ª ××—×™×¨ - ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×*\n×œ×§×•×—: ${document.getElementById('clientName').value}\n×”×¦×¢×” ××¡': ${document.getElementById('quoteNumber').value}\n\n`;
        document.querySelectorAll('.item-card').forEach(c => {
            const typeSelect = c.querySelector('.item-type');
            const type = typeSelect.value;
            const qty = type === 'joker' ? c.querySelector('.qty-input-joker').value : c.querySelector('.qty-input').value;
            const price = type === 'joker' ? c.querySelector('.price-input-joker').value : c.querySelector('.price-input').value;
            
            if(type === 'joker') {
                txt += `ğŸ”¹ *${c.querySelector('.joker-title').value}*\n${c.querySelector('.joker-desc').value}\n`;
            } else {
                const typeName = typeSelect.options[typeSelect.selectedIndex].text;
                const prof = c.querySelector('.profile-select').value;
                const w = c.querySelector('.w-input').value;
                const h = c.querySelector('.h-input').value;
                txt += `ğŸ”¹ *${typeName}* (${prof})\n××™×“×•×ª: ${w}x${h}\n`;
            }
            txt += `×›××•×ª: ${qty} | ××—×™×¨: ${price} â‚ª\n\n`;
        });
        const install = document.getElementById('installationCost').value;
        if(install > 0) txt += `×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”: ${install} â‚ª\n`;
        txt += `*×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"×): ${document.getElementById('totalFinal').innerText}*`;
        document.getElementById('previewText').value = txt;
        document.getElementById('previewModal').style.display = 'flex';
    }

    function sendWhatsapp() { window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('previewText').value)}`); }
</script>
</body>
</html>
