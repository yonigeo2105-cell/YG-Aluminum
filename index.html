<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×™×”×•× ×ª×Ÿ PRO">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <title>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0d47a1; --primary-light: #42a5f5; --bg: #f0f4f8; --card: #ffffff; --text-dark: #1a202c; --whatsapp: #25D366; --border: #cbd5e0; --input-bg: #f7fafc; --danger: #e53e3e; }
        body { font-family: 'Rubik', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text-dark); -webkit-tap-highlight-color: transparent; height: 100vh; overflow-x: hidden; }
        
        /* ××¡×š ×›× ×™×¡×” */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0d47a1 0%, #002171 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .login-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box h2 { color: var(--primary); margin-top: 0; }
        .login-box input { width: 90%; margin-bottom: 15px; text-align: center; font-size: 20px; letter-spacing: 2px; }
        .btn-login { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }

        /* ××¤×œ×™×§×¦×™×” ×¨××©×™×ª */
        header { background: linear-gradient(135deg, var(--primary) 0%, #1976d2 100%); color: white; padding: 30px 20px 40px; text-align: center; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; box-shadow: 0 10px 25px rgba(13,71,161,0.25); position: relative; z-index: 10; }
        header h1 { margin: 0; font-size: 26px; font-weight: 800; }
        .container { padding: 0 20px; max-width: 650px; margin: -30px auto 0; padding-bottom: 140px; position: relative; z-index: 20; display: none; /* ××•×¡×ª×¨ ×¢×“ ×œ×”×ª×—×‘×¨×•×ª */ }
        
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid white; }
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--primary); }
        .min-charge-tag { font-size: 12px; background: #ebf8ff; color: #2b6cb0; padding: 2px 6px; border-radius: 4px; display: none; }
        .btn-delete { background: #fff5f5; color: var(--danger); border: 1px solid #fed7d7; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; }
        
        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 14px; }
        input, select { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background-color: var(--input-bg); margin-bottom: 15px; font-family: 'Rubik', sans-serif; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--primary-light); outline: none; box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.15); background: #fff; }
        
        .row { display: flex; gap: 12px; } .row > div { flex: 1; }
        .color-tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; border-radius: 9px; cursor: pointer; color: var(--text-light); transition: all 0.2s; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .btn-add-item { width: 100%; background: white; color: var(--primary); border: 2px dashed var(--primary-light); padding: 15px; border-radius: 15px; font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px 25px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); z-index: 100; border-radius: 20px 20px 0 0; display: none; }
        .btn-calc { width: 100%; background: linear-gradient(90deg, var(--primary) 0%, #1565c0 100%); color: white; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; box-shadow: 0 4px 15px rgba(13, 71, 161, 0.3); }
        
        .result-box { background: white; border-radius: 20px; border: 2px solid var(--primary-light); margin-top: 25px; display: none; overflow: hidden; margin-bottom: 20px; }
        .result-header { background: var(--primary-light); color: white; padding: 15px; text-align: center; font-weight: 700; }
        .result-body { padding: 20px; }
        .price-line { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .total-line { font-size: 24px; font-weight: 800; color: var(--primary); border-top: 2px dashed #cbd5e0; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-between; }
        
        .modal-overlay { position: fixed; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 90vh; display: flex; flex-direction: column; overflow-y: auto; }
        .preview-text { background: #f7fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; white-space: pre-wrap; font-size: 13px; margin-bottom: 15px; line-height: 1.5; }
        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 700; font-size: 16px; }
        .btn-cancel { background: #edf2f7; } .btn-send { background: var(--whatsapp); color: white; }
        
        .btn-download-sketch { background-color: #2d3748; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; border: none; cursor: pointer; margin-top: 10px; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 100%; justify-content: center; }
        .btn-download-sketch:active { transform: scale(0.98); }
        
        /* ×”×¡×ª×¨×ª ×§× ×‘×¡ */
        canvas { display: none; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
        <h2>×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
        <p>× × ×œ×”×§×™×© ×¡×™×¡××”</p>
        <input type="password" id="passwordInput" placeholder="****" inputmode="numeric">
        <button class="btn-login" onclick="checkLogin()">×”×™×›× ×¡</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">×¡×™×¡××” ×©×’×•×™×”</p>
    </div>
</div>

<header><h1>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</h1><p>××¢×¨×›×ª ×”×¦×¢×•×ª ××—×™×¨ ××§×¦×•×¢×™×ª</p></header>

<div class="container" id="mainApp">
    <div class="card">
        <div class="card-title">ğŸ‘¤ ×¤×¨×˜×™ ×œ×§×•×—</div>
        <div class="row">
            <div style="flex:2"><label>×©× ×”×œ×§×•×—:</label><input type="text" id="clientName" placeholder="×™×©×¨××œ ×™×©×¨××œ×™"></div>
            <div style="flex:1"><label>××¡' ×”×¦×¢×”:</label><input type="number" id="quoteNumber" style="font-weight:700;text-align:center"></div>
        </div>
    </div>
    
    <div id="itemsContainer"></div>
    
    <button class="btn-add-item" onclick="addItem()">â• ×”×•×¡×£ ××•×¦×¨ ×—×“×©</button>
    
    <div class="card" style="background:#ebf8ff; border:1px solid #bee3f8;">
        <div class="card-title">ğŸ› ï¸ ×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”</div>
        <label>×¡×”"×› ×¢×œ×•×ª ×”×•×‘×œ×”, ×”×ª×§× ×” ×•×¤×™×¨×•×§ (â‚ª):</label>
        <input type="number" id="installationCost" placeholder="0">
    </div>
    
    <div class="result-box" id="resultBox">
        <div class="result-header">×¡×™×›×•× ×”×–×× ×”</div>
        <div class="result-body">
            <div class="price-line"><span>××•×¦×¨×™ ××œ×•××™× ×™×•×:</span><span id="itemsSubtotal">0 â‚ª</span></div>
            <div class="price-line"><span>×”×ª×§× ×” ×•×¢×‘×•×“×”:</span><span id="installSubtotal">0 â‚ª</span></div>
            <div class="price-line" style="border-top:1px solid #eee; padding-top:10px; font-weight:bold;"><span>×¡×”"×› ×œ×¤× ×™ ××¢"×:</span><span id="totalSub">0 â‚ª</span></div>
            <div class="price-line"><span>××¢"× (18%):</span><span id="totalVat">0 â‚ª</span></div>
            <div class="total-line"><span>×¡×”"×› ×œ×ª×©×œ×•×:</span><span id="totalFinal">0 â‚ª</span></div>
            <button class="btn-add-item" style="margin-top:20px; background:var(--whatsapp); color:white; border:none;" onclick="openPreview()">×©×œ×— ×”×¦×¢×” ×‘×•×•××˜×¡××¤</button>
        </div>
    </div>
</div>

<div class="bottom-actions" id="bottomNav"><button class="btn-calc" onclick="calculateAll()">×—×©×‘ ×¡×”"×› ×œ×ª×©×œ×•×</button></div>

<div class="modal-overlay" id="previewModal">
    <div class="modal-content">
        <h3 style="text-align:center;margin:0 0 15px 0;color:var(--primary)">×˜×™×•×˜×ª ×”×•×“×¢×”</h3>
        <div class="preview-text" id="previewText"></div>
        <div class="modal-btns">
            <button class="btn-modal btn-cancel" onclick="closePreview()">×¢×¨×•×š</button>
            <button class="btn-modal btn-send" onclick="sendWhatsapp()">×©×œ×—</button>
        </div>
    </div>
</div>

<script>
// --- ××‘×˜×—×” ---
function checkLogin() {
    const pass = document.getElementById('passwordInput').value;
    // ×”×’×“×¨×ª ×¡×™×¡××” ×›××Ÿ
    if (pass === '1234') {
        document.getElementById('loginScreen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loginScreen').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            document.querySelector('.bottom-actions').style.display = 'block';
        }, 500);
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

// --- ×××’×¨×™ × ×ª×•× ×™× ---
const profilesDB = {
    "window_slide": ["×§×œ×™×œ 7000 (×§×œ××¡×™)", "×§×œ×™×œ 9000 (×™×•×§×¨×ª×™)", "×§×œ×™×œ 9200 (×¤× ×•×¨××™)", "×§×œ×™×œ 1700 (×‘×œ×’×™)", "×§×œ×™×œ 7300 (×‘×œ×’×™)", "×§×œ×™×œ 2200 (××•×¤×™×¡)", "×‘××•×”××•×¡ ×”×–×–×”", "××§×¡×˜×œ 22"],
    "window_hinge": ["×§×œ×™×œ 4300 (×‘×œ×’×™)", "×§×œ×™×œ 4400 (×§×œ××¡×™)", "×§×œ×™×œ 4500 (×¡×™×¡×˜×)", "×§×œ×™×œ 5500 (×‘××•×”××•×¡)"],
    "window_kipp": ["×§×œ×™×œ 4300 ×§×™×¤", "×§×œ×™×œ 4400 ×§×™×¤", "×§×œ×™×œ 4500 ×§×™×¤", "×§×œ×™×œ 5500 ×§×™×¤ (×‘××•×”××•×¡)"],
    "window_drykeep": ["×“×¨×™×™-×§×™×¤ 4300 (×‘×œ×’×™)", "×“×¨×™×™-×§×™×¤ 4500 (×§×œ××¡×™)", "×“×¨×™×™-×§×™×¤ 5500 (×‘××•×”××•×¡)", "×“×¨×™×™-×§×™×¤ ××§×¡×˜×œ C10"],
    "window_fixed": ["×§×‘×•×¢ 4300", "×§×‘×•×¢ 4400", "×§×‘×•×¢ 7000", "×§×‘×•×¢ 9000", "×§×‘×•×¢ ×‘××•×”××•×¡", "×§×‘×•×¢ ×œ×œ× ××¡×’×¨×ª (×–×›×•×›×™×ª ×‘×œ×‘×“)"],
    "vitrine": ["×•×™×˜×¨×™× ×” ×§×œ×™×œ 9000", "×•×™×˜×¨×™× ×” ×§×œ×™×œ 9200", "×•×™×˜×¨×™× ×” ×§×œ×™×œ 7300", "×•×™×˜×¨×™× ×” ××™× ×™××œ"],
    "shutter": ["×©×œ×‘ ××•×§×¦×£", "×©×œ×‘ ××©×•×š (×—×–×§)", "×©×œ×‘ ××•×¨", "×©×œ×‘ ××•×¨-×§×œ (××™× ×™)", "×©×œ×‘ ××©×•×š-×¢×œ (××™×’×•×Ÿ)", "××¨×’×– ××•× ×•×‘×œ×•×§"],
    "door": ["×“×œ×ª ×§×œ×™×œ 4300 (×‘×œ×’×™)", "×“×œ×ª ×§×œ×™×œ 2000 (××•×¤×™×¡)", "×“×œ×ª ×›× ×™×¡×” 4900", "×“×œ×ª ××™× ×˜×¨×§×•×", "×“×œ×ª ×¨×‘ ×‘×¨×™×—"],
    "screen": ["×¨×©×ª ×’×œ×™×œ×”", "×¨×©×ª ×”×–×–×”", "×¨×©×ª ×§×‘×•×¢×”", "×¨×©×ª ×©×§×•×¤×”", "×¨×©×ª ×’×¨×× ×™×ª"],
    "pergola": ["×¤×¨×’×•×œ×” ×ª×œ×•×™×”", "×¤×¨×’×•×œ×” ×¢×•××“×ª", "×’×“×¨ ××œ×•××™× ×™×•×", "××¡×ª×•×¨ ×›×‘×™×¡×”"]
};

// ×× ×™×¤×ª ×˜××‘×•×¨ RAL ××œ××” (×“×•×’××™×ª ×œ××‘× ×” ×—×›×)
const ralCategories = {
    "white_black": { name: "×œ×‘× ×™× ×•×©×—×•×¨×™×", colors: ["RAL 9010 (×œ×‘×Ÿ ×˜×”×•×¨)", "RAL 9016 (×œ×‘×Ÿ ×‘×•×”×§)", "RAL 9003 (×œ×‘×Ÿ ×¡×™×’× ×œ)", "RAL 9005 (×©×—×•×¨ ×’'×˜)", "RAL 9011 (×©×—×•×¨ ×’×¨×¤×™×˜)", "RAL 9017 (×©×—×•×¨ ×ª×¢×‘×•×¨×”)"] },
    "grey": { name: "××¤×•×¨×™×", colors: ["RAL 7035 (××¤×•×¨ ×‘×”×™×¨)", "RAL 7000 (××¤×•×¨ ×¡× ××™)", "RAL 7016 (××¤×•×¨ ×× ×˜×¨×¦×™×˜)", "RAL 7021 (××¤×•×¨ ×›×”×”)", "RAL 7030 (××¤×•×¨ ××‘×Ÿ)", "RAL 7032 (××¤×•×¨ ×—×œ×•×§×™×)", "RAL 7037 (××¤×•×¨ ×××•×‘×§)", "RAL 7040 (××¤×•×¨ ×—×œ×•×Ÿ)", "RAL 9006 (××œ×•××™× ×™×•× ×œ×‘×Ÿ)", "RAL 9007 (××œ×•××™× ×™×•× ××¤×•×¨)"] },
    "brown": { name: "×—×•××™× ×•×‘×–'", colors: ["RAL 8014 (×—×•× ×¡×¤×™×”)", "RAL 8017 (×—×•× ×©×•×§×•×œ×“)", "RAL 8019 (×—×•× ××¤×•×¨)", "RAL 1013 (×œ×‘×Ÿ ×¤× ×™× ×”/×©×× ×ª)", "RAL 1015 (×‘×–' ×‘×”×™×¨)", "RAL 1001 (×‘×–')"] },
    "blue": { name: "×›×—×•×œ×™×", colors: ["RAL 5003 (×›×—×•×œ ×¡×¤×™×¨)", "RAL 5005 (×›×—×•×œ ×¡×™×’× ×œ)", "RAL 5010 (×›×—×•×œ ×’× ×¦×™××Ÿ)", "RAL 5012 (×›×—×•×œ ×‘×”×™×¨)", "RAL 5014 (×›×—×•×œ ×™×•× ×”)"] },
    "green": { name: "×™×¨×•×§×™×", colors: ["RAL 6005 (×™×¨×•×§ ×˜×—×‘)", "RAL 6009 (×™×¨×•×§ ××©×•×—)", "RAL 6019 (×™×¨×•×§ ×¤×¡×˜×œ)", "RAL 6021 (×™×¨×•×§ ×—×™×•×•×¨)"] },
    "red_orange": { name: "××“×•××™× ×•×›×ª×•××™×", colors: ["RAL 3000 (××“×•× ××©)", "RAL 3004 (×‘×•×¨×“×•)", "RAL 2004 (×›×ª×•× ×˜×”×•×¨)", "RAL 2009 (×›×ª×•× ×ª×¢×‘×•×¨×”)"] }
};

let itemCount = 0; let finalLink = "";
document.addEventListener('DOMContentLoaded', () => { 
    const saved = localStorage.getItem('quoteCounter'); 
    document.getElementById('quoteNumber').value = saved ? saved : 1; 
});

function addItem() {
    itemCount++;
    const container = document.getElementById('itemsContainer');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'card fade-in item-card';
    itemDiv.id = `item-${itemCount}`;
    
    // ×‘× ×™×™×ª HTML ×“×™× ××™
    let ralOptionsHTML = "";
    for (const [key, cat] of Object.entries(ralCategories)) {
        ralOptionsHTML += `<option value="${key}">${cat.name}</option>`;
    }

    itemDiv.innerHTML = `
        <div class="card-header-row"><div class="card-title">××•×¦×¨ #${itemCount} <span class="min-charge-tag">××™× ×™××•× 1 ×"×¨</span></div><button class="btn-delete" onclick="removeItem('${itemDiv.id}')">××—×§</button></div>
        
        <label>×‘×—×¨ ×¡×•×’ ××•×¦×¨:</label>
        <select class="item-product" onchange="updateItemFields(this)">
            <option value="" disabled selected>-- ×‘×—×¨ --</option>
            <option value="window_slide">×—×œ×•×Ÿ ×”×–×–×”</option>
            <option value="window_hinge">×—×œ×•×Ÿ ×¤×ª×™×—×” (×¦×™×¨)</option>
            <option value="window_kipp">×—×œ×•×Ÿ ×§×™×¤ (×¤×ª×™×—×” ×¢×œ×™×•× ×”)</option>
            <option value="window_drykeep">×—×œ×•×Ÿ ×“×¨×™×™-×§×™×¤</option>
            <option value="window_fixed">×—×œ×•×Ÿ ×§×‘×•×¢ (FIX)</option>
            <option value="vitrine">×•×™×˜×¨×™× ×”</option>
            <option value="shutter">×ª×¨×™×¡ ×’×œ×™×œ×”</option>
            <option value="door">×“×œ×ª×•×ª</option>
            <option value="screen">×¨×©×ª×•×ª</option>
            <option value="pergola">×¤×¨×’×•×œ×•×ª/×’×“×¨×•×ª</option>
        </select>
        
        <div class="section-wings" style="display:none; background:#fffbe6; padding:15px; border-radius:10px; margin-bottom:15px;">
            <div class="row">
                <div style="flex:1"><label>××¡' ×›× ×¤×™×™×:</label><select class="item-wings"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option></select></div>
                <div style="flex:1"><label>×¡×•×’ ×¡×’×™×¨×”:</label><select class="item-mifgash"><option value="×œ×œ× ××¤×’×©">×œ×œ× ××¤×’×©</option><option value="××¤×’×© (××¨×›×–)">××¤×’×© (××¨×›×–)</option></select></div>
            </div>
        </div>

        <div class="section-direction" style="display:none; background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:15px;">
            <label>×›×™×•×•×Ÿ ×¤×ª×™×—×” (××‘×˜ ×¤× ×™×):</label>
            <select class="item-direction"><option value="×™××™×Ÿ">×™××™×Ÿ (×¦×™×¨ ×™××™×Ÿ)</option><option value="×©×××œ">×©×××œ (×¦×™×¨ ×©×××œ)</option></select>
        </div>

        <div class="section-shape" style="display:none; background:#f3e5f5; padding:15px; border-radius:10px; margin-bottom:15px;">
            <label>×¦×•×¨×ª ×—×œ×•×Ÿ:</label>
            <select class="item-shape-type" onchange="toggleShapeInputs(this)">
                <option value="rect">××œ×‘×Ÿ ×¨×’×™×œ</option>
                <option value="special">×˜×¨×¤×– / ××©×•×œ×© (×œ× ×¡×˜× ×“×¨×˜×™)</option>
            </select>
        </div>

        <div class="section-pergola" style="display:none; background:#f0fff4; padding:15px; border-radius:10px; margin-bottom:15px;">
            <label>×›×™×•×•×Ÿ ×¤×¡×™× (×¨×¤×¤×•×ª):</label>
            <select class="item-pergola-dir"><option value="parallel">×œ×¨×•×—×‘ (××§×‘×™×œ ×œ×—×–×™×ª)</option><option value="perpendicular">×œ×¢×•××§ (× ×™×¦×‘ ×œ×—×–×™×ª)</option></select>
            <div style="margin-top:10px"><label>×¢×•××§ ×™×¦×™××” (×¡"×):</label><input type="number" class="item-depth" placeholder="300"></div>
        </div>

        <label>×“×’× ×¤×¨×•×¤×™×œ:</label><select class="item-profile"><option value="">×‘×—×¨ ×§×•×“× ××•×¦×¨...</option></select>
        
        <label style="margin-top:10px">×’×•×•×Ÿ ××œ×•××™× ×™×•×:</label>
        <div class="color-tabs">
            <div class="tab active" onclick="switchColorTab(this, 'ral')">RAL (×˜××‘×•×¨)</div>
            <div class="tab" onclick="switchColorTab(this, 'klil')">×§×œ×™×œ</div>
        </div>
        <div class="ral-container">
            <div class="row">
                <div style="flex:1">
                    <select onchange="updateRalOptions(this)">
                        <option value="" disabled selected>×¡× ×Ÿ ×œ×¤×™ ××©×¤×—×”...</option>
                        ${ralOptionsHTML}
                    </select>
                </div>
                <div style="flex:2">
                    <select class="item-color ral-select"><option value="">×‘×—×¨ ××©×¤×—×” ×§×•×“×...</option></select>
                </div>
            </div>
        </div>
        <div class="klil-container" style="display:none">
            <select class="item-color-klil">
                <optgroup label="×§×œ×™×œ ×§×œ××¡×™×§"><option value="×œ×‘×Ÿ ×§×œ××¡×™×§">×œ×‘×Ÿ ×§×œ××¡×™×§</option><option value="×©×× ×ª ×§×œ××¡×™×§">×©×× ×ª ×§×œ××¡×™×§</option></optgroup>
                <optgroup label="×§×œ×™×œ IRON"><option value="IRON 100 ×œ×‘×Ÿ">IRON 100 ×œ×‘×Ÿ</option><option value="IRON 400 ××¤×•×¨">IRON 400 ××¤×•×¨</option><option value="IRON 420 ×©×—×•×¨">IRON 420 ×©×—×•×¨</option></optgroup>
                <optgroup label="FINE IRON"><option value="FINE IRON 9010">FINE IRON 9010</option><option value="FINE IRON 7016">FINE IRON 7016</option><option value="FINE IRON 9005">FINE IRON 9005</option></optgroup>
            </select>
        </div>
        
        <label style="margin-top:10px">×–×›×•×›×™×ª:</label>
        <div class="row">
            <div style="flex:2"><select class="item-glass-type"><option value="×œ×œ× ×–×›×•×›×™×ª">×œ×œ× ×–×›×•×›×™×ª</option><option value="×˜×¨×™×¤×œ×§×¡ 3+3">×˜×¨×™×¤×œ×§×¡ 3+3</option><option value="×˜×¨×™×¤×œ×§×¡ 4+4">×˜×¨×™×¤×œ×§×¡ 4+4</option><option value="×‘×™×“×•×“×™×ª 4-6-4">×‘×™×“×•×“×™×ª 4-6-4</option><option value="×‘×™×“×•×“×™×ª 6-12-6">×‘×™×“×•×“×™×ª 6-12-6</option><option value="××—×•×¡××ª 6">××—×•×¡××ª 6 ×''×</option><option value="××—×•×¡××ª 8">××—×•×¡××ª 8 ×''×</option></select></div>
            <div style="flex:1"><select class="item-glass-finish"><option value="×©×§×•×£">×©×§×•×£</option><option value="×—×œ×‘×™">×—×œ×‘×™</option><option value="×× ×˜×™-×¡××Ÿ">×× ×˜×™-×¡××Ÿ</option></select></div>
        </div>
        
        <div class="row" style="margin-top:15px">
            <div><label class="label-width">×¨×•×—×‘ (×¡"×):</label><input type="number" class="item-width" placeholder="100"></div>
            <div><label class="label-height">×’×•×‘×” (×¡"×):</label><input type="number" class="item-height" placeholder="100"></div>
        </div>
        
        <div class="special-dims row" style="display:none; background:#f3e5f5; padding:10px; border-radius:8px;">
            <div><label>×’×•×‘×” ×™××™×Ÿ (×¡"×):</label><input type="number" class="item-h1" placeholder="×œ××©×œ 60"></div>
            <div><label>×’×•×‘×” ×©×××œ (×¡"×):</label><input type="number" class="item-h2" placeholder="×œ××©×œ 30"></div>
        </div>

        <label style="color:var(--primary)">××—×™×¨ ×œ×"×¨ (×œ×¤× ×™ ××¢"×):</label><input type="number" class="item-price" placeholder="â‚ª">
        
        <button class="btn-download-sketch" onclick="generateSketch(this)">
            ğŸ“¸ ×”×•×¨×“ ×©×¨×˜×•×˜ ××“×¨×™×›×œ×™
        </button>
    `;
    container.appendChild(itemDiv);
}

function removeItem(id) { document.getElementById(id).remove(); }

function updateItemFields(el) {
    const card = el.closest('.card');
    const val = el.value;
    
    // ××™×¤×•×¡ ×ª×¦×•×’×”
    card.querySelector('.section-wings').style.display = 'none';
    card.querySelector('.section-direction').style.display = 'none';
    card.querySelector('.section-pergola').style.display = 'none';
    card.querySelector('.section-shape').style.display = 'none';
    card.querySelector('.special-dims').style.display = 'none';
    
    card.querySelector('.label-width').innerText = "×¨×•×—×‘ (×¡\"×):";
    card.querySelector('.label-height').innerText = "×’×•×‘×” (×¡\"×):";
    card.querySelector('.item-height').disabled = false;

    // ×œ×•×’×™×§×ª ×ª×¦×•×’×”
    if (val === 'window_slide' || val === 'vitrine') {
        card.querySelector('.section-wings').style.display = 'block';
    } else if (['window_hinge', 'window_kipp', 'window_drykeep', 'door'].includes(val)) {
        card.querySelector('.section-direction').style.display = 'block';
    } else if (val === 'window_fixed') {
        card.querySelector('.section-shape').style.display = 'block';
    } else if (val === 'pergola') {
        card.querySelector('.section-pergola').style.display = 'block';
        card.querySelector('.label-width').innerText = "×¨×•×—×‘ ×—×–×™×ª (×¡\"×):";
        card.querySelector('.label-height').innerText = "×’×•×‘×” (×œ×¢××•×“×™×):";
    }

    // ×¢×“×›×•×Ÿ ×¤×¨×•×¤×™×œ×™×
    const profSelect = card.querySelector('.item-profile');
    profSelect.innerHTML = "";
    if (val && profilesDB[val]) {
        profilesDB[val].forEach(p => {
            const o = document.createElement('option'); o.value = p; o.innerText = p; profSelect.appendChild(o);
        });
    } else { profSelect.innerHTML = '<option>××™×Ÿ ×¤×¨×•×¤×™×œ×™×</option>'; }
}

function toggleShapeInputs(el) {
    const card = el.closest('.card');
    const shape = el.value;
    const specialDiv = card.querySelector('.special-dims');
    const heightInput = card.querySelector('.item-height');
    
    if (shape === 'special') {
        specialDiv.style.display = 'flex';
        heightInput.value = "";
        heightInput.placeholder = "××—×•×©×‘ ××•×˜×•××˜×™×ª";
        heightInput.disabled = true; // ××‘×˜×œ ×”×–× ×ª ×’×•×‘×” ×¨×’×™×œ ×›×™ ×™×© ×’×‘×”×™× ×¦×“×“×™×™×
    } else {
        specialDiv.style.display = 'none';
        heightInput.disabled = false;
        heightInput.placeholder = "100";
    }
}

// × ×™×”×•×œ ×¦×‘×¢×™× RAL
function updateRalOptions(catSelect) {
    const card = catSelect.closest('.card');
    const colorSelect = card.querySelector('.ral-select');
    const category = ralCategories[catSelect.value];
    
    colorSelect.innerHTML = "";
    if (category) {
        category.colors.forEach(c => {
            const o = document.createElement('option'); o.value = c; o.innerText = c; colorSelect.appendChild(o);
        });
    }
}
function switchColorTab(tab, type) {
    const card = tab.closest('.card');
    card.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    card.querySelector('.ral-container').style.display = type === 'ral' ? 'block' : 'none';
    card.querySelector('.klil-container').style.display = type === 'klil' ? 'block' : 'none';
    card.setAttribute('data-color-source', type);
}

// ×—×™×©×•×‘×™×
function calculateAll() {
    const cards = document.querySelectorAll('.item-card');
    let sub = 0; let valid = true;
    
    if (cards.length === 0) { alert("×œ× ×”×•×¡×¤×ª ×¤×¨×™×˜×™×"); return; }
    
    cards.forEach(c => {
        const type = c.querySelector('.item-product').value;
        const width = parseFloat(c.querySelector('.item-width').value);
        let height = parseFloat(c.querySelector('.item-height').value);
        const price = parseFloat(c.querySelector('.item-price').value);
        
        // ×œ×•×’×™×§×” ××™×•×—×“×ª ×œ×—×™×©×•×‘ ×©×˜×—
        let area = 0;
        
        if (type === 'pergola') {
            const depth = parseFloat(c.querySelector('.item-depth').value);
            if (!width || !depth || !price) { c.style.border = "2px solid red"; valid = false; return; }
            area = (width * depth) / 10000;
        } 
        else if (type === 'window_fixed' && c.querySelector('.item-shape-type').value === 'special') {
            const h1 = parseFloat(c.querySelector('.item-h1').value);
            const h2 = parseFloat(c.querySelector('.item-h2').value);
            if (!width || isNaN(h1) || isNaN(h2) || !price) { c.style.border = "2px solid red"; valid = false; return; }
            // ×©×˜×— ×˜×¨×¤×–: ×¨×•×—×‘ ×›×¤×•×œ ×××•×¦×¢ ×”×’×‘×”×™×
            const avgHeight = (h1 + h2) / 2;
            area = (width * avgHeight) / 10000;
        } 
        else {
            // ××œ×‘×Ÿ ×¨×’×™×œ
            if (!width || !height || !price) { c.style.border = "2px solid red"; valid = false; return; }
            area = (width * height) / 10000;
        }
        
        c.style.border = "1px solid white";
        if (area < 1.0) { area = 1.0; c.querySelector('.min-charge-tag').style.display = 'inline-block'; } 
        else { c.querySelector('.min-charge-tag').style.display = 'none'; }
        
        sub += area * price;
    });

    if (!valid) { alert("×—×¡×¨×™× × ×ª×•× ×™× ×‘×—×œ×§ ××”×¤×¨×™×˜×™×"); return; }

    const install = parseFloat(document.getElementById('installationCost').value) || 0;
    const totalSub = sub + install;
    const vat = totalSub * 0.18;
    const final = totalSub + vat;

    document.getElementById('itemsSubtotal').innerText = sub.toLocaleString(undefined, {maximumFractionDigits:0}) + " â‚ª";
    document.getElementById('installSubtotal').innerText = install.toLocaleString() + " â‚ª";
    document.getElementById('totalSub').innerText = totalSub.toLocaleString(undefined, {maximumFractionDigits:0}) + " â‚ª";
    document.getElementById('totalVat').innerText = vat.toLocaleString(undefined, {maximumFractionDigits:0}) + " â‚ª";
    document.getElementById('totalFinal').innerText = final.toLocaleString(undefined, {maximumFractionDigits:0}) + " â‚ª";
    
    document.getElementById('resultBox').style.display = 'block';
    setTimeout(() => document.querySelector('.bottom-actions').scrollIntoView({behavior: 'smooth'}), 200);
}

// ×•×•××˜×¡××¤
function openPreview() {
    if (document.getElementById('resultBox').style.display === 'none') { alert("×—×©×‘ ×§×•×“×"); return; }
    
    let txt = ""; let i=1;
    document.querySelectorAll('.item-card').forEach(c => {
        const typeText = c.querySelector('.item-product').options[c.querySelector('.item-product').selectedIndex].text;
        const profile = c.querySelector('.item-profile').value;
        const price = parseFloat(c.querySelector('.item-price').value);
        const w = c.querySelector('.item-width').value;
        
        let dims = "";
        let area = 0;
        
        // ×©×œ×™×¤×ª × ×ª×•× ×™× ×œ×ª×¦×•×’×”
        if (c.querySelector('.item-product').value === 'pergola') {
            const d = c.querySelector('.item-depth').value;
            dims = `×—×–×™×ª: ${w}, ×¢×•××§: ${d}`;
            area = (w * d) / 10000;
        } else if (c.querySelector('.item-shape-type') && c.querySelector('.item-shape-type').value === 'special') {
            const h1 = c.querySelector('.item-h1').value;
            const h2 = c.querySelector('.item-h2').value;
            dims = `×¨×•×—×‘: ${w}, ×’×•×‘×” ×™××™×Ÿ: ${h1}, ×©×××œ: ${h2}`;
            area = (w * ((parseFloat(h1)+parseFloat(h2))/2)) / 10000;
        } else {
            const h = c.querySelector('.item-height').value;
            dims = `${w}x${h} ×¡"×`;
            area = (w * h) / 10000;
        }
        
        if (area < 1) area = 1;
        const totalItem = Math.round(area * price);
        
        // ×¦×‘×¢
        const colorSource = c.getAttribute('data-color-source') || 'ral';
        const color = colorSource === 'ral' ? c.querySelector('.ral-select').value : c.querySelector('.item-color-klil').value;

        txt += `ğŸ”¹ *×¤×¨×™×˜ ${i}: ${typeText}*\n   ×“×’×: ${profile}\n   ××™×“×•×ª: ${dims}\n   ×¦×‘×¢: ${color}\n   ×¡×”"×›: ${totalItem.toLocaleString()} â‚ª\n\n`;
        i++;
    });
    
    const client = document.getElementById('clientName').value;
    const finalPrice = document.getElementById('totalFinal').innerText;
    
    const msg = `*×”×¦×¢×ª ××—×™×¨ - ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×*\n×œ×§×•×—: ${client}\n----------------\n${txt}*×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"×): ${finalPrice}*`;
    document.getElementById('previewText').innerText = msg;
    finalLink = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    document.getElementById('previewModal').style.display = 'flex';
}
function closePreview() { document.getElementById('previewModal').style.display = 'none'; }
function sendWhatsapp() { window.open(finalLink, '_blank'); closePreview(); }

// --- ×× ×•×¢ ×©×¨×˜×•×˜ PRO MAX (×›×•×œ×œ ×¦×•×¨×•×ª ×•×¤×¨×’×•×œ×•×ª) ---
function generateSketch(btn) {
    const card = btn.closest('.item-card');
    const type = card.querySelector('.item-product').value;
    const w = parseFloat(card.querySelector('.item-width').value) || 100;
    
    // ×–×™×”×•×™ ××™×“×•×ª ×œ×¦×•×¨×š ×”×¦×™×•×¨
    let h = 100; // ×‘×¨×™×¨×ª ××—×“×œ
    let h1 = 0, h2 = 0;
    let isSpecial = false;
    let isPergola = false;
    let depth = 0;

    if (type === 'pergola') {
        isPergola = true;
        depth = parseFloat(card.querySelector('.item-depth').value) || 100;
        h = depth; // ×‘×¦×™×•×¨ ×¤×¨×’×•×œ×” ×”"×’×•×‘×”" ×”×•× ×”×¢×•××§
    } else if (type === 'window_fixed' && card.querySelector('.item-shape-type').value === 'special') {
        isSpecial = true;
        h1 = parseFloat(card.querySelector('.item-h1').value) || 100;
        h2 = parseFloat(card.querySelector('.item-h2').value) || 100;
        h = Math.max(h1, h2); // ×”×’×•×‘×” ×”××§×¡×™××œ×™ ×œ×—×™×©×•×‘ ×”×§× ×‘×¡
    } else {
        h = parseFloat(card.querySelector('.item-height').value) || 100;
    }

    // ×”×§××ª ×§× ×‘×¡
    const canvas = document.createElement('canvas');
    canvas.width = 1200; canvas.height = 900;
    const ctx = canvas.getContext('2d');
    
    // ×¨×§×¢
    ctx.fillStyle = "white"; ctx.fillRect(0,0,1200,900);
    
    // ×›×•×ª×¨×ª
    ctx.fillStyle = "#0d47a1"; ctx.font = "bold 40px Arial"; ctx.textAlign = "center";
    ctx.fillText("×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×", 600, 60);
    ctx.fillStyle = "#333"; ctx.font = "24px Arial";
    const client = document.getElementById('clientName').value || "×œ×§×•×—";
    ctx.fillText(`×œ×§×•×—: ${client} | ×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}`, 600, 100);

    // × ×ª×•× ×™× ×˜×›× ×™×™×
    const profile = card.querySelector('.item-profile').value;
    const colorSrc = card.getAttribute('data-color-source') || 'ral';
    const color = colorSrc === 'ral' ? card.querySelector('.ral-select').value : card.querySelector('.item-color-klil').value;
    ctx.font = "20px Arial"; ctx.fillStyle = "#555";
    ctx.fillText(`××•×¦×¨: ${profile} | ×’×•×•×Ÿ: ${color}`, 600, 140);

    // ×—×™×©×•×‘ ×™×—×¡ ×’×•×“×œ ×œ×¦×™×•×¨ (Scaling)
    const maxDrawW = 700; const maxDrawH = 500;
    const ratio = w / h;
    let dw, dh;
    if (ratio > 1) { dw = maxDrawW; dh = maxDrawW / ratio; if(dh > maxDrawH){ dh = maxDrawH; dw = dh * ratio; } }
    else { dh = maxDrawH; dw = maxDrawH * ratio; if(dw > maxDrawW){ dw = maxDrawW; dh = dw / ratio; } }
    
    const startX = (1200 - dw) / 2;
    const startY = 250;
    
    ctx.strokeStyle = "#333"; ctx.lineWidth = 4;

    // --- ×œ×•×’×™×§×ª ×¦×™×•×¨ --- //

    if (isSpecial) {
        // ×˜×¨×¤×– / ××©×•×œ×©
        // × ×¨××•×œ ×’×‘×”×™× ×™×—×¡×™×ª ×œ×’×•×‘×” ×”××§×¡×™××œ×™ ×©×œ ×”×¦×™×•×¨
        const maxRealH = Math.max(h1, h2);
        const scale = dh / maxRealH; // ×¤×§×˜×•×¨ ×”××¨×” ××¡"× ×œ×¤×™×§×¡×œ×™×
        const dh1 = h1 * scale;
        const dh2 = h2 * scale;

        ctx.beginPath();
        // ×¤×™× ×” ×©×××œ×™×ª ×ª×—×ª×•× ×”
        ctx.moveTo(startX, startY + dh);
        // ×¤×™× ×” ×™×× ×™×ª ×ª×—×ª×•× ×”
        ctx.lineTo(startX + dw, startY + dh);
        // ×¤×™× ×” ×™×× ×™×ª ×¢×œ×™×•× ×” (×œ×¤×™ ×’×•×‘×” h2)
        ctx.lineTo(startX + dw, startY + dh - dh2);
        // ×¤×™× ×” ×©×××œ×™×ª ×¢×œ×™×•× ×” (×œ×¤×™ ×’×•×‘×” h1)
        ctx.lineTo(startX, startY + dh - dh1);
        ctx.closePath();
        
        ctx.fillStyle = "#f0f8ff"; ctx.fill(); 
        ctx.stroke();

        // ××™×“×•×ª ×¢×œ ×”×¦×œ×¢×•×ª
        ctx.fillStyle = "#0000aa"; ctx.font = "bold 30px Arial";
        ctx.fillText(`${w}`, 600, startY + dh + 40); // ×¨×•×—×‘
        ctx.fillText(`${h2}`, startX + dw + 10, startY + dh - dh2/2); // ×’×•×‘×” ×™××™×Ÿ
        ctx.fillText(`${h1}`, startX - 50, startY + dh - dh1/2); // ×’×•×‘×” ×©×××œ

    } else if (isPergola) {
        // ×¤×¨×’×•×œ×” - ××‘×˜ ×¢×œ
        ctx.fillStyle = "#eee"; ctx.fillRect(startX, startY, dw, dh);
        ctx.strokeRect(startX, startY, dw, dh);
        
        // ×›×™×•×•×Ÿ ×¤×¡×™×
        const pDir = card.querySelector('.item-pergola-dir').value;
        ctx.lineWidth = 2; ctx.strokeStyle = "#999";
        
        if (pDir === 'parallel') {
            // ×œ×¨×•×—×‘
            for(let i=0; i<dh; i+=20) { ctx.beginPath(); ctx.moveTo(startX, startY+i); ctx.lineTo(startX+dw, startY+i); ctx.stroke(); }
        } else {
            // ×œ×¢×•××§
            for(let i=0; i<dw; i+=20) { ctx.beginPath(); ctx.moveTo(startX+i, startY); ctx.lineTo(startX+i, startY+dh); ctx.stroke(); }
        }

        // ××™×“×•×ª
        ctx.fillStyle = "#0000aa"; ctx.font = "bold 30px Arial";
        ctx.fillText(`×—×–×™×ª: ${w}`, 600, startY + dh + 40);
        ctx.fillText(`×¢×•××§: ${depth}`, startX + dw + 20, startY + dh/2);

    } else {
        // ××œ×‘×Ÿ ×¨×’×™×œ (×—×œ×•× ×•×ª/×“×œ×ª×•×ª)
        ctx.strokeRect(startX, startY, dw, dh);
        // ××¡×’×¨×ª ×¤× ×™××™×ª
        ctx.lineWidth = 2;
        ctx.strokeRect(startX+10, startY+10, dw-20, dh-20);
        
        // ×–×›×•×›×™×ª (×§×•×•×™× ××œ×›×¡×•× ×™×™×)
        if (!type.includes('shutter') && !type.includes('screen')) {
            ctx.strokeStyle = "#e0e0e0"; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(startX+20, startY+dh-20); ctx.lineTo(startX+dh-20, startY+20); ctx.stroke();
        }

        // ×œ×•×’×™×§×ª ×¤×ª×™×—×”
        const direction = card.querySelector('.item-direction') ? card.querySelector('.item-direction').value : "";
        if (direction) {
            ctx.setLineDash([15, 10]); ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.beginPath();
            if (direction === '×™××™×Ÿ') {
                ctx.moveTo(startX+dw, startY); ctx.lineTo(startX, startY+dh/2); ctx.lineTo(startX+dw, startY+dh);
            } else {
                ctx.moveTo(startX, startY); ctx.lineTo(startX+dw, startY+dh/2); ctx.lineTo(startX, startY+dh);
            }
            ctx.stroke(); ctx.setLineDash([]);
        }

        // ××™×“×•×ª
        ctx.fillStyle = "#0000aa"; ctx.font = "bold 30px Arial";
        ctx.fillText(`${w}`, 600, startY + dh + 40);
        
        ctx.save();
        ctx.translate(startX + dw + 40, startY + dh/2);
        ctx.rotate(-Math.PI/2);
        ctx.fillText(`${h}`, 0, 0);
        ctx.restore();
    }

    // ×”×•×¨×“×”
    const link = document.createElement('a');
    link.download = `Sketch_${client}_${Math.floor(Math.random()*1000)}.png`;
    link.href = canvas.toDataURL();
    link.click();
}
</script>
</body>
</html>
