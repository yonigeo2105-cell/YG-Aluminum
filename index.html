<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×™×”×•× ×ª×Ÿ PRO">
    <title>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0d47a1; --primary-light: #42a5f5; --bg: #f0f4f8; --card: #ffffff; --text-dark: #1a202c; --whatsapp: #25D366; --border: #cbd5e0; --input-bg: #f7fafc; --danger: #e53e3e; }
        body { font-family: 'Rubik', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text-dark); -webkit-tap-highlight-color: transparent; height: 100vh; overflow-x: hidden; }
        
        /* ××¡×š ×›× ×™×¡×” - ×©×•×—×–×¨ ×‘×“×™×•×§ */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0d47a1 0%, #002171 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .login-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box h2 { color: var(--primary); margin-top: 0; }
        .login-box input { width: 90%; margin-bottom: 15px; text-align: center; font-size: 20px; letter-spacing: 2px; }
        .btn-login { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }

        /* ××¤×œ×™×§×¦×™×” ×¨××©×™×ª */
        header { background: linear-gradient(135deg, var(--primary) 0%, #1976d2 100%); color: white; padding: 30px 20px 40px; text-align: center; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; box-shadow: 0 10px 25px rgba(13,71,161,0.25); position: relative; z-index: 10; }
        header h1 { margin: 0; font-size: 26px; font-weight: 800; }
        
        .container { padding: 0 20px; max-width: 650px; margin: -30px auto 0; padding-bottom: 140px; position: relative; z-index: 20; display: none; }
        
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid white; }
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--primary); }
        .btn-delete { background: #fff5f5; color: var(--danger); border: 1px solid #fed7d7; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background-color: var(--input-bg); margin-bottom: 15px; font-family: 'Rubik', sans-serif; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--primary-light); outline: none; box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.15); background: #fff; }
        
        .row { display: flex; gap: 12px; } .row > div { flex: 1; }
        
        .btn-add-item { width: 100%; background: white; color: var(--primary); border: 2px dashed var(--primary-light); padding: 15px; border-radius: 15px; font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
        
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px 25px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); z-index: 100; border-radius: 20px 20px 0 0; display: none; gap: 10px; }
        .btn-calc { flex: 1; background: linear-gradient(90deg, var(--primary) 0%, #1565c0 100%); color: white; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; box-shadow: 0 4px 15px rgba(13, 71, 161, 0.3); cursor: pointer; }
        
        .result-box { background: white; border-radius: 20px; border: 2px solid var(--primary-light); margin-top: 25px; display: none; overflow: hidden; margin-bottom: 20px; }
        .result-header { background: var(--primary-light); color: white; padding: 15px; text-align: center; font-weight: 700; }
        .result-body { padding: 20px; }
        .price-line { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .total-line { font-size: 24px; font-weight: 800; color: var(--primary); border-top: 2px dashed #cbd5e0; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-between; }
        
        .modal-overlay { position: fixed; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 90vh; display: flex; flex-direction: column; overflow-y: auto; }
        
        .btn-download-sketch { background-color: #2d3748; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; border: none; cursor: pointer; margin-top: 10px; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 100%; justify-content: center; }

        /* ××œ×× ×˜×™× ×—×“×©×™× (××¢×•×¦×‘×™× ×‘×©×¤×” ×©×œ ×”××§×•×¨×™) */
        .extra-panel { background: #f1f5f9; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .legal-footer { margin-top: 30px; font-size: 11px; color: #718096; text-align: center; border-top: 1px solid #cbd5e0; padding-top: 15px; line-height: 1.6; }
        
        /* ×‘×—×™×¨×ª ××’×¨×¢×ª */
        .notch-grid { display: flex; gap: 10px; margin-bottom: 10px; }
        .notch-btn { flex: 1; padding: 10px; border: 1px solid var(--border); background: white; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; }
        .notch-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* ×œ×”×¡×ª×¨×ª ×›×¤×ª×•×¨×™× ×‘-PDF */
        .no-print { } 
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
        <h2>×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
        <p>× × ×œ×”×§×™×© ×¡×™×¡××”</p>
        <input type="password" id="passwordInput" placeholder="****" inputmode="numeric">
        <button class="btn-login" onclick="checkLogin()">×”×™×›× ×¡</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">×¡×™×¡××” ×©×’×•×™×”</p>
    </div>
</div>

<div id="pdfContent"> <header><h1>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</h1><p>××¢×¨×›×ª ×”×¦×¢×•×ª ××—×™×¨ ××§×¦×•×¢×™×ª</p></header>

    <div class="container" id="mainApp">
        <div class="card">
            <div class="card-title">ğŸ‘¤ ×¤×¨×˜×™ ×œ×§×•×—</div>
            <div class="row">
                <div style="flex:2"><label>×©× ×”×œ×§×•×—:</label><input type="text" id="clientName" placeholder="×©× ××œ×"></div>
                <div style="flex:1"><label>×ª××¨×™×š:</label><input type="date" id="quoteDate"></div>
            </div>
        </div>
        
        <div id="itemsContainer"></div>
        
        <button class="btn-add-item no-print" data-html2canvas-ignore="true" onclick="addItem()">â• ×”×•×¡×£ ××•×¦×¨ ×—×“×©</button>
        
        <div class="card" style="background:#ebf8ff; border:1px solid #bee3f8;">
            <div class="card-title">ğŸ› ï¸ ×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”</div>
            <label>×¢×œ×•×ª ×”×•×‘×œ×”, ×”×ª×§× ×” ×•×¤×™×¨×•×§ (â‚ª):</label>
            <input type="number" id="installationCost" placeholder="0">
        </div>
        
        <div class="result-box" id="resultBox">
            <div class="result-header">×¡×™×›×•× ×”×–×× ×”</div>
            <div class="result-body">
                <div class="price-line"><span>×¡×”"×› ××•×¦×¨×™×:</span><span id="itemsSubtotal">0 â‚ª</span></div>
                <div class="price-line"><span>×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”:</span><span id="installSubtotal">0 â‚ª</span></div>
                <div class="price-line" style="border-top:1px solid #eee; padding-top:10px;"><span>×¡×”"×› ×œ×¤× ×™ ××¢"×:</span><span id="totalSub">0 â‚ª</span></div>
                <div class="price-line"><span>××¢"× (18%):</span><span id="totalVat">0 â‚ª</span></div>
                <div class="total-line"><span>×¡×”"×› ×œ×ª×©×œ×•×:</span><span id="totalFinal">0 â‚ª</span></div>
                
                <div class="legal-footer">
                    * ×”××—×™×¨ ×›×•×œ×œ ×”×•×‘×œ×”.<br>
                    * ×”×¦×¢×ª ××—×™×¨ ×–××ª ××©××©×ª ×›×—×•×–×”.<br>
                    * ×”×¡×—×•×¨×” ×‘×‘×¢×œ×•×ª ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× ×¢×“ ×”×ª×©×œ×•× ×”××œ×.<br>
                    * ×”×¦×¢×ª ××—×™×¨ ×ª×§×¤×” ×œ-5 ×™××™ ×¢×¡×§×™× ×•×™×ª×›× ×• ×©×™× ×•×™×™× ×§×œ×™× ×‘×™×•× ×—×ª×™××ª ×”×—×•×–×”.<br>
                    <strong>×‘×›×‘×•×“ ×¨×‘, ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</strong>
                </div>

                <button class="btn-add-item no-print" style="margin-top:20px; background:var(--whatsapp); color:white; border:none;" data-html2canvas-ignore="true" onclick="openPreview()">×©×œ×— ×”×¦×¢×” ×‘×•×•××˜×¡××¤</button>
            </div>
        </div>
    </div>
</div>

<div class="bottom-actions" id="bottomNav">
    <button class="btn-calc" onclick="calculateAll()">×—×©×‘ ×¡×”"×› ×œ×ª×©×œ×•×</button>
    <button class="btn-calc" style="background: #e53e3e; margin-right:10px;" onclick="generatePDF()">ğŸ“„ ×”×•×¨×“ PDF</button>
</div>

<div class="modal-overlay" id="previewModal">
    <div class="modal-content">
        <h3 style="text-align:center;margin:0 0 15px 0;color:var(--primary)">×˜×™×•×˜×ª ×”×•×“×¢×”</h3>
        <textarea id="previewText" style="width:100%; height:150px; font-family:sans-serif; border:1px solid #ccc; padding:10px; border-radius:10px;"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-login" style="background:#ccc; color:black" onclick="document.getElementById('previewModal').style.display='none'">×¡×’×•×¨</button>
            <button class="btn-login" style="background:var(--whatsapp)" onclick="sendWhatsapp()">×©×œ×—</button>
        </div>
    </div>
</div>

<script>
    // --- × ×ª×•× ×™× ---
    const profilesDB = {
        "sliding": ["×§×œ×™×œ 7000 ×§×œ××¡×™", "×§×œ×™×œ 9000", "×§×œ×™×œ 9200", "×§×œ×™×œ 1700 ×‘×œ×’×™", "×§×œ×™×œ 2200 ××•×¤×™×¡"],
        "pocket": ["×›×™×¡ ×‘×•×“×“ (2 × ×ª×™×‘×™×)", "×›×™×¡ ×‘×•×“×“ (3 × ×ª×™×‘×™×)", "×›×™×¡ ×›×¤×•×œ (2 × ×ª×™×‘×™×)", "×›×™×¡ ×›×¤×•×œ (3 × ×ª×™×‘×™×)"],
        "hinge": ["×§×œ×™×œ 4500 ×§×œ××¡×™", "×§×œ×™×œ 4300 ×‘×œ×’×™", "×§×œ×™×œ 5500 ×‘××•×”××•×¡", "×“×¨×™×™-×§×™×¤"],
        "fixed": ["×§×œ×™×œ 4300 ×‘×œ×’×™ FIX", "×§×œ×™×œ 4500 ×§×œ××¡×™ FIX", "×§×œ×™×œ 2000 ×‘×™×™×¡×™×§ FIX", "×§×œ×™×œ 5500 ××•×¤×™×¡ FIX", "××ª×× 7000/9000"],
        "door": ["×“×œ×ª 2000 ×¤× ×œ", "×“×œ×ª ×œ×•×‘×™ ×–×›×•×›×™×ª", "×“×œ×ª ×¦×™×¨ ×‘×œ×’×™ 4300", "×“×œ×ª ××™× ×˜×¨×§×•×"],
        "shutter": ["×©×œ×‘ 8 (×¨×’×™×œ)", "×©×œ×‘ ××•×¨ (××™× ×™)", "×©×œ×‘ ××•×§×¦×£"],
        "screen_roll": ["×¨×©×ª ×’×œ×™×œ×” (×× ×›×™×ª)", "×¨×©×ª ×”×–×–×”", "×¨×©×ª ×§×‘×•×¢×”"],
        "pergola": ["×¤×¨×’×•×œ×” ×ª×œ×•×™×”", "×¤×¨×’×•×œ×” ×¢×•××“×ª", "×’×“×¨ ××œ×•××™× ×™×•×"],
        "shower": ["××§×œ×—×•×Ÿ ×—×–×™×ª", "××§×œ×—×•×Ÿ ×¤×™× ×ª×™"],
        "joker": ["×¢×‘×•×“×” ×›×œ×œ×™×ª / ×©×•× ×•×ª"]
    };

    let itemCount = 0;
    document.getElementById('quoteDate').valueAsDate = new Date();

    function checkLogin() {
        if(document.getElementById('passwordInput').value === '1234') {
            document.getElementById('loginScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                document.getElementById('bottomNav').style.display = 'flex';
            }, 500);
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function addItem() {
        itemCount++;
        const container = document.getElementById('itemsContainer');
        const div = document.createElement('div');
        div.className = 'card fade-in item-card';
        div.id = `item-${itemCount}`;
        
        div.innerHTML = `
            <div class="card-header-row">
                <div class="card-title">××•×¦×¨ #${itemCount}</div>
                <button class="btn-delete" onclick="this.closest('.card').remove()">××—×§</button>
            </div>

            <label>×‘×—×¨ ×¡×•×’ ××•×¦×¨:</label>
            <select class="item-type" onchange="updateItemFields(this)">
                <option value="sliding">×—×œ×•×Ÿ ×”×–×–×”</option>
                <option value="pocket">×—×œ×•×Ÿ ×›×™×¡ (Pocket)</option>
                <option value="hinge">×—×œ×•×Ÿ ×¦×™×¨ / ×“×¨×™×™ ×§×™×¤</option>
                <option value="fixed">×§×‘×•×¢ / ×•×™×˜×¨×™× ×”</option>
                <option value="door">×“×œ×ª×•×ª ×›× ×™×¡×” / ×œ×•×‘×™</option>
                <option value="shutter">×ª×¨×™×¡×™×</option>
                <option value="pergola">×¤×¨×’×•×œ×•×ª ×•×’×“×¨×•×ª</option>
                <option value="screen_roll">×¨×©×ª×•×ª</option>
                <option value="shower">××§×œ×—×•× ×™×</option>
                <option value="joker">×›×œ×œ×™ / ×’'×•×§×¨</option>
            </select>

            <div class="dynamic-content"></div>

            <div class="standard-inputs">
                <label>×“×’× ×¤×¨×•×¤×™×œ:</label><select class="profile-select"><option>×‘×—×¨ ××•×¦×¨ ×§×•×“×</option></select>
                
                <div class="row" style="margin-top:10px">
                    <div><label>×¨×•×—×‘ (×¡"×)</label><input type="number" class="w-input" placeholder="100"></div>
                    <div><label>×’×•×‘×” (×¡"×)</label><input type="number" class="h-input" placeholder="100"></div>
                </div>
                <div class="row">
                    <div><label>×›××•×ª</label><input type="number" class="qty-input" value="1"></div>
                    <div><label style="color:var(--primary)">××—×™×¨ ×™×—' (â‚ª)</label><input type="number" class="price-input" placeholder="××—×™×¨ ×¤×™×§×¡"></div>
                </div>
                
                <button class="btn-download-sketch" onclick="generateSketch(this)">ğŸ“¸ ×¦×•×¨ ×©×¨×˜×•×˜ ××•×˜×•××˜×™</button>
                <div class="sketch-preview" style="margin-top:10px; max-width:100%; display:none;"></div>
            </div>
        `;
        container.appendChild(div);
        updateItemFields(div.querySelector('.item-type'));
    }

    function updateItemFields(select) {
        const card = select.closest('.card');
        const type = select.value;
        const container = card.querySelector('.dynamic-content');
        const stdInputs = card.querySelector('.standard-inputs');
        const profSelect = card.querySelector('.profile-select');

        // ×œ×•×’×™×§×ª ×’'×•×§×¨
        if(type === 'joker') {
            stdInputs.style.display = 'none';
            container.innerHTML = `
                <div class="extra-panel">
                    <label>×ª×™××•×¨ ×”×¢×‘×•×“×”:</label>
                    <input type="text" class="joker-title" placeholder="×›×•×ª×¨×ª (×œ××©×œ: ×”×’×‘×”×ª ××¢×§×”)">
                    <textarea class="joker-desc" rows="3" placeholder="×¤×™×¨×•×˜ ××œ×..."></textarea>
                    <label>×ª××•× ×” ××”×©×˜×—:</label>
                    <input type="file" accept="image/*" onchange="previewImage(this)">
                    <img class="img-display" style="width:100%; border-radius:10px; margin-top:10px; display:none;">
                    <div class="row" style="margin-top:15px">
                        <div><label>×›××•×ª</label><input type="number" class="qty-input" value="1"></div>
                        <div><label style="color:var(--primary)">××—×™×¨ ×’×œ×•×‘×œ×™ (â‚ª)</label><input type="number" class="price-input"></div>
                    </div>
                </div>
            `;
            return;
        }

        stdInputs.style.display = 'block';
        
        // ×¢×“×›×•×Ÿ ×¤×¨×•×¤×™×œ×™×
        profSelect.innerHTML = "";
        (profilesDB[type] || []).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.innerText = p;
            profSelect.appendChild(opt);
        });

        // ×ª×•×¡×¤×•×ª ×¡×¤×¦×™×¤×™×•×ª
        let html = '';
        if(type === 'sliding') {
            html = `<div class="extra-panel">
                <div class="row">
                    <div><label>××¡' ×›× ×¤×™×™×</label><input type="number" class="sl-sashes" value="2"></div>
                    <div><label>×¡×•×’ ××¤×’×©</label><input type="text" class="sl-meeting" placeholder="×œ××©×œ: ×›× ×£ ×¢×œ ×›× ×£"></div>
                </div>
                <label>×—×œ×•×§×” ("×‘×œ×’×™"):</label><select class="sl-div"><option value="none">×œ×œ×</option><option value="strips">×¤×¡×™×</option><option value="grid">×§×•×‘×™×•×ª</option></select>
            </div>`;
        }
        else if(type === 'pocket') {
            html = `<div class="extra-panel">
                <label>×”×¨×›×‘ ×›× ×£:</label><select class="pkt-comp"><option>×–×›×•×›×™×ª ×‘×œ×‘×“</option><option>×–×›×•×›×™×ª + ×ª×¨×™×¡</option><option>×–×›×•×›×™×ª + ×ª×¨×™×¡ + ×¨×©×ª</option></select>
            </div>`;
        }
        else if(type === 'fixed') {
            html = `<div class="extra-panel">
                <label>×”×× ×™×© ×—×™×ª×•×š/××’×¨×¢×ª?</label>
                <div class="notch-grid">
                    <div class="notch-btn" onclick="selectNotch(this, 'TL')">âŒœ</div>
                    <div class="notch-btn" onclick="selectNotch(this, 'TR')">âŒ</div>
                    <div class="notch-btn" onclick="selectNotch(this, 'BL')">âŒ</div>
                    <div class="notch-btn" onclick="selectNotch(this, 'BR')">âŒŸ</div>
                </div>
                <input type="hidden" class="notch-pos">
                <div class="row notch-dims" style="display:none">
                    <input type="number" class="notch-w" placeholder="×¨×•×—×‘ ×—×™×ª×•×š">
                    <input type="number" class="notch-h" placeholder="×’×•×‘×” ×—×™×ª×•×š">
                </div>
            </div>`;
        }
        else if(type === 'door') {
            html = `<div class="extra-panel">
                <label>×ª×•×¡×¤×•×ª ×§×‘×•×¢×™×:</label>
                <div class="row">
                    <input type="number" class="dr-top" placeholder="×’×•×‘×” ×§×‘×•×¢ ×¢×œ×™×•×Ÿ">
                    <input type="number" class="dr-side" placeholder="×¨×•×—×‘ ×§×‘×•×¢ ×¦×“">
                </div>
                <label style="margin-top:10px">××—×–×™×¨ ×©××Ÿ:</label><select class="dr-closer"><option value="none">×œ×œ×</option><option value="top">×—×™×¦×•× ×™</option><option value="floor">×¨×¦×¤×ª×™</option></select>
            </div>`;
        }
        else if(type === 'shutter') {
            html = `<div class="extra-panel">
                <div class="row">
                    <div><label>××¨×’×–</label><select class="sht-box"><option>×¤× ×™××™/× ×¡×ª×¨</option><option>×—×™×¦×•× ×™</option></select></div>
                    <div><label>×× ×•×¢</label><select class="sht-motor"><option>×™×“× ×™</option><option>×—×©××œ×™</option><option>×¡×•××¤×™</option></select></div>
                </div>
                <input type="number" class="sht-nm" placeholder="×›×•×— ×× ×•×¢ (Nm)" style="margin-top:10px">
            </div>`;
        }
        else if(type === 'pergola') {
            html = `<div class="extra-panel">
                <div class="row">
                    <div><label>×§×™×¨×•×™</label><select class="prg-roof"><option>×œ×œ×</option><option>×¡× ×˜×£ ×¨×’×™×œ</option><option>×¡× ×˜×£ BH</option></select></div>
                    <div style="display:flex; align-items:center; margin-top:20px"><input type="checkbox" class="prg-gutter" style="width:20px; height:20px"> <span style="margin-right:10px">×›×•×œ×œ ××¨×–×‘</span></div>
                </div>
            </div>`;
        }
        
        container.innerHTML = html;
    }

    // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
    function selectNotch(btn, pos) {
        const panel = btn.closest('.extra-panel');
        panel.querySelectorAll('.notch-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        panel.querySelector('.notch-pos').value = pos;
        panel.querySelector('.notch-dims').style.display = 'flex';
    }

    function previewImage(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = input.closest('.extra-panel').querySelector('.img-display');
                img.src = e.target.result;
                img.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // ×—×™×©×•×‘
    function calculateAll() {
        let itemsSum = 0;
        document.querySelectorAll('.item-card').forEach(card => {
            const q = parseFloat(card.querySelector('.qty-input').value) || 1;
            const p = parseFloat(card.querySelector('.price-input').value) || 0;
            itemsSum += (q * p);
        });
        
        const install = parseFloat(document.getElementById('installationCost').value) || 0;
        const totalSub = itemsSum + install;
        const vat = totalSub * 0.18; // ××¢"× 18%
        const final = totalSub + vat;

        document.getElementById('itemsSubtotal').innerText = itemsSum.toLocaleString() + " â‚ª";
        document.getElementById('installSubtotal').innerText = install.toLocaleString() + " â‚ª";
        document.getElementById('totalSub').innerText = totalSub.toLocaleString() + " â‚ª";
        document.getElementById('totalVat').innerText = vat.toLocaleString() + " â‚ª";
        document.getElementById('totalFinal').innerText = final.toLocaleString() + " â‚ª";

        document.getElementById('resultBox').style.display = 'block';
        setTimeout(() => document.getElementById('bottomNav').scrollIntoView({behavior:'smooth'}), 200);
    }

    // PDF
    function generatePDF() {
        const element = document.getElementById('pdfContent');
        document.getElementById('resultBox').style.display = 'block';
        
        const opt = {
            margin: 0.1,
            filename: `×”×¦×¢×ª_××—×™×¨_${document.getElementById('clientName').value}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
    }

    // ×©×¨×˜×•×˜ ×—×›×
    function generateSketch(btn) {
        const card = btn.closest('.card');
        const container = card.querySelector('.sketch-preview');
        const type = card.querySelector('.item-type').value;
        const w = parseFloat(card.querySelector('.w-input').value) || 100;
        const h = parseFloat(card.querySelector('.h-input').value) || 100;
        
        const canvas = document.createElement('canvas');
        canvas.width = 600; canvas.height = 400;
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = "white"; ctx.fillRect(0,0,600,400);
        ctx.lineWidth = 3; ctx.strokeStyle = "#333";
        const startX = 50; const startY = 50; const maxW = 500; const maxH = 300;

        // ×¦×™×•×¨
        if(type === 'fixed' && card.querySelector('.notch-pos')?.value) {
            const pos = card.querySelector('.notch-pos').value;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            if(pos === 'TR') { ctx.lineTo(startX+maxW-50, startY); ctx.lineTo(startX+maxW-50, startY+50); ctx.lineTo(startX+maxW, startY+50); } else ctx.lineTo(startX+maxW, startY);
            ctx.lineTo(startX+maxW, startY+maxH); ctx.lineTo(startX, startY+maxH); ctx.closePath(); ctx.stroke();
            ctx.fillStyle="red"; ctx.fillText("×—×™×ª×•×š", startX+maxW-40, startY+20);
        }
        else if(type === 'pocket') {
            ctx.setLineDash([5,5]); ctx.strokeRect(startX+maxW, startY, 80, maxH); ctx.setLineDash([]);
            ctx.strokeRect(startX, startY, maxW, maxH);
            ctx.beginPath(); ctx.moveTo(startX, startY+maxH-10); ctx.lineTo(startX+maxW+80, startY+maxH-10); ctx.stroke();
            ctx.fillStyle="black"; ctx.fillText("×›×™×¡", startX+maxW+10, startY+maxH/2);
        }
        else if(type === 'door') {
             let curY = startY; let doorH = maxH;
             if(card.querySelector('.dr-top')?.value > 0) {
                 ctx.strokeRect(startX, startY, maxW, 50); ctx.fillText("×§×‘×•×¢ ×¢×œ×™×•×Ÿ", startX+maxW/2-30, startY+30);
                 curY += 50; doorH -= 50;
             }
             ctx.strokeRect(startX, curY, maxW, doorH);
             if(card.querySelector('.dr-closer').value !== 'none') {
                 ctx.beginPath(); ctx.moveTo(startX+maxW-10, curY); ctx.lineTo(startX+maxW-40, curY); ctx.lineTo(startX+maxW-10, curY+30); ctx.fill();
             }
        }
        else {
            ctx.strokeRect(startX, startY, maxW, maxH);
            ctx.fillText(`${w} X ${h}`, startX+maxW/2-30, startY+maxH+30);
        }

        const img = new Image();
        img.src = canvas.toDataURL();
        img.style.maxWidth = "100%";
        img.style.border = "1px solid #ccc";
        container.innerHTML = '';
        container.appendChild(img);
        container.style.display = 'block';
    }

    // ×•×•××˜×¡××¤
    function openPreview() {
        let txt = `*×”×¦×¢×ª ××—×™×¨ - ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×*\n×œ×§×•×—: ${document.getElementById('clientName').value}\n\n`;
        document.querySelectorAll('.item-card').forEach(c => {
            const type = c.querySelector('.item-type');
            const typeName = type.options[type.selectedIndex].text;
            
            if(type.value === 'joker') {
                txt += `ğŸ”¹ *${c.querySelector('.joker-title').value}*\n${c.querySelector('.joker-desc').value}\n`;
            } else {
                const prof = c.querySelector('.profile-select').value;
                const w = c.querySelector('.w-input').value;
                const h = c.querySelector('.h-input').value;
                txt += `ğŸ”¹ *${typeName}* (${prof})\n××™×“×•×ª: ${w}x${h}\n`;
            }
            const q = c.querySelector('.qty-input').value;
            const p = c.querySelector('.price-input').value;
            txt += `×›××•×ª: ${q} | ××—×™×¨: ${p} â‚ª\n\n`;
        });
        
        const install = document.getElementById('installationCost').value;
        if(install > 0) txt += `×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”: ${install} â‚ª\n`;
        txt += `*×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"×): ${document.getElementById('totalFinal').innerText}*`;
        
        document.getElementById('previewText').value = txt;
        document.getElementById('previewModal').style.display = 'flex';
    }

    function sendWhatsapp() {
        window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('previewText').value)}`);
    }
</script>
</body>
</html>
