<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× PRO</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0d47a1; --primary-light: #42a5f5; --bg: #f0f4f8; --card: #ffffff; --text-dark: #1a202c; --whatsapp: #25D366; --border: #cbd5e0; --input-bg: #f7fafc; --danger: #e53e3e; }
        body { font-family: 'Rubik', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text-dark); -webkit-tap-highlight-color: transparent; height: 100vh; overflow-x: hidden; }
        
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0d47a1 0%, #002171 100%); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .login-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box h2 { color: var(--primary); margin-top: 0; margin-bottom: 10px; }
        .btn-login { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .login-box input { width: 90%; margin-bottom: 10px; text-align: center; font-size: 20px; letter-spacing: 2px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }

        header { background: linear-gradient(135deg, var(--primary) 0%, #1976d2 100%); color: white; padding: 30px 20px 30px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100; }
        header h1 { margin: 0; font-size: 28px; font-weight: 800; }
        
        .container { padding: 20px; max-width: 650px; margin: 0 auto; padding-bottom: 140px; }
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid white; }
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--primary); }
        .btn-delete { background: #fff5f5; color: var(--danger); border: 1px solid #fed7d7; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background-color: var(--input-bg); margin-bottom: 15px; font-family: 'Rubik', sans-serif; box-sizing: border-box; }
        
        .row { display: flex; gap: 12px; } .row > div { flex: 1; }
        .btn-add-item { width: 100%; background: white; color: var(--primary); border: 2px dashed var(--primary-light); padding: 15px; border-radius: 15px; font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
        
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px 25px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); z-index: 100; border-radius: 20px 20px 0 0; display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; text-align: center; }
        .btn-calc { background: linear-gradient(90deg, var(--primary) 0%, #1565c0 100%); color: white; }
        .btn-pdf { background: #e53e3e; color: white; }

        .result-box { background: white; border-radius: 20px; border: 2px solid var(--primary-light); margin-top: 25px; display: none; overflow: hidden; margin-bottom: 20px; }
        .result-header { background: var(--primary-light); color: white; padding: 15px; text-align: center; font-weight: 700; }
        .result-body { padding: 20px; }
        .price-line { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .total-line { font-size: 24px; font-weight: 800; color: var(--primary); border-top: 2px dashed #cbd5e0; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-between; }

        .color-tabs { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; border-radius: 9px; cursor: pointer; color: #718096; transition: all 0.2s; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .extra-panel { background: #f8fafc; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e2e8f0; display: none; }
        .btn-download-sketch { background-color: #2d3748; color: white; padding: 12px; border-radius: 8px; font-size: 15px; border: none; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .modal-overlay { position: fixed; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 90vh; display: flex; flex-direction: column; overflow-y: auto; }
        canvas#drawingPad { border: 2px dashed #cbd5e0; border-radius: 10px; touch-action: none; background: white; cursor: crosshair; width: 100%; height: 300px; }

        .pdf-preview-content { background: white; width: 100%; max-width: 800px; padding: 0; border-radius: 0; height: 100%; overflow-y: auto; }
        .pdf-paper { background: white; padding: 30px; font-family: 'Arial', sans-serif; direction: rtl; min-height: 800px; }
        .pdf-paper table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 20px; }
        .pdf-paper th { background-color: #0d47a1; color: white; padding: 12px; text-align: right; border: 1px solid #ddd; font-size: 14px; }
        .pdf-paper td { padding: 12px; border: 1px solid #ddd; vertical-align: middle; font-size: 14px; }
        .pdf-paper tr:nth-child(even) { background-color: #f9f9f9; }
        .invoice-header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #0d47a1; padding-bottom: 20px; }
        .summary-box { float: left; width: 350px; margin-top: 30px; background: #f8f9fa; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 15px; }
        .summary-row.total { font-weight: bold; font-size: 18px; border-top: 2px solid #0d47a1; border-bottom: none; margin-top: 10px; padding-top: 10px; color: #0d47a1; }
        
        /* ×¢×™×¦×•×‘ ×¡×¤×¦×™×¤×™ ×œ××§×œ×—×•× ×™× */
        .shower-options { background: #fff; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .checkbox-row { display: flex; align-items: center; margin-bottom: 8px; }
        .checkbox-row input { width: 20px; height: 20px; margin: 0 0 0 10px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
        <h2>×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
        <p>× × ×œ×”×§×™×© ×¡×™×¡××”</p>
        <input type="password" id="passwordInput" placeholder="****" inputmode="numeric">
        <button class="btn-login" onclick="checkLogin()">×”×™×›× ×¡</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">×¡×™×¡××” ×©×’×•×™×”</p>
    </div>
</div>

<header>
    <h1>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</h1>
    <p style="margin:5px 0 0; opacity:0.9;">××¢×¨×›×ª ×”×¦×¢×•×ª ××—×™×¨</p>
</header>

<div class="container" id="mainApp" style="display:none">
    <div class="card">
        <div class="card-title">ğŸ‘¤ ×¤×¨×˜×™ ×œ×§×•×—</div>
        <label>×©× ×”×œ×§×•×—:</label>
        <input type="text" id="clientName" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
        <div class="row">
            <div style="flex:1"><label>×ª××¨×™×š:</label><input type="date" id="quoteDate"></div>
            <div style="flex:1"><label>××¡' ×”×¦×¢×”:</label><input type="number" id="quoteNumber" style="font-weight:700;text-align:center"></div>
        </div>
    </div>
    
    <div id="itemsContainer"></div>
    
    <button class="btn-add-item" onclick="addItem()">â• ×”×•×¡×£ ××•×¦×¨ ×—×“×©</button>
    
    <div class="card" style="background:#ebf8ff; border:1px solid #bee3f8;">
        <div class="card-title">ğŸ› ï¸ ×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”</div>
        <label>×¢×œ×•×ª ×”×•×‘×œ×”, ×”×ª×§× ×” ×•×¤×™×¨×•×§ (â‚ª):</label>
        <input type="number" id="installationCost" placeholder="0">
    </div>
    
    <div class="result-box" id="resultBox">
        <div class="result-header">×¡×™×›×•× ×”×–×× ×”</div>
        <div class="result-body">
            <div class="price-line"><span>×¡×”"×› ××•×¦×¨×™×:</span><span id="itemsSubtotal">0 â‚ª</span></div>
            <div class="price-line"><span>×ª×•×¡×¤×•×ª ×•×”×ª×§× ×”:</span><span id="installSubtotal">0 â‚ª</span></div>
            <div class="price-line" style="border-top:1px solid #eee; padding-top:10px;"><span>×¡×”"×› ×œ×¤× ×™ ××¢"×:</span><span id="totalSub">0 â‚ª</span></div>
            <div class="price-line"><span>××¢"× (18%):</span><span id="totalVat">0 â‚ª</span></div>
            <div class="total-line"><span>×¡×”"×› ×œ×ª×©×œ×•×:</span><span id="totalFinal">0 â‚ª</span></div>
            
            <button class="btn-add-item" style="margin-top:20px; background:var(--whatsapp); color:white; border:none;" onclick="openPreview()">×©×œ×— ×”×¦×¢×” ×‘×•×•××˜×¡××¤</button>
        </div>
    </div>
</div>

<div class="bottom-actions" id="bottomNav" style="display:none">
    <button class="btn-action btn-calc" onclick="calculateAll()">×—×©×‘ ×¡×”"×› ×œ×ª×©×œ×•×</button>
    <button class="btn-action btn-pdf" onclick="showPdfPreview()">ğŸ“„ ×”×¦×’ ×•×”×•×¨×“ PDF</button>
</div>

<div class="modal-overlay" id="previewModal">
    <div class="modal-content">
        <h3 style="text-align:center;margin:0 0 15px 0;color:var(--primary)">×˜×™×•×˜×ª ×”×•×“×¢×”</h3>
        <textarea id="previewText" style="width:100%; height:150px; font-family:sans-serif; border:1px solid #ccc; padding:10px; border-radius:10px;"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-login" style="background:#ccc; color:black" onclick="document.getElementById('previewModal').style.display='none'">×¡×’×•×¨</button>
            <button class="btn-login" style="background:var(--whatsapp)" onclick="sendWhatsapp()">×©×œ×—</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="pdfPreviewModal" style="background: white;">
    <div class="pdf-preview-content">
        <div style="background: #eee; padding: 10px; display: flex; gap: 10px; position:sticky; top:0; border-bottom:1px solid #ccc; z-index:10;">
            <button class="btn-login" style="background:#e53e3e; margin:0; flex:1" onclick="document.getElementById('pdfPreviewModal').style.display='none'">×¡×’×•×¨</button>
            <button class="btn-login" style="background:var(--primary); margin:0; flex:2" onclick="downloadActualPdf()">â¬‡ï¸ ×”×•×¨×“ ×§×•×‘×¥ PDF</button>
        </div>
        <div id="pdfPaperContent" class="pdf-paper"></div>
    </div>
</div>

<div class="modal-overlay" id="drawingModal">
    <div class="modal-content" style="max-width:500px">
        <h3 style="text-align:center;margin:0 0 10px 0;">×œ×•×— ×©×¨×˜×•×˜ ×™×“× ×™</h3>
        <canvas id="drawingPad" width="450" height="300"></canvas>
        <div class="row" style="margin-top:15px">
             <button class="btn-login" style="background:#e53e3e; flex:1" onclick="clearCanvas()">× ×§×”</button>
             <button class="btn-login" style="background:var(--whatsapp); flex:1" onclick="saveDrawing()">×©××•×¨ ×©×¨×˜×•×˜</button>
             <button class="btn-login" style="background:#ccc; flex:1" onclick="closeDrawing()">×‘×™×˜×•×œ</button>
        </div>
    </div>
</div>

<script>
    // --- × ×ª×•× ×™× ---
    const profilesDB = {
        "sliding": ["×§×œ×™×œ 7000 ×§×œ××¡×™", "×§×œ×™×œ 9000", "×§×œ×™×œ 9200", "×§×œ×™×œ 1700 ×‘×œ×’×™", "×§×œ×™×œ 2200 ××•×¤×™×¡"],
        "pocket": ["×›×™×¡ ×‘×•×“×“ (2 × ×ª×™×‘×™×)", "×›×™×¡ ×‘×•×“×“ (3 × ×ª×™×‘×™×)", "×›×™×¡ ×›×¤×•×œ (2 × ×ª×™×‘×™×)", "×›×™×¡ ×›×¤×•×œ (3 × ×ª×™×‘×™×)"],
        "hinge": ["×§×œ×™×œ 4500 ×§×œ××¡×™", "×§×œ×™×œ 4300 ×‘×œ×’×™", "×§×œ×™×œ 5500 ×‘××•×”××•×¡", "×§×œ×™×œ 4400"],
        "kipp": ["×§×œ×™×œ 4500 ×§×™×¤", "×§×œ×™×œ 4300 ×§×™×¤", "×§×œ×™×œ 5500 ×§×™×¤"],
        "tilt_turn": ["×§×œ×™×œ 4500 ×“×¨×™×™-×§×™×¤", "×§×œ×™×œ 4300 ×“×¨×™×™-×§×™×¤", "×§×œ×™×œ 5500 ×“×¨×™×™-×§×™×¤"],
        "fixed": ["×§×œ×™×œ 4300 ×‘×œ×’×™ FIX", "×§×œ×™×œ 4500 ×§×œ××¡×™ FIX", "×§×œ×™×œ 2000 ×‘×™×™×¡×™×§ FIX", "×§×œ×™×œ 5500 ××•×¤×™×¡ FIX"],
        "showcase": ["×•×™×˜×¨×™× ×” 9000", "×•×™×˜×¨×™× ×” 9200", "×•×™×˜×¨×™× ×” 2200", "×•×™×˜×¨×™× ×” 7000"],
        "door": ["×“×œ×ª 2000 ×¤× ×œ", "×“×œ×ª ×œ×•×‘×™ ×–×›×•×›×™×ª", "×“×œ×ª ×¦×™×¨ ×‘×œ×’×™ 4300", "×“×œ×ª ××™× ×˜×¨×§×•×", "×“×œ×ª 4500"],
        "shutter": ["×©×œ×‘ 8 (×¨×’×™×œ)", "×©×œ×‘ ××•×¨ (××™× ×™)", "×©×œ×‘ ××•×§×¦×£"],
        "screen_roll": ["×¨×©×ª ×’×œ×™×œ×” (×× ×›×™×ª)", "×¨×©×ª ×”×–×–×”", "×¨×©×ª ×§×‘×•×¢×”"],
        "pergola": ["×¤×¨×•×¤×™×œ ×”×™×™×˜×§ 120/40", "×¤×¨×•×¤×™×œ ×”×™×™×˜×§ 150/50", "×¤×¨×•×¤×™×œ ×“××‘×œ T", "×¤×¨×•×¤×™×œ 100/100", "×¨×¤×¤×•×ª Z", "×¨×¤×¤×•×ª ××œ×™×¤×˜×™×•×ª", "×“××•×™ ×¢×¥"],
        "fence": ["×’×“×¨ ×©×œ×‘×™× ××•×¤×§×™×™×", "×’×“×¨ ×”×™×™×˜×§"],
        "shower": ["××§×œ×—×•×Ÿ ×¦×™×¨×™× ×™×•×§×¨×ª×™", "××§×œ×—×•×Ÿ ×”×–×–×”", "×××‘×˜×™×•×Ÿ"],
        "joker": ["×¢×‘×•×“×” ×›×œ×œ×™×ª"]
    };

    const colorsDB = {
        "klil": {
            "iron": ["IRON 100 (×œ×‘×Ÿ)", "IRON 200 (×‘×–')", "IRON 300 (××‘×Ÿ)", "IRON 400 (××¤×•×¨)", "IRON 420 (×©×—×•×¨)", "IRON 500 (×—×•×)", "IRON 600 (×™×¨×•×§)", "IRON 700 (×›×—×•×œ)"],
            "fine": ["FINE IRON", "FINE ×›×¡×£", "FINE ×©××¤× ×™×”", "FINE ×‘×¨×•× ×–×”", "FINE ×œ×‘×Ÿ", "FINE ×©×—×•×¨"],
            "elox": ["×× ×•×“×™×™×– ×˜×‘×¢×™ (××˜)", "×× ×•×“×™×™×– ×›×¡×£", "×× ×•×“×™×™×– ×©××¤× ×™×”", "×× ×•×“×™×™×– ×‘×¨×•× ×–×”", "×× ×•×“×™×™×– ×©×—×•×¨"],
            "basic": ["×œ×‘×Ÿ 9010", "×œ×‘×Ÿ 9016 (×‘×•×”×§)", "×©×× ×ª 1013", "×©×—×•×¨ ××˜", "××¤×•×¨ 7035", "×—×•× 8014"],
            "office": ["××¤×•×¨ ××•×¤×™×¡", "×œ×‘×Ÿ ××•×¤×™×¡", "×‘×–' ××•×¤×™×¡", "×©×—×•×¨ ××•×¤×™×¡"]
        },
        "ral": {
            "ral_9xxx": ["9001 (Cream)", "9002 (Grey White)", "9005 (Jet Black)", "9006 (White Alum)", "9007 (Grey Alum)", "9010 (Pure White)", "9016 (Traffic White)"],
            "ral_7xxx": ["7000 (Squirrel Grey)", "7004 (Signal Grey)", "7012 (Basalt Grey)", "7016 (Anthracite)", "7021 (Black Grey)", "7035 (Light Grey)", "7040 (Window Grey)"],
            "ral_1xxx": ["1000", "1013 (Oyster White)", "1015 (Light Ivory)", "1018", "1023"],
            "ral_8xxx": ["8001", "8003", "8014 (Sepia Brown)", "8017 (Chocolate Brown)", "8019"],
            "ral_3xxx": ["3000", "3004", "3020"],
            "ral_5xxx": ["5002", "5005", "5010", "5015"],
            "ral_6xxx": ["6005 (Moss Green)", "6009", "6018", "6021"],
            "ral_2xxx": ["2000", "2004", "2010"],
            "ral_4xxx": ["4001", "4005", "4010"]
        }
    };

    const glassTypes = {
        "types": [
            "×˜×¨×™×¤×œ×§×¡ 3+3", "×˜×¨×™×¤×œ×§×¡ 3+4", "×˜×¨×™×¤×œ×§×¡ 3+5", "×˜×¨×™×¤×œ×§×¡ 3+6",
            "×˜×¨×™×¤×œ×§×¡ 4+4", "×˜×¨×™×¤×œ×§×¡ 4+5", "×˜×¨×™×¤×œ×§×¡ 4+6",
            "×˜×¨×™×¤×œ×§×¡ 5+5", "×˜×¨×™×¤×œ×§×¡ 6+6", "×˜×¨×™×¤×œ×§×¡ 8+8",
            "×‘×™×“×•×“×™×ª 4-6-4", "×‘×™×“×•×“×™×ª 4-9-4", "×‘×™×“×•×“×™×ª 4-12-4", "×‘×™×“×•×“×™×ª 4-16-4",
            "×‘×™×“×•×“×™×ª 5-9-5", "×‘×™×“×•×“×™×ª 6-9-6", "×‘×™×“×•×“×™×ª 6-12-6",
            "×‘×™×“×•×“×™×ª ×¢× ×¦×œ×•×Ÿ ×¤× ×™××™",
            "××—×•×¡××ª 4 ×\"×", "××—×•×¡××ª 5 ×\"×", "××—×•×¡××ª 6 ×\"×", "××—×•×¡××ª 8 ×\"×", "××—×•×¡××ª 10 ×\"×", "××—×•×¡××ª 12 ×\"×",
            "×¨×’×™×œ×” 4 ×\"×", "×¨×’×™×œ×” 5 ×\"×", "×¨×’×™×œ×” 6 ×\"×"
        ],
        "finish": [
            "×©×§×•×£ (Clear)", "×—×œ×‘×™ (Matte)", "×—×•× (Bronze)", "××¤×•×¨ (Grey)", "×™×¨×•×§", "×›×—×•×œ",
            "×¨×¤×œ×§×˜×™×‘×™ (××¨××”)", "×¦'×™× ×¦'×™×œ×”", "×¡×‘×ª×", "×’×¨× ×™×˜", "×¤×¡×™×/×ª×¨×™×¡"
        ]
    };
    
    // ×–×›×•×›×™×ª ×œ××§×œ×—×•×Ÿ ×‘×œ×‘×“
    const showerGlass = ["××—×•×¡××ª 6 ×\"×", "××—×•×¡××ª 8 ×\"×"];

    let itemCount = 0;
    let activeDrawingBtn = null; 
    
    document.addEventListener('DOMContentLoaded', () => { 
        document.getElementById('quoteDate').valueAsDate = new Date();
        const saved = localStorage.getItem('quoteCounter'); 
        document.getElementById('quoteNumber').value = saved ? saved : 1; 
    });

    function checkLogin() {
        if(document.getElementById('passwordInput').value === '1234') {
            document.getElementById('loginScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                document.getElementById('bottomNav').style.display = 'flex';
            }, 500);
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function addItem() {
        itemCount++;
        const container = document.getElementById('itemsContainer');
        const div = document.createElement('div');
        div.className = 'card fade-in item-card';
        div.id = `item-${itemCount}`;
        
        div.innerHTML = `
            <div class="card-header-row">
                <div class="card-title">××•×¦×¨ #${itemCount}</div>
                <button class="btn-delete" onclick="this.closest('.card').remove()">××—×§</button>
            </div>

            <label>×‘×—×¨ ×¡×•×’ ××•×¦×¨:</label>
            <select class="item-type" onchange="updateItemFields(this)">
                <option value="sliding">×—×œ×•×Ÿ ×”×–×–×”</option>
                <option value="pocket">×—×œ×•×Ÿ ×›×™×¡ (Pocket)</option>
                <option value="hinge">×—×œ×•×Ÿ ×¦×™×¨ (×¨×’×™×œ)</option>
                <option value="kipp">×—×œ×•×Ÿ ×§×™×¤ (×¤×ª×™×—×” ×¢×œ×™×•× ×”)</option>
                <option value="tilt_turn">×—×œ×•×Ÿ ×“×¨×™×™-×§×™×¤ (××©×•×œ×‘)</option>
                <option value="fixed">×—×œ×•×Ÿ ×§×‘×•×¢ (FIX)</option>
                <option value="showcase">×•×™×˜×¨×™× ×” ×§×‘×•×¢×” (Showcase)</option>
                <option value="door">×“×œ×ª×•×ª ×›× ×™×¡×” / ×œ×•×‘×™</option>
                <option value="shutter">×ª×¨×™×¡×™×</option>
                <option value="screen_roll">×¨×©×ª×•×ª</option>
                <option value="pergola">×¤×¨×’×•×œ×•×ª</option>
                <option value="fence">×’×“×¨×•×ª</option>
                <option value="shower">××§×œ×—×•× ×™×</option>
                <option value="joker">×›×œ×œ×™</option>
            </select>

            <div class="extra-panel"></div>

            <div class="standard-inputs">
                <label>×“×’× ×¤×¨×•×¤×™×œ:</label><select class="profile-select"><option>×‘×—×¨ ××•×¦×¨ ×§×•×“×</option></select>
                
                <div class="alum-color-section">
                    <label style="margin-top:10px">×’×•×•×Ÿ ××œ×•××™× ×™×•×:</label>
                    <div class="color-tabs">
                        <div class="tab active" onclick="switchColorTab(this, 'ral')">×˜××‘×•×¨ / RAL</div>
                        <div class="tab" onclick="switchColorTab(this, 'klil')">×§×œ×™×œ</div>
                    </div>
                    <div class="row">
                        <select class="color-family" onchange="updateColorShades(this)"></select>
                        <select class="color-shade"><option>×‘×—×¨ ××©×¤×—×” ×ª×—×™×œ×”</option></select>
                    </div>
                </div>

                <div class="glass-section">
                    <label style="margin-top:10px">×–×›×•×›×™×ª:</label>
                    <div class="row">
                        <select class="glass-type"></select>
                        <select class="glass-finish"></select>
                    </div>
                </div>

                <div class="dims-section">
                    <div class="row" style="margin-top:15px">
                        <div><label>×¨×•×—×‘ (×¡"×)</label><input type="number" class="w-input" placeholder="100"></div>
                        <div><label>×’×•×‘×” (×¡"×)</label><input type="number" class="h-input" placeholder="100"></div>
                    </div>
                </div>
                
                <div class="row" style="margin-top:10px;">
                     <div class="opening-dir-container" style="display:none; flex:1">
                        <label>×›×™×•×•×Ÿ ×¤×ª×™×—×”:</label>
                        <select class="open-dir">
                            <option value="right">×™××™×Ÿ</option>
                            <option value="left">×©×××œ</option>
                        </select>
                     </div>
                </div>

                <div class="row">
                    <div><label>×›××•×ª</label><input type="number" class="qty-input" value="1"></div>
                    <div><label style="color:var(--primary)">××—×™×¨ ×™×—' (â‚ª)</label><input type="number" class="price-input" placeholder="××—×™×¨ ×¤×™×§×¡"></div>
                </div>
                
                <button class="btn-download-sketch" onclick="generateSketch(this)">ğŸ“¸ ×¦×•×¨ ×©×¨×˜×•×˜ ××“×¨×™×›×œ×™</button>
            </div>
            
            <div class="joker-panel" style="display:none">
                <label>×›×•×ª×¨×ª ×”×¢×‘×•×“×”:</label><input type="text" class="joker-title">
                <label>×ª×™××•×¨ ××¤×•×¨×˜:</label><textarea class="joker-desc" rows="3"></textarea>
                <div class="row" style="margin-top:10px">
                     <button class="btn-login" style="background:#4a5568" onclick="openDrawing(this)">ğŸ¨ ×¦×™×™×¨ ×©×¨×˜×•×˜</button>
                     <div style="flex:1; position:relative; overflow:hidden;">
                        <button class="btn-login" style="background:#2d3748; width:100%">ğŸ“‚ ×”×¢×œ×” ×ª××•× ×”</button>
                        <input type="file" style="position:absolute; top:0; left:0; opacity:0; width:100%; height:100%" accept="image/*" onchange="previewImage(this)">
                     </div>
                </div>
                <div class="img-container" style="position:relative; margin-top:10px; display:none">
                    <img class="img-display" style="width:100%; border-radius:10px; border:1px solid #ccc">
                    <button class="btn-delete" style="position:absolute; top:5px; left:5px; background:rgba(255,255,255,0.9)" onclick="clearJokerImage(this)">ğŸ—‘ï¸ ××—×§ ×©×¨×˜×•×˜</button>
                </div>
                <div class="row" style="margin-top:15px">
                    <div><label>×›××•×ª</label><input type="number" class="qty-input-joker" value="1"></div>
                    <div><label style="color:var(--primary)">××—×™×¨ ×’×œ×•×‘×œ×™ (â‚ª)</label><input type="number" class="price-input-joker"></div>
                </div>
            </div>
        `;
        container.appendChild(div);
        
        switchColorTab(div.querySelector('.tab.active'), 'ral');
        updateItemFields(div.querySelector('.item-type'));
    }

    function switchColorTab(tab, type) {
        const card = tab.closest('.card');
        card.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const familySelect = card.querySelector('.color-family');
        familySelect.innerHTML = "";
        const families = (type === 'klil') ? 
            {"iron": "×§×œ×™×œ IRON", "fine": "×§×œ×™×œ FINE", "basic": "×§×œ×™×œ BASIC", "office": "×§×œ×™×œ OFFICE", "elox": "×§×œ×™×œ ×× ×•×“×™×™×–"} :
            {"ral_9xxx": "×œ×‘×Ÿ/×©×—×•×¨ (9xxx)", "ral_7xxx": "××¤×•×¨×™× (7xxx)", "ral_1xxx": "×‘×–'/×©×× ×ª (1xxx)", "ral_8xxx": "×—×•××™× (8xxx)", "ral_3xxx": "××“×•××™×", "ral_5xxx": "×›×—×•×œ×™×", "ral_6xxx": "×™×¨×•×§×™×", "ral_2xxx": "×›×ª×•××™×", "ral_4xxx": "×¡×’×•×œ×™×"};
        for (const [key, value] of Object.entries(families)) {
            const opt = document.createElement('option'); opt.value = key; opt.innerText = value; familySelect.appendChild(opt);
        }
        familySelect.setAttribute('data-type', type);
        updateColorShades(familySelect);
    }

    function updateColorShades(familySelect) {
        const card = familySelect.closest('.card');
        const shadeSelect = card.querySelector('.color-shade');
        const type = familySelect.getAttribute('data-type');
        const family = familySelect.value;
        shadeSelect.innerHTML = "";
        const shades = colorsDB[type][family] || [];
        shades.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.innerText = s; shadeSelect.appendChild(opt); });
    }

    function updateItemFields(select) {
        const card = select.closest('.card');
        const type = select.value;
        const extraPanel = card.querySelector('.extra-panel');
        const stdInputs = card.querySelector('.standard-inputs');
        const jokerPanel = card.querySelector('.joker-panel');
        const profSelect = card.querySelector('.profile-select');
        const dirContainer = card.querySelector('.opening-dir-container');
        const glassSection = card.querySelector('.glass-section');
        const dimsSection = card.querySelector('.dims-section');
        const alumSection = card.querySelector('.alum-color-section');

        if(type === 'joker') {
            stdInputs.style.display = 'none'; extraPanel.style.display = 'none'; jokerPanel.style.display = 'block'; return;
        }
        stdInputs.style.display = 'block'; jokerPanel.style.display = 'none';
        
        // ×›×™×•×•×Ÿ ×¤×ª×™×—×” ×¨×§ ×œ×¨×œ×•×•× ×˜×™×™×
        dirContainer.style.display = (type === 'hinge' || type === 'tilt_turn' || type === 'door') ? 'block' : 'none';

        // ×–×›×•×›×™×ª: ×”×¡×ª×¨×” ×‘×¤×¨×’×•×œ×”/×’×“×¨/×ª×¨×™×¡/×¨×©×ª
        if(type === 'pergola' || type === 'fence' || type === 'shutter' || type === 'screen_roll') {
            glassSection.style.display = 'none';
        } else {
            glassSection.style.display = 'block';
            // ×¢×“×›×•×Ÿ ×¨×©×™××ª ×–×›×•×›×™×ª ×œ××§×œ×—×•×Ÿ ××• ×¨×’×™×œ
            const glassTypeSelect = card.querySelector('.glass-type');
            glassTypeSelect.innerHTML = "";
            const list = (type === 'shower') ? showerGlass : glassTypes.types;
            list.forEach(t => glassTypeSelect.innerHTML += `<option value="${t}">${t}</option>`);
            
            // ×’×™××•×¨
            const glassFinishSelect = card.querySelector('.glass-finish');
            if (glassFinishSelect.options.length === 0) {
                 glassTypes.finish.forEach(f => glassFinishSelect.innerHTML += `<option value="${f}">${f}</option>`);
            }
        }
        
        // ×”×¡×ª×¨×ª ×¦×‘×¢ ××œ×•××™× ×™×•× ×‘××§×œ×—×•×Ÿ (×™×© ×¦×‘×¢ ×¤×¨×–×•×œ ×‘××§×•×)
        if (type === 'shower') { alumSection.style.display = 'none'; } else { alumSection.style.display = 'block'; }

        profSelect.innerHTML = "";
        (profilesDB[type] || []).forEach(p => {
            const opt = document.createElement('option'); opt.value = p; opt.innerText = p; profSelect.appendChild(opt);
        });

        // --- ××§×œ×—×•× ×™× (×œ×•×’×™×§×” ×—×“×©×”) ---
        if (type === 'shower') {
            extraPanel.innerHTML = `
                <div class="shower-options">
                    <label>×ª×¦×•×¨×”:</label>
                    <select class="shower-config" onchange="updateShowerDims(this)">
                        <option value="front">×—×–×™×ª (×‘×™×Ÿ ×§×™×¨×•×ª)</option>
                        <option value="corner">×¤×™× ×ª×™ (90Â°)</option>
                    </select>
                    
                    <div class="shower-layout-ui" style="margin-top:10px;"></div>
                    
                    <label style="margin-top:10px;">×¤×¨×–×•×œ ×•×ª×•×¡×¤×•×ª:</label>
                    <div class="row">
                        <select class="handle-type"><option value="knob">×™×“×™×ª ×›×¤×ª×•×¨</option><option value="towel">×™×“×™×ª ××’×‘×ª</option></select>
                        <select class="hardware-color"><option>× ×™×§×œ ××‘×¨×™×§</option><option>× ×™×§×œ ××˜</option><option>×©×—×•×¨ ××˜</option><option>×–×”×‘</option></select>
                    </div>
                    <div class="checkbox-row"><input type="checkbox" class="cb-stab"> <span>××•×˜ ×—×™×–×•×§ (×§×‘×•×¢)</span></div>
                    <div class="checkbox-row"><input type="checkbox" class="cb-seal"> <span>×¡×£ ××™× (×¡×¤×•×™×œ×¨)</span></div>
                </div>
            `;
            extraPanel.style.display = 'block';
            updateShowerDims(extraPanel.querySelector('.shower-config')); // ××ª×—×•×œ ××™×“×•×ª
            return;
        }
        
        // --- ×§×‘×•×¢×™× ×•×—×œ×•× ×•×ª ---
        if (type === 'fixed' || type === 'showcase') {
            dimsSection.innerHTML = `
                <div class="row" style="margin-top:15px">
                    <div><label>×¨×•×—×‘ (×¡"×)</label><input type="number" class="w-input" placeholder="100"></div>
                    <div><label>×’×•×‘×” ×™××™×Ÿ</label><input type="number" class="h-right-input" placeholder="100"></div>
                    <div><label>×’×•×‘×” ×©×××œ</label><input type="number" class="h-left-input" placeholder="100"></div>
                </div>
            `;
            extraPanel.innerHTML = `<div class="row"><div><label>×—×œ×•×§×•×ª ×œ××•×¨×š (×¢××•×“×™×)</label><input type="number" class="div-x" value="0"></div><div><label>×—×œ×•×§×•×ª ×œ×¨×•×—×‘ (×§×•×©×¨×•×ª)</label><input type="number" class="div-y" value="0"></div></div>`;
            extraPanel.style.display = 'block';
            return;
        } 
        
        // ×—×–×¨×” ×œ××™×“×•×ª ×¨×’×™×œ×•×ª
        dimsSection.innerHTML = `<div class="row" style="margin-top:15px"><div><label>×¨×•×—×‘ (×¡"×)</label><input type="number" class="w-input" placeholder="100"></div><div><label>×’×•×‘×” (×¡"×)</label><input type="number" class="h-input" placeholder="100"></div></div>`;

        let html = '';
        if(type === 'sliding') { html = `<div class="row"><div><label>××¡' ×›× ×¤×™×™×</label><input type="number" class="sl-sashes" value="2"></div><div><label>×¡×•×’ ××¤×’×©</label><select class="sl-meeting"><option value="side">×¦×“ ×œ×¦×“</option><option value="center">××¤×’×© ××¨×›×–×™</option></select></div></div><label>×—×œ×•×§×”:</label><select class="sl-div"><option value="none">×œ×œ×</option><option value="strips">×¤×¡×™×</option><option value="grid">×§×•×‘×™×•×ª</option></select>`; }
        else if(type === 'pocket') { html = `<label>×”×¨×›×‘ ×›× ×£:</label><select class="pkt-comp"><option>×–×›×•×›×™×ª ×‘×œ×‘×“</option><option>×–×›×•×›×™×ª + ×ª×¨×™×¡</option><option>×–×›×•×›×™×ª + ×ª×¨×™×¡ + ×¨×©×ª</option></select><label>×›×™×•×•×Ÿ ×›×™×¡:</label><select class="pkt-dir"><option value="right">×™××™×Ÿ</option><option value="left">×©×××œ</option></select>`; }
        else if(type === 'door') { html = `<label>×ª×•×¡×¤×•×ª ×§×‘×•×¢×™×:</label><div class="row"><input type="number" class="dr-top" placeholder="×’×•×‘×” ×§×‘×•×¢ ×¢×œ×™×•×Ÿ"><input type="number" class="dr-side" placeholder="×¨×•×—×‘ ×§×‘×•×¢ ×¦×“"></div><label style="margin-top:10px">××—×–×™×¨ ×©××Ÿ:</label><select class="dr-closer"><option value="none">×œ×œ×</option><option value="top">×—×™×¦×•× ×™</option><option value="floor">×¨×¦×¤×ª×™</option></select>`; }
        else if(type === 'shutter') { html = `<div class="row"><div><label>××¨×’×–</label><select class="sht-box"><option value="hidden">×¤× ×™××™/× ×¡×ª×¨</option><option value="external">×—×™×¦×•× ×™</option></select></div><div><label>×©×œ×‘</label><select class="sht-slat"><option value="light">×©×œ×‘ ××•×¨</option><option value="foam">××•×§×¦×£</option></select></div></div><div class="row" style="margin-top:10px"><div><label>×× ×•×¢</label><select class="sht-motor"><option>×—×©××œ×™</option><option>×™×“× ×™</option><option>×¡×•××¤×™</option></select></div></div>`; }
        else if(type === 'pergola') { html = `<div class="row"><div><label>×¡×•×’</label><select class="prg-type" onchange="togglePergolaPost(this)"><option value="wall">×ª×œ×•×™×”</option><option value="stand">×¢×•××“×ª</option></select></div><div class="prg-post-div" style="display:none"><label>×’×•×‘×” ×¢××•×“ (×¡"×)</label><input type="number" class="prg-post-h" placeholder="250"></div></div><div class="row" style="margin-top:10px"><div><label>×›×™×•×•×Ÿ ×”×¦×œ×œ×”</label><select class="prg-dir"><option value="width">×œ×¨×•×—×‘ (×¤×¡×™×)</option><option value="length">×œ××•×¨×š (×¤×¡×™×)</option><option value="grid">×©×ª×™ ×•×¢×¨×‘ (×›×•×•×¨×ª)</option></select></div><div style="display:flex; align-items:center;"><input type="checkbox" class="prg-gutter" style="width:20px; height:20px"> <span style="margin-right:10px">××¨×–×‘</span></div></div>`; }
        else if(type === 'fence') { html = `<label>××¨×•×•×— ×‘×™×Ÿ ×©×œ×‘×™× (×¡"×):</label><input type="number" class="fence-space" value="2" placeholder="×œ×“×•×’××”: 2">`; }
        
        if(html) { extraPanel.innerHTML = html; extraPanel.style.display = 'block'; } else { extraPanel.style.display = 'none'; }
    }

    function togglePergolaPost(select) { select.closest('.extra-panel').querySelector('.prg-post-div').style.display = select.value === 'stand' ? 'block' : 'none'; }

    function updateShowerDims(select) {
        const card = select.closest('.card');
        const config = select.value;
        const dimsSection = card.querySelector('.dims-section');
        const layoutUI = card.querySelector('.shower-layout-ui');
        
        if (config === 'front') {
            dimsSection.innerHTML = `<div class="row" style="margin-top:15px"><div><label>×¨×•×—×‘ ×¤×ª×— (×¡"×)</label><input type="number" class="w-input" placeholder="100"></div><div><label>×’×•×‘×” (×¡"×)</label><input type="number" class="h-input" placeholder="190"></div></div>`;
            layoutUI.innerHTML = `<label>×”×¨×›×‘ ×—×–×™×ª:</label><select class="shower-layout-type"><option value="1wing">×›× ×£ ××—×ª</option><option value="2wing">2 ×›× ×¤×™×™× (×¤×¨×¤×¨)</option><option value="fix_wing">×§×‘×•×¢ + ×›× ×£</option><option value="sliding">×—×–×™×ª ×”×–×–×”</option></select>`;
        } else { // corner
            dimsSection.innerHTML = `<div class="row" style="margin-top:15px"><div><label>×¨×•×—×‘ ×™××™×Ÿ (×¡"×)</label><input type="number" class="w-right-input" placeholder="80"></div><div><label>×¨×•×—×‘ ×©×××œ (×¡"×)</label><input type="number" class="w-left-input" placeholder="80"></div><div><label>×’×•×‘×” (×¡"×)</label><input type="number" class="h-input" placeholder="190"></div></div>`;
            layoutUI.innerHTML = `<div class="row"><div><label>×¦×“ ×™××™×Ÿ:</label><select class="shower-side-r"><option value="wing">×“×œ×ª</option><option value="fix">×§×‘×•×¢</option><option value="fix_wing">×§×‘×•×¢+×“×œ×ª</option></select></div><div><label>×¦×“ ×©×××œ:</label><select class="shower-side-l"><option value="wing">×“×œ×ª</option><option value="fix">×§×‘×•×¢</option><option value="fix_wing">×§×‘×•×¢+×“×œ×ª</option></select></div></div>`;
        }
    }

    // --- ×¦×™×•×¨ ---
    function openDrawing(btn) { activeDrawingBtn = btn; document.getElementById('drawingModal').style.display = 'flex'; initCanvas(); }
    function closeDrawing() { document.getElementById('drawingModal').style.display = 'none'; }
    function previewImage(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const container = input.closest('.joker-panel').querySelector('.img-container');
                const img = container.querySelector('.img-display');
                img.src = e.target.result;
                container.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    function clearJokerImage(btn) {
        const container = btn.closest('.img-container');
        container.querySelector('.img-display').src = "";
        container.style.display = "none";
        btn.closest('.joker-panel').querySelector('input[type="file"]').value = "";
    }
    
    let canvas, ctx, isDrawing = false;
    function initCanvas() {
        canvas = document.getElementById('drawingPad');
        ctx = canvas.getContext('2d');
        ctx.fillStyle = "white"; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.strokeStyle = "black"; ctx.lineWidth = 3; ctx.lineCap = "round";
        canvas.addEventListener('touchstart', startDraw); canvas.addEventListener('touchmove', draw); canvas.addEventListener('touchend', stopDraw);
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw);
    }
    function startDraw(e) { isDrawing = true; draw(e); }
    function stopDraw() { isDrawing = false; ctx.beginPath(); }
    function draw(e) {
        if (!isDrawing) return; e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
    }
    function clearCanvas() { ctx.fillStyle="white"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.beginPath(); }
    function saveDrawing() {
        const dataURL = canvas.toDataURL();
        const container = activeDrawingBtn.closest('.joker-panel').querySelector('.img-container');
        const img = container.querySelector('.img-display');
        img.src = dataURL;
        container.style.display = 'block';
        closeDrawing();
    }

    // --- ×—×™×©×•×‘×™× ×•-PDF ---
    function calculateAll() {
        let itemsSum = 0;
        document.querySelectorAll('.item-card').forEach(card => {
            const type = card.querySelector('.item-type').value;
            let q, p;
            if(type === 'joker') {
                q = parseFloat(card.querySelector('.qty-input-joker').value) || 1;
                p = parseFloat(card.querySelector('.price-input-joker').value) || 0;
            } else {
                q = parseFloat(card.querySelector('.qty-input').value) || 1;
                p = parseFloat(card.querySelector('.price-input').value) || 0;
            }
            itemsSum += (q * p);
        });
        const install = parseFloat(document.getElementById('installationCost').value) || 0;
        const totalSub = itemsSum + install;
        const vat = totalSub * 0.18; 
        const final = totalSub + vat;
        document.getElementById('itemsSubtotal').innerText = itemsSum.toLocaleString() + " â‚ª";
        document.getElementById('installSubtotal').innerText = install.toLocaleString() + " â‚ª";
        document.getElementById('totalSub').innerText = totalSub.toLocaleString() + " â‚ª";
        document.getElementById('totalVat').innerText = vat.toLocaleString() + " â‚ª";
        document.getElementById('totalFinal').innerText = final.toLocaleString() + " â‚ª";
        document.getElementById('resultBox').style.display = 'block';
        setTimeout(() => document.getElementById('bottomNav').scrollIntoView({behavior:'smooth'}), 200);
    }

    function showPdfPreview() {
        const clientName = document.getElementById('clientName').value || "×™×©×¨××œ ×™×©×¨××œ×™";
        const quoteDate = new Date(document.getElementById('quoteDate').value).toLocaleDateString('he-IL');
        const quoteNum = document.getElementById('quoteNumber').value || "1";
        
        let htmlContent = `
            <div class="invoice-header">
                <h1 style="margin:0; color:#0d47a1; font-size: 32px;">×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</h1>
                <p style="margin:5px 0; font-size: 18px; color: #555;">×”×¦×¢×ª ××—×™×¨ ××§×¦×•×¢×™×ª</p>
                <div style="display:flex; justify-content:space-between; margin-top:30px; font-weight:bold; font-size: 16px;">
                    <span>×œ×§×•×—: ${clientName}</span>
                    <span>×ª××¨×™×š: ${quoteDate}</span>
                    <span>××¡' ×”×¦×¢×”: ${quoteNum}</span>
                </div>
            </div>
            <table>
                <thead>
                    <tr><th style="width:5%">#</th><th style="width:45%">×ª×™××•×¨ ××•×¦×¨</th><th style="width:15%">××™×“×•×ª (×¡"×)</th><th style="width:10%">×›××•×ª</th><th style="width:10%">××—×™×¨ ×™×—'</th><th style="width:15%">×¡×”"×›</th></tr>
                </thead>
                <tbody>
        `;

        let index = 1;
        let itemsSum = 0;
        document.querySelectorAll('.item-card').forEach(card => {
            const typeSelect = card.querySelector('.item-type');
            const typeName = typeSelect.options[typeSelect.selectedIndex].text;
            let desc = `<b>${typeName}</b>`;
            let dims = "";
            let qty = 0, price = 0;

            if(typeSelect.value === 'joker') {
                desc += `<br>${card.querySelector('.joker-title').value} - ${card.querySelector('.joker-desc').value}`;
                qty = parseFloat(card.querySelector('.qty-input-joker').value) || 1;
                price = parseFloat(card.querySelector('.price-input-joker').value) || 0;
                dims = "-";
            } else {
                const profile = card.querySelector('.profile-select').value;
                
                // ×¦×‘×¢
                if (typeSelect.value !== 'shower') {
                     const shade = card.querySelector('.color-shade').value;
                     desc += `<br>×¤×¨×•×¤×™×œ: ${profile}<br>×¦×‘×¢: ${shade}`;
                } else {
                     const hwColor = card.querySelector('.hardware-color').value;
                     desc += `<br>×“×’×: ${profile}<br>×¤×¨×–×•×œ: ${hwColor}`;
                }

                if(typeSelect.value !== 'pergola' && typeSelect.value !== 'fence' && typeSelect.value !== 'shutter' && typeSelect.value !== 'screen_roll') {
                    const glass = card.querySelector('.glass-type').value;
                    const finish = card.querySelector('.glass-finish').value;
                    desc += `<br>×–×›×•×›×™×ª: ${glass}, ${finish}`;
                }
                
                // ××™×“×•×ª
                if (typeSelect.value === 'fixed' || typeSelect.value === 'showcase') {
                     const hR = card.querySelector('.h-right-input').value;
                     const hL = card.querySelector('.h-left-input').value;
                     dims = `${card.querySelector('.w-input').value} / ${hR}-${hL}`;
                } else if (typeSelect.value === 'shower') {
                     const config = card.querySelector('.shower-config').value;
                     const h = card.querySelector('.h-input').value;
                     if (config === 'front') dims = `${card.querySelector('.w-input').value} / ${h}`;
                     else dims = `${card.querySelector('.w-right-input').value}x${card.querySelector('.w-left-input').value} / ${h}`;
                } else {
                     dims = `${card.querySelector('.w-input').value} / ${card.querySelector('.h-input').value}`;
                }
                
                qty = parseFloat(card.querySelector('.qty-input').value) || 1;
                price = parseFloat(card.querySelector('.price-input').value) || 0;
            }
            const total = qty * price;
            itemsSum += total;

            htmlContent += `<tr>
                <td>${index++}</td><td>${desc}</td><td style="direction:ltr; text-align:center">${dims}</td><td style="text-align:center">${qty}</td><td>${price.toLocaleString()} â‚ª</td><td>${total.toLocaleString()} â‚ª</td>
            </tr>`;
        });

        const install = parseFloat(document.getElementById('installationCost').value) || 0;
        const totalBeforeVat = itemsSum + install;
        const vat = totalBeforeVat * 0.18;
        const finalTotal = totalBeforeVat + vat;

        htmlContent += `
                </tbody>
            </table>
            <div class="summary-box">
                <div class="summary-row"><span>×¡×”"×› ××•×¦×¨×™× + ×”×ª×§× ×”:</span><span>${totalBeforeVat.toLocaleString()} â‚ª</span></div>
                <div class="summary-row"><span>××¢"× (18%):</span><span>${vat.toLocaleString()} â‚ª</span></div>
                <div class="summary-row total"><span>×¡×”"×› ×œ×ª×©×œ×•×:</span><span>${finalTotal.toLocaleString()} â‚ª</span></div>
            </div>
            <div style="clear:both"></div>
            <div style="margin-top:60px; font-size:12px; color:#555; border-top:1px solid #ccc; padding-top:15px; line-height: 1.8;">
                * ×”××—×™×¨ ×›×•×œ×œ ×”×•×‘×œ×” ×•×”×ª×§× ×”.<br>* ×”×¦×¢×ª ××—×™×¨ ×–××ª ××©××©×ª ×›×—×•×–×” ×¢×‘×•×“×”.<br>* ×”×¡×—×•×¨×” ×‘×‘×¢×œ×•×ª ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× ×¢×“ ×”×ª×©×œ×•× ×”××œ×.<br>* ×”×¦×¢×ª ××—×™×¨ ×ª×§×¤×” ×œ-5 ×™××™ ×¢×¡×§×™×.<br><strong>×‘×›×‘×•×“ ×¨×‘, ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</strong>
            </div>
        `;

        document.getElementById('pdfPaperContent').innerHTML = htmlContent;
        document.getElementById('pdfPreviewModal').style.display = 'flex';
    }

    function downloadActualPdf() {
        const element = document.getElementById('pdfPaperContent');
        const clientName = document.getElementById('clientName').value || "×”×¦×¢×”";
        const opt = {
            margin: 0.5,
            filename: `×”×¦×¢×ª_××—×™×¨_${clientName}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).toPdf().get('pdf').save();
    }

    // --- PRO SKETCH ENGINE V10 ---
    function generateSketch(btn) {
        const card = btn.closest('.card');
        const typeSelect = card.querySelector('.item-type');
        const type = typeSelect.value;
        const typeName = typeSelect.options[typeSelect.selectedIndex].text; 
        const profile = card.querySelector('.profile-select').value;
        
        const canvas = document.createElement('canvas');
        canvas.width = 1200; canvas.height = 900;
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = "white"; ctx.fillRect(0,0,1200,900);
        ctx.fillStyle = "#0d47a1"; ctx.font = "bold 40px Arial"; ctx.textAlign = "center";
        ctx.fillText("×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×", 600, 60);
        ctx.fillStyle = "#333"; ctx.font = "24px Arial";
        const client = document.getElementById('clientName').value || "×œ×§×•×—";
        ctx.fillText(`×œ×§×•×—: ${client} | ×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}`, 600, 100);
        
        let title = `${typeName} - ${profile}`;
        if(type === 'pergola' && card.querySelector('.prg-type').value === 'stand') {
            title += ` | ×’×•×‘×” ×¢××•×“: ${card.querySelector('.prg-post-h').value} ×¡"×`;
        }
        ctx.font = "20px Arial"; ctx.fillStyle = "#555";
        ctx.fillText(title, 600, 140);
        
        // ××©×ª× ×™× ×›×œ×œ×™×™×
        let w, h, hRight, hLeft;
        const maxDrawW = 700; const maxDrawH = 500;
        let dw, dh, startX, startY;

        // ××™×“×•×ª ×œ×¤×™ ××•×¦×¨
        if (type === 'fixed' || type === 'showcase') {
             w = parseFloat(card.querySelector('.w-input').value) || 100;
             hRight = parseFloat(card.querySelector('.h-right-input').value) || 100;
             hLeft = parseFloat(card.querySelector('.h-left-input').value) || 100;
             h = Math.max(hRight, hLeft);
        } else if (type === 'shower') {
             h = parseFloat(card.querySelector('.h-input').value) || 190;
             const conf = card.querySelector('.shower-config').value;
             if (conf === 'front') w = parseFloat(card.querySelector('.w-input').value) || 100;
             else w = (parseFloat(card.querySelector('.w-right-input').value)||80) + (parseFloat(card.querySelector('.w-left-input').value)||80) + 20; // 20 spacing
        } else {
             w = parseFloat(card.querySelector('.w-input').value) || 100;
             h = parseFloat(card.querySelector('.h-input').value) || 100;
        }

        // ×—×™×©×•×‘ ×™×—×¡
        const ratio = w / h;
        if (ratio > 1) { dw = maxDrawW; dh = maxDrawW / ratio; if(dh > maxDrawH){ dh = maxDrawH; dw = dh * ratio; } }
        else { dh = maxDrawH; dw = maxDrawH * ratio; if(dw > maxDrawW){ dw = maxDrawW; dh = dw / ratio; } }
        
        startX = (1200 - dw) / 2;
        startY = 250;
        
        ctx.strokeStyle = "#333"; ctx.lineWidth = 3;

        // *** ×œ×•×’×™×§×ª ×”×©×¨×˜×•×˜×™× ***

        if (type === 'shower') {
             // ×©×¨×˜×•×˜ ××§×œ×—×•×Ÿ
             const conf = card.querySelector('.shower-config').value;
             const hwColor = card.querySelector('.hardware-color').value;
             ctx.strokeStyle = (hwColor === '×©×—×•×¨ ××˜') ? 'black' : '#888'; // ×¦×‘×¢ ×¤×¨×–×•×œ
             
             if (conf === 'front') {
                 // ×—×–×™×ª
                 ctx.strokeRect(startX, startY, dw, dh);
                 const layout = card.querySelector('.shower-layout-type').value;
                 if (layout === '2wing') {
                     ctx.beginPath(); ctx.moveTo(startX+dw/2, startY); ctx.lineTo(startX+dw/2, startY+dh); ctx.stroke();
                     drawTriangle(ctx, startX, startY, dw/2, dh, 'left'); drawTriangle(ctx, startX+dw/2, startY, dw/2, dh, 'right');
                 } else if (layout === 'fix_wing') {
                     ctx.beginPath(); ctx.moveTo(startX+dw*0.4, startY); ctx.lineTo(startX+dw*0.4, startY+dh); ctx.stroke();
                     // ×§×‘×•×¢ (×©×××œ)
                     ctx.beginPath(); ctx.moveTo(startX+dw*0.4, startY+50); ctx.lineTo(startX, startY); ctx.stroke(); // ××•×˜ ×—×™×–×•×§
                     // ×“×œ×ª (×™××™×Ÿ)
                     drawTriangle(ctx, startX+dw*0.4, startY, dw*0.6, dh, 'right');
                 }
             } else {
                 // ×¤×™× ×ª×™ (×¤×¨×™×¡×”)
                 const wR = parseFloat(card.querySelector('.w-right-input').value)||80;
                 const wL = parseFloat(card.querySelector('.w-left-input').value)||80;
                 const totalW = wR + wL;
                 const pxR = (wR / totalW) * dw;
                 const pxL = (wL / totalW) * dw;
                 
                 // ×¦×“ ×™××™×Ÿ
                 ctx.strokeRect(startX + pxL + 10, startY, pxR, dh);
                 // ×¦×“ ×©×××œ
                 ctx.strokeRect(startX, startY, pxL, dh);
                 
                 // ×§×• ×”×¤×¨×“×” (×¤×™× ×”)
                 ctx.lineWidth = 5; ctx.strokeStyle = "#0d47a1"; 
                 ctx.beginPath(); ctx.moveTo(startX+pxL+5, startY); ctx.lineTo(startX+pxL+5, startY+dh); ctx.stroke();
                 ctx.lineWidth = 3; ctx.strokeStyle = (hwColor === '×©×—×•×¨ ××˜') ? 'black' : '#888';
                 
                 // ×¡×™××•× ×™×
                 const typeR = card.querySelector('.shower-side-r').value;
                 const typeL = card.querySelector('.shower-side-l').value;
                 
                 if(typeL === 'wing') drawTriangle(ctx, startX, startY, pxL, dh, 'left');
                 if(typeR === 'wing') drawTriangle(ctx, startX+pxL+10, startY, pxR, dh, 'right');
             }
             
             // ××™×“×•×ª ××§×œ×—×•×Ÿ
             ctx.fillStyle = "#0d47a1"; ctx.font = "bold 24px Arial"; 
             if (conf === 'front') ctx.fillText(w, startX+dw/2, startY-10);
             else { 
                 const wR = parseFloat(card.querySelector('.w-right-input').value);
                 const wL = parseFloat(card.querySelector('.w-left-input').value);
                 ctx.fillText(wL, startX + (dw*(wL/(wL+wR))/2), startY-10);
                 ctx.fillText(wR, startX + dw - (dw*(wR/(wL+wR))/2), startY-10);
             }
        }
        else if (type === 'fixed' || type === 'showcase') {
             const pixHRight = (hRight / h) * dh;
             const pixHLeft = (hLeft / h) * dh;
             ctx.beginPath();
             ctx.moveTo(startX, startY + dh); 
             ctx.lineTo(startX + dw, startY + dh); 
             ctx.lineTo(startX + dw, startY + dh - pixHRight); 
             ctx.lineTo(startX, startY + dh - pixHLeft); 
             ctx.closePath();
             ctx.save(); ctx.clip(); ctx.stroke();

             const cols = parseInt(card.querySelector('.div-x').value) || 0;
             const rows = parseInt(card.querySelector('.div-y').value) || 0;
             if (cols > 0) {
                 const colW = dw / (cols + 1);
                 for (let i = 1; i <= cols; i++) {
                     const x = startX + i * colW;
                     ctx.beginPath(); ctx.moveTo(x, startY); ctx.lineTo(x, startY + dh + 100); ctx.stroke(); 
                 }
             }
             if (rows > 0) {
                  const rowH = dh / (rows + 1);
                  for (let j = 1; j <= rows; j++) {
                      const y = startY + dh - j * rowH;
                      ctx.beginPath(); ctx.moveTo(startX, y); ctx.lineTo(startX + dw, y); ctx.stroke();
                  }
             }
             ctx.restore();
             // ××¡×’×¨×ª ×¢×œ×™×•× ×” ×©×•×‘
             ctx.beginPath(); ctx.moveTo(startX, startY + dh); ctx.lineTo(startX + dw, startY + dh); ctx.lineTo(startX + dw, startY + dh - pixHRight); ctx.lineTo(startX, startY + dh - pixHLeft); ctx.closePath(); ctx.stroke();
        }
        
        else if (type === 'sliding') {
            ctx.strokeRect(startX, startY, dw, dh);
            const sashes = parseInt(card.querySelector('.sl-sashes').value) || 2;
            const sashW = dw / sashes;
            for(let i=0; i<sashes; i++) {
                const offset = (i % 2 === 0) ? 0 : 15;
                ctx.strokeRect(startX+(i*sashW)+offset, startY+10, sashW-10, dh-20);
                drawArrow(ctx, startX+(i*sashW)+sashW/2, startY+dh/2, (i%2===0)?'right':'left');
            }
        }
        
        else if (type === 'pocket') {
            const dir = card.querySelector('.pkt-dir').value;
            ctx.setLineDash([10, 10]); 
            if (dir === 'right') { ctx.strokeRect(startX + dw, startY, 150, dh); drawArrow(ctx, startX + dw - 50, startY + dh/2, 'right'); } 
            else { ctx.strokeRect(startX - 150, startY, 150, dh); drawArrow(ctx, startX + 50, startY + dh/2, 'left'); }
            ctx.setLineDash([]); ctx.strokeRect(startX, startY, dw, dh); 
        }
        
        else if (['hinge', 'tilt_turn', 'door'].includes(type)) {
            ctx.strokeRect(startX, startY, dw, dh); 
            if(type !== 'door') ctx.strokeRect(startX+10, startY+10, dw-20, dh-20);
            const dir = card.querySelector('.open-dir').value;
            drawTriangle(ctx, startX, startY, dw, dh, dir);
            if(type === 'tilt_turn') drawTriangle(ctx, startX, startY, dw, dh, 'top');
            if(type === 'door') { // ×™×“×™×ª
                ctx.beginPath(); ctx.lineWidth=5;
                if(dir === 'right') { ctx.moveTo(startX+20, startY+dh/2); ctx.lineTo(startX+50, startY+dh/2); }
                else { ctx.moveTo(startX+dw-20, startY+dh/2); ctx.lineTo(startX+dw-50, startY+dh/2); }
                ctx.stroke(); ctx.lineWidth=3;
            }
        }
        
        else if (type === 'kipp') {
            ctx.strokeRect(startX, startY, dw, dh); ctx.strokeRect(startX+10, startY+10, dw-20, dh-20);
            drawTriangle(ctx, startX, startY, dw, dh, 'top'); 
        }

        else if (type === 'shutter') {
             const isHidden = card.querySelector('.sht-box').value === 'hidden';
             const boxH = dh * 0.15;
             if(isHidden) { ctx.setLineDash([5,5]); ctx.strokeRect(startX, startY-boxH, dw, boxH); ctx.setLineDash([]); }
             else { ctx.fillStyle = "#ddd"; ctx.fillRect(startX, startY-boxH, dw, boxH); ctx.strokeRect(startX, startY-boxH, dw, boxH); }
             ctx.strokeRect(startX, startY, dw, dh);
             for(let y=0; y<dh; y+=25) { ctx.strokeRect(startX, startY+y, dw, 23); }
        }
        
        else if (type === 'pergola') {
            const roofH = dh * 0.15; 
            ctx.fillStyle = "#eee"; ctx.fillRect(startX - 15, startY, dw + 30, roofH); 
            ctx.lineWidth = 4; ctx.strokeStyle = "#333"; ctx.strokeRect(startX - 15, startY, dw + 30, roofH);
            const dir = card.querySelector('.prg-dir').value;
            ctx.strokeStyle = "#777"; ctx.lineWidth = 2; 
            if(dir === 'width' || dir === 'grid') { for(let y=startY; y<startY+roofH; y+=15) { ctx.beginPath(); ctx.moveTo(startX-15, y); ctx.lineTo(startX+dw+15, y); ctx.stroke(); } }
            if(dir === 'length' || dir === 'grid') { for(let x=startX; x<startX+dw; x+=15) { ctx.beginPath(); ctx.moveTo(x, startY); ctx.lineTo(x, startY+roofH); ctx.stroke(); } }
            ctx.strokeRect(startX, startY + 5, dw, roofH - 10);
        }
        
        else if(type === 'fence') {
             ctx.strokeRect(startX, startY, dw, dh);
             const spaceCm = parseInt(card.querySelector('.fence-space').value) || 2;
             const spacePx = spaceCm * 5; 
             for(let y=10; y<dh; y += (10 + spacePx)) { ctx.fillRect(startX, startY+y, dw, 10); }
        }
        else if (type !== 'shower') { ctx.strokeRect(startX, startY, dw, dh); }

        // ×§×•×•×™ ××™×“×” ×›×œ×œ×™×™× (×œ× ×œ××§×œ×—×•×Ÿ ×©×›×‘×¨ ×§×™×‘×œ)
        if (type !== 'shower') {
            ctx.strokeStyle = "#0000aa"; ctx.lineWidth = 1;
            // ×¨×•×—×‘
            ctx.beginPath(); ctx.moveTo(startX, startY+dh+20); ctx.lineTo(startX, startY+dh+50); ctx.moveTo(startX+dw, startY+dh+20); ctx.lineTo(startX+dw, startY+dh+50); ctx.moveTo(startX, startY+dh+35); ctx.lineTo(startX+dw, startY+dh+35); ctx.stroke();
            ctx.fillStyle = "#0000aa"; ctx.font = "bold 30px Arial"; ctx.textAlign = "center"; ctx.fillText(`${w}`, startX+dw/2, startY+dh+65);
            
            // ×’×•×‘×” (×˜×™×¤×•×œ ×‘×©× ×™ ×’×‘×”×™× ×œ×§×‘×•×¢)
            if (type === 'fixed' || type === 'showcase') {
                 // ×’×•×‘×” ×™××™×Ÿ ×•×©×××œ
                 ctx.save(); ctx.translate(startX+dw+65, startY+dh/2); ctx.rotate(-Math.PI/2); ctx.fillText(`${hRight}`, 0, 0); ctx.restore();
                 ctx.save(); ctx.translate(startX-65, startY+dh/2); ctx.rotate(Math.PI/2); ctx.fillText(`${hLeft}`, 0, 0); ctx.restore();
            } else {
                 ctx.save(); ctx.translate(startX+dw+65, startY+dh/2); ctx.rotate(-Math.PI/2); ctx.fillText(`${h}`, 0, 0); ctx.restore();
            }
        }

        const link = document.createElement('a');
        link.download = `Sketch_${client}_${type}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }

    function drawArrow(ctx, x, y, dir) {
        ctx.beginPath(); ctx.lineWidth = 2;
        if (dir === 'right') { ctx.moveTo(x-20, y); ctx.lineTo(x+20, y); ctx.lineTo(x+10, y-10); ctx.moveTo(x+20, y); ctx.lineTo(x+10, y+10); }
        else { ctx.moveTo(x+20, y); ctx.lineTo(x-20, y); ctx.lineTo(x-10, y-10); ctx.moveTo(x-20, y); ctx.lineTo(x-10, y+10); }
        ctx.stroke(); ctx.lineWidth = 3;
    }

    function drawTriangle(ctx, x, y, w, h, dir) {
        ctx.setLineDash([15, 15]); ctx.lineWidth = 2; ctx.beginPath();
        if (dir === 'right') { ctx.moveTo(x, y); ctx.lineTo(x+w, y+h/2); ctx.lineTo(x, y+h); }
        else if (dir === 'left') { ctx.moveTo(x+w, y); ctx.lineTo(x, y+h/2); ctx.lineTo(x+w, y+h); }
        else if (dir === 'top') { ctx.moveTo(x, y+h); ctx.lineTo(x+w/2, y); ctx.lineTo(x+w, y+h); }
        ctx.stroke(); ctx.setLineDash([]); ctx.lineWidth = 3;
    }

    function openPreview() {
        let txt = `*×”×¦×¢×ª ××—×™×¨ - ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×*\n×œ×§×•×—: ${document.getElementById('clientName').value}\n×”×¦×¢×” ××¡': ${document.getElementById('quoteNumber').value}\n\n`;
        document.querySelectorAll('.item-card').forEach(c => {
            const type = c.querySelector('.item-type').value;
            const price = c.querySelector('.price-input').value || c.querySelector('.price-input-joker').value;
            txt += `ğŸ”¹ ××•×¦×¨ ${type}\n××—×™×¨: ${price} â‚ª\n\n`;
        });
        txt += `*×¡×”"×›: ${document.getElementById('totalFinal').innerText}*`;
        document.getElementById('previewText').value = txt;
        document.getElementById('previewModal').style.display = 'flex';
    }

    function sendWhatsapp() { window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('previewText').value)}`); }
</script>
</body>
</html>
