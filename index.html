<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="×™×”×•× ×ª×Ÿ PRO">
    <title>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ×”×¢×™×¦×•×‘ ×”××§×•×¨×™ ×©×œ×š --- */
        :root { --primary: #0d47a1; --primary-light: #42a5f5; --bg: #f0f4f8; --card: #ffffff; --text-dark: #1a202c; --whatsapp: #25D366; --border: #cbd5e0; --input-bg: #f7fafc; --danger: #e53e3e; }
        body { font-family: 'Rubik', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text-dark); -webkit-tap-highlight-color: transparent; height: 100vh; overflow-x: hidden; }
        
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0d47a1 0%, #002171 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .login-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .btn-login { background: var(--primary); color: white; width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .login-box input { width: 90%; margin-bottom: 15px; text-align: center; font-size: 20px; letter-spacing: 2px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }

        header { background: linear-gradient(135deg, var(--primary) 0%, #1976d2 100%); color: white; padding: 30px 20px 40px; text-align: center; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; box-shadow: 0 10px 25px rgba(13,71,161,0.25); position: relative; z-index: 10; }
        header h1 { margin: 0; font-size: 26px; font-weight: 800; }
        
        .container { padding: 0 20px; max-width: 650px; margin: -30px auto 0; padding-bottom: 140px; position: relative; z-index: 20; display: none; }
        
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid white; position: relative; }
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--primary); }
        .btn-delete { background: #fff5f5; color: var(--danger); border: 1px solid #fed7d7; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; background-color: var(--input-bg); margin-bottom: 15px; font-family: 'Rubik', sans-serif; box-sizing: border-box; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-light); outline: none; box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.15); background: #fff; }
        
        .row { display: flex; gap: 12px; } .row > div { flex: 1; }
        
        .btn-add-item { width: 100%; background: white; color: var(--primary); border: 2px dashed var(--primary-light); padding: 15px; border-radius: 15px; font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
        
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px 25px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); z-index: 100; border-radius: 20px 20px 0 0; display: none; gap: 10px; }
        .btn-action { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; text-align: center; }
        .btn-calc { background: linear-gradient(90deg, var(--primary) 0%, #1565c0 100%); color: white; }
        .btn-pdf { background: #e53e3e; color: white; }

        .result-box { background: white; border-radius: 20px; border: 2px solid var(--primary-light); margin-top: 25px; display: none; overflow: hidden; margin-bottom: 20px; }
        .result-header { background: var(--primary-light); color: white; padding: 15px; text-align: center; font-weight: 700; }
        .result-body { padding: 20px; }
        .total-line { font-size: 24px; font-weight: 800; color: var(--primary); border-top: 2px dashed #cbd5e0; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-between; }

        /* --- ×ª×•×¡×¤×•×ª ×œ×•×’×™×•×ª ×—×“×©×•×ª (×‘××¡×’×¨×ª ×”×¢×™×¦×•×‘ ×”×§×™×™×) --- */
        .extra-panel { background: #f8fafc; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .notch-grid { display: flex; gap: 10px; margin-bottom: 10px; }
        .notch-btn { flex: 1; padding: 10px; border: 1px solid #ccc; background: white; border-radius: 8px; cursor: pointer; font-size: 20px; text-align: center; }
        .notch-btn.selected { background: var(--primary-light); color: white; border-color: var(--primary); }
        
        .legal-footer { margin-top: 30px; font-size: 11px; color: #4a5568; text-align: center; border-top: 1px solid #ccc; padding-top: 15px; line-height: 1.6; display: none; }
        
        .btn-download-sketch { background-color: #2d3748; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; border: none; cursor: pointer; width: 100%; margin-top: 5px; }

        /* ××•×“×œ */
        .modal-overlay { position: fixed; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; }

        /* PDF helpers */
        .show-on-pdf { display: none; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
        <h2>×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
        <input type="password" id="passwordInput" placeholder="****" inputmode="numeric">
        <button class="btn-login" onclick="checkLogin()">×”×™×›× ×¡</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">×¡×™×¡××” ×©×’×•×™×”</p>
    </div>
</div>

<div id="pdfContent"> <header><h1>×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</h1><p>××¢×¨×›×ª ×”×¦×¢×•×ª ××—×™×¨ ××§×¦×•×¢×™×ª</p></header>

    <div class="container" id="mainApp">
        <div class="card">
            <div class="card-title">ğŸ‘¤ ×¤×¨×˜×™ ×œ×§×•×—</div>
            <div class="row">
                <div style="flex:2"><label>×©× ×œ×§×•×—:</label><input type="text" id="clientName"></div>
                <div style="flex:1"><label>×ª××¨×™×š:</label><input type="date" id="quoteDate"></div>
            </div>
        </div>
        
        <div id="itemsContainer"></div>
        
        <button class="btn-add-item" data-html2canvas-ignore="true" onclick="addItem()">â• ×”×•×¡×£ ××•×¦×¨ ×—×“×©</button>

        <div class="result-box" id="resultBox">
            <div class="result-header">×¡×™×›×•× ×”×¦×¢×ª ××—×™×¨</div>
            <div class="result-body">
                <div class="price-line" style="display:flex; justify-content:space-between; margin-bottom:10px">
                    <span>×¡×”"×› ××•×¦×¨×™×:</span><span id="itemsSubtotal">0 â‚ª</span>
                </div>
                <div class="total-line">
                    <span>×¡×”"×› ×œ×ª×©×œ×•×:</span><span id="totalFinal">0 â‚ª</span>
                </div>

                <button class="btn-add-item" style="margin-top:20px; background:var(--whatsapp); color:white; border:none;" data-html2canvas-ignore="true" onclick="openPreview()">×©×œ×— ×‘×•×•××˜×¡××¤</button>

                <div class="legal-footer" style="display:block;">
                    * ×”××—×™×¨ ×›×•×œ×œ ×”×•×‘×œ×”.<br>
                    * ×”×¦×¢×ª ××—×™×¨ ×–××ª ××©××©×ª ×›×—×•×–×”.<br>
                    * ×”×¡×—×•×¨×” ×‘×‘×¢×œ×•×ª ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•× ×¢×“ ×”×ª×©×œ×•× ×”××œ×.<br>
                    * ×”×¦×¢×ª ××—×™×¨ ×ª×§×¤×” ×œ-5 ×™××™ ×¢×¡×§×™× ×•×™×ª×›× ×• ×©×™× ×•×™×™× ×§×œ×™× ×‘×™×•× ×—×ª×™××ª ×”×—×•×–×”.<br>
                    <strong>×‘×›×‘×•×“ ×¨×‘, ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-actions" id="bottomNav">
    <button class="btn-action btn-calc" onclick="calculateAll()">×—×©×‘ ×¡×”"×›</button>
    <button class="btn-action btn-pdf" onclick="generatePDF()">ğŸ“„ ×”×•×¨×“ PDF</button>
</div>

<div class="modal-overlay" id="previewModal">
    <div class="modal-content">
        <h3 style="text-align:center; color:var(--primary)">×˜×™×•×˜×ª ×”×•×“×¢×”</h3>
        <textarea id="previewText" style="width:100%; height:150px; font-family:sans-serif;"></textarea>
        <div class="row" style="margin-top:10px;">
            <button class="btn-login" style="background:#ccc; color:black" onclick="document.getElementById('previewModal').style.display='none'">×¡×’×•×¨</button>
            <button class="btn-login" style="background:var(--whatsapp)" onclick="sendWhatsapp()">×©×œ×—</button>
        </div>
    </div>
</div>

<script>
    // --- ×××’×¨ × ×ª×•× ×™× ××¢×•×“×›×Ÿ ×œ×¤×™ ×‘×§×©×ª×š ---
    const profilesDB = {
        sliding: ["×§×œ×™×œ 7000 ×§×œ××¡×™", "×§×œ×™×œ 9000", "×§×œ×™×œ 9200", "×§×œ×™×œ 1700 ×‘×œ×’×™", "×§×œ×™×œ 2200 ××•×¤×™×¡"],
        pocket: ["×›×™×¡ ×‘×•×“×“ (××¡×™×œ×” 2)", "×›×™×¡ ×‘×•×“×“ (××¡×™×œ×” 3)", "×›×™×¡ ×›×¤×•×œ (××¡×™×œ×” 2)", "×›×™×¡ ×›×¤×•×œ (××¡×™×œ×” 3)"],
        hinge: ["×§×œ×™×œ 4500 ×§×œ××¡×™", "×§×œ×™×œ 4300 ×‘×œ×’×™", "×§×œ×™×œ 5500 ×‘××•×”××•×¡"],
        fixed: ["×§×œ×™×œ 4300 ×‘×œ×’×™ FIX", "×§×œ×™×œ 4500 ×§×œ××¡×™ FIX", "×§×œ×™×œ 2000 ×‘×™×™×¡×™×§ FIX", "×§×œ×™×œ 5500 ××•×¤×™×¡ FIX", "××ª×× 7000/9000"],
        door: ["×“×œ×ª 2000 ×¤× ×œ", "×“×œ×ª ×œ×•×‘×™ ×–×›×•×›×™×ª", "×“×œ×ª ×¦×™×¨ ×‘×œ×’×™ 4300", "×“×œ×ª ××™× ×˜×¨×§×•×"],
        shutter: ["×©×œ×‘ 8 (×¨×’×™×œ)", "×©×œ×‘ ××•×¨ (××™× ×™)", "×©×œ×‘ ××•×§×¦×£"],
        pergola: ["×¤×¨×’×•×œ×” ×ª×œ×•×™×”", "×¤×¨×’×•×œ×” ×¢×•××“×ª", "×’×“×¨ ××œ×•××™× ×™×•×"],
        screen_roll: ["×¨×©×ª ×’×œ×™×œ×” (×× ×›×™×ª)", "×¨×©×ª ×”×–×–×”", "×¨×©×ª ×§×‘×•×¢×”"],
        shower: ["××§×œ×—×•×Ÿ ×—×–×™×ª", "××§×œ×—×•×Ÿ ×¤×™× ×ª×™"],
        joker: ["×¢×‘×•×“×” ×›×œ×œ×™×ª / ×©×•× ×•×ª"]
    };

    let itemCount = 0;
    document.getElementById('quoteDate').valueAsDate = new Date();

    function checkLogin() {
        if(document.getElementById('passwordInput').value === '1234') {
            document.getElementById('loginScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loginScreen').style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                document.getElementById('bottomNav').style.display = 'flex';
            }, 500);
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function addItem() {
        itemCount++;
        const container = document.getElementById('itemsContainer');
        const div = document.createElement('div');
        div.className = 'card item-card';
        div.dataset.id = itemCount;
        
        div.innerHTML = `
            <div class="card-header-row">
                <div class="card-title">×¤×¨×™×˜ #${itemCount}</div>
                <button class="btn-delete" onclick="this.closest('.card').remove()">××—×§</button>
            </div>

            <label>×¡×•×’ ××•×¦×¨:</label>
            <select class="item-type" onchange="updateItemFields(this)">
                <option value="sliding">×—×œ×•×Ÿ ×”×–×–×”</option>
                <option value="pocket">×—×œ×•×Ÿ ×›×™×¡ (Pocket)</option>
                <option value="hinge">×—×œ×•×Ÿ ×¦×™×¨ / ×“×¨×™×™ ×§×™×¤</option>
                <option value="fixed">×§×‘×•×¢ / ×•×™×˜×¨×™× ×”</option>
                <option value="door">×“×œ×ª ×›× ×™×¡×” / ×œ×•×‘×™</option>
                <option value="shutter">×ª×¨×™×¡×™×</option>
                <option value="pergola">×¤×¨×’×•×œ×•×ª ×•×’×“×¨×•×ª</option>
                <option value="screen_roll">×¨×©×ª×•×ª</option>
                <option value="shower">××§×œ×—×•× ×™×</option>
                <option value="joker">×›×œ×œ×™ / ×’'×•×§×¨</option>
            </select>

            <div class="dynamic-content"></div>

            <div class="standard-inputs">
                <div class="row">
                    <div><label>×¨×•×—×‘ (×¡"×)</label><input type="number" class="w-input" placeholder="100"></div>
                    <div><label>×’×•×‘×” (×¡"×)</label><input type="number" class="h-input" placeholder="100"></div>
                </div>
                <div class="row">
                    <div><label>×›××•×ª</label><input type="number" class="qty-input" value="1"></div>
                    <div><label style="color:var(--primary)">××—×™×¨ ×™×—' (â‚ª)</label><input type="number" class="price-input" placeholder="××—×™×¨ ×¤×™×§×¡"></div>
                </div>
                <button class="btn-download-sketch" onclick="generateSketch(this)">ğŸ“¸ ×¦×•×¨ ×©×¨×˜×•×˜ ××•×˜×•××˜×™</button>
                <div class="sketch-preview" style="margin-top:10px; max-width:100%;"></div>
            </div>
        `;
        container.appendChild(div);
        updateItemFields(div.querySelector('.item-type'));
    }

    function updateItemFields(select) {
        const card = select.closest('.card');
        const type = select.value;
        const container = card.querySelector('.dynamic-content');
        const stdInputs = card.querySelector('.standard-inputs');
        
        let html = '';

        if(type === 'joker') {
            stdInputs.style.display = 'none'; // ×‘×’'×•×§×¨ ××¡×ª×™×¨×™× ××ª ×”××™×“×•×ª ×”×¨×’×™×œ×•×ª
            html = `
                <label>×›×•×ª×¨×ª ×”×¢×‘×•×“×”:</label><input type="text" class="joker-title" placeholder="×œ×“×•×’××”: ×”×’×‘×”×ª ××¢×§×”">
                <label>×ª×™××•×¨ ××¤×•×¨×˜:</label><textarea class="joker-desc" rows="4"></textarea>
                <label>×”×¢×œ××ª ×ª××•× ×” ××”×©×˜×—:</label><input type="file" accept="image/*" onchange="previewImage(this)">
                <img class="img-display" style="width:100%; border-radius:10px; margin-top:10px; display:none;">
                <div class="row" style="margin-top:15px">
                    <div><label>×›××•×ª</label><input type="number" class="qty-input" value="1"></div>
                    <div><label style="color:var(--primary)">××—×™×¨ ×’×œ×•×‘×œ×™ (â‚ª)</label><input type="number" class="price-input"></div>
                </div>
            `;
            container.innerHTML = html;
            return;
        }

        stdInputs.style.display = 'block';
        
        // ×‘×—×™×¨×ª ×¤×¨×•×¤×™×œ
        html += `<label>×“×’× ×¤×¨×•×¤×™×œ:</label><select class="profile-select">`;
        (profilesDB[type] || []).forEach(p => html += `<option value="${p}">${p}</option>`);
        html += `</select>`;

        // ×ª×•×¡×¤×•×ª ×¡×¤×¦×™×¤×™×•×ª ×œ×¤×™ ×”×¨×©×™××” ×©×œ× ×•
        if(type === 'sliding') {
            html += `
            <div class="extra-panel">
                <div class="row">
                    <div><label>××¡' ×›× ×¤×™×™× (×”×§×œ×“)</label><input type="number" class="sl-sashes" value="2"></div>
                    <div><label>×¡×•×’ ××¤×’×©</label><input type="text" class="sl-meeting" placeholder="×œ××©×œ: ×›× ×£ ×¢×œ ×›× ×£"></div>
                </div>
                <label>×—×œ×•×§×” ("×‘×œ×’×™"):</label>
                <select class="sl-div"><option value="none">×œ×œ×</option><option value="strips">×¤×¡×™× ×œ×¨×•×—×‘</option><option value="grid">×§×•×‘×™×•×ª</option></select>
            </div>`;
        }
        else if(type === 'pocket') {
            html += `
            <div class="extra-panel">
                <label>×”×¨×›×‘ ×›× ×£:</label>
                <select class="pkt-comp"><option>×–×›×•×›×™×ª ×‘×œ×‘×“</option><option>×–×›×•×›×™×ª + ×ª×¨×™×¡</option><option>×–×›×•×›×™×ª + ×ª×¨×™×¡ + ×¨×©×ª</option></select>
            </div>`;
        }
        else if(type === 'fixed') {
            html += `
            <div class="extra-panel">
                <label>×”×× ×™×© ××’×¨×¢×ª (×—×™×ª×•×š)?</label>
                <div class="notch-grid">
                    <div class="notch-btn" onclick="selectNotch(this, 'TL')">âŒœ</div>
                    <div class="notch-btn" onclick="selectNotch(this, 'TR')">âŒ</div>
                    <div class="notch-btn" onclick="selectNotch(this, 'BL')">âŒ</div>
                    <div class="notch-btn" onclick="selectNotch(this, 'BR')">âŒŸ</div>
                </div>
                <input type="hidden" class="notch-pos" value="">
                <div class="row notch-dims" style="display:none">
                    <input type="number" class="notch-w" placeholder="×¨×•×—×‘ ×—×™×ª×•×š">
                    <input type="number" class="notch-h" placeholder="×’×•×‘×” ×—×™×ª×•×š">
                </div>
            </div>`;
        }
        else if(type === 'door') {
            html += `
            <div class="extra-panel">
                <label>×§×‘×•×¢×™×:</label>
                <div class="row">
                    <input type="number" class="dr-top" placeholder="×’×•×‘×” ×§×‘×•×¢ ×¢×œ×™×•×Ÿ">
                    <input type="number" class="dr-side" placeholder="×¨×•×—×‘ ×§×‘×•×¢ ×¦×“">
                </div>
                <label style="margin-top:10px">××—×–×™×¨ ×©××Ÿ:</label>
                <select class="dr-closer"><option value="none">×œ×œ×</option><option value="top">×¢×œ×™×•×Ÿ ×—×™×¦×•× ×™</option><option value="floor">×¨×¦×¤×ª×™</option><option value="hidden">×¡××•×™</option></select>
            </div>`;
        }
        else if(type === 'shutter') {
            html += `
            <div class="extra-panel">
                <div class="row">
                    <div><label>×¡×•×’ ×©×œ×‘</label><select class="sht-type"><option>××•×§×¦×£</option><option>×©×œ×‘ ××•×¨</option></select></div>
                    <div><label>××¨×’×–</label><select class="sht-box"><option>×¤× ×™××™/× ×¡×ª×¨</option><option>×—×™×¦×•× ×™</option></select></div>
                </div>
                <div class="row" style="margin-top:10px">
                    <div><label>×× ×•×¢</label><select class="sht-motor"><option>×™×“× ×™</option><option>×—×©××œ×™</option><option>×¡×•××¤×™</option><option>×¡×•××¤×™ ×¨×“×™×•</option></select></div>
                    <div><label>×›×•×— (Nm)</label><input type="number" class="sht-nm" placeholder="20"></div>
                </div>
            </div>`;
        }
        else if(type === 'pergola') {
            html += `
            <div class="extra-panel">
                <div class="row">
                    <div><label>×¡×•×’ ×§×™×¨×•×™</label><select class="prg-roof"><option>×œ×œ×</option><option>×¡× ×˜×£ ×¨×’×™×œ</option><option>×¡× ×˜×£ BH ×›×•×•×¨×ª</option></select></div>
                    <div style="display:flex; align-items:center; margin-top:20px"><input type="checkbox" class="prg-gutter" style="width:20px; height:20px"> <span style="margin-right:10px">×›×•×œ×œ ××¨×–×‘</span></div>
                </div>
            </div>`;
        }
        else if(type === 'pergola' && select.options[select.selectedIndex].text.includes('×’×“×¨')) {
             html += `
            <div class="extra-panel">
                <label>××¨×•×•×— ×‘×™×Ÿ ×©×œ×‘×™×:</label>
                <select class="fence-space"><option value="0">0 (××˜×•×)</option><option value="10">10 ×"×</option><option value="20">20 ×"×</option></select>
            </div>`;
        }

        container.innerHTML = html;
    }

    // --- ×œ×•×’×™×§×ª ××’×¨×¢×ª ---
    function selectNotch(btn, pos) {
        const panel = btn.closest('.extra-panel');
        // ××™×¤×•×¡ ×‘×—×™×¨×”
        panel.querySelectorAll('.notch-btn').forEach(b => b.classList.remove('selected'));
        // ×‘×—×™×¨×” ×—×“×©×”
        btn.classList.add('selected');
        panel.querySelector('.notch-pos').value = pos;
        panel.querySelector('.notch-dims').style.display = 'flex';
    }

    // --- ×”×¢×œ××ª ×ª××•× ×” ×œ×’'×•×§×¨ ---
    function previewImage(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = input.closest('.card').querySelector('.img-display');
                img.src = e.target.result;
                img.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- ×—×™×©×•×‘×™× ---
    function calculateAll() {
        let sum = 0;
        document.querySelectorAll('.item-card').forEach(card => {
            const q = parseFloat(card.querySelector('.qty-input').value) || 1;
            const p = parseFloat(card.querySelector('.price-input').value) || 0;
            sum += (q * p);
        });
        document.getElementById('itemsSubtotal').innerText = sum.toLocaleString() + " â‚ª";
        document.getElementById('totalFinal').innerText = sum.toLocaleString() + " â‚ª";
        document.getElementById('resultBox').style.display = 'block';
        setTimeout(() => document.getElementById('resultBox').scrollIntoView({behavior:'smooth'}), 200);
    }

    // --- ×”×¤×§×ª PDF ---
    function generatePDF() {
        const element = document.getElementById('pdfContent');
        // ×•×™×“×•× ×©×”×¡×™×›×•× ××•×¦×’
        document.getElementById('resultBox').style.display = 'block';
        
        const opt = {
            margin: 0.2,
            filename: `×”×¦×¢×ª_××—×™×¨_${document.getElementById('clientName').value}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
    }

    // --- ×©×¨×˜×•×˜ ×§× ×‘×¡ ×—×›× ---
    function generateSketch(btn) {
        const card = btn.closest('.card');
        const type = card.querySelector('.item-type').value;
        const w = parseFloat(card.querySelector('.w-input').value) || 100;
        const h = parseFloat(card.querySelector('.h-input').value) || 100;
        const container = card.querySelector('.sketch-preview');

        const canvas = document.createElement('canvas');
        canvas.width = 600; canvas.height = 400;
        const ctx = canvas.getContext('2d');
        
        // ×¨×§×¢ ×œ×‘×Ÿ × ×§×™
        ctx.fillStyle = "white"; ctx.fillRect(0,0,600,400);
        ctx.lineWidth = 3; ctx.strokeStyle = "#333";

        // ××¨×›×•×–
        const margin = 50;
        const maxW = 500; const maxH = 300;
        const startX = margin; const startY = margin;

        // ×¦×™×•×¨ ×œ×¤×™ ×¡×•×’
        if(type === 'fixed') {
            const notchPos = card.querySelector('.notch-pos')?.value;
            if(notchPos) {
                // ×©×¨×˜×•×˜ L
                const cutW = parseFloat(card.querySelector('.notch-w').value) || 0;
                const cutH = parseFloat(card.querySelector('.notch-h').value) || 0;
                
                // ×¡×™×œ××•×œ×¦×™×” ×’×¨×¤×™×ª ×¤×©×•×˜×” ×©×œ ×”"×‘×™×¡"
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                if(notchPos === 'TR') {
                    ctx.lineTo(startX+maxW-50, startY); ctx.lineTo(startX+maxW-50, startY+50); ctx.lineTo(startX+maxW, startY+50);
                } else { ctx.lineTo(startX+maxW, startY); }
                
                ctx.lineTo(startX+maxW, startY+maxH);
                ctx.lineTo(startX, startY+maxH);
                ctx.closePath();
                ctx.stroke();
                
                // ×˜×§×¡×˜ ××“×•×
                ctx.fillStyle = "red"; ctx.font = "16px Arial";
                ctx.fillText(`×—×™×ª×•×š: ${cutW}/${cutH}`, startX+maxW/2, startY+maxH/2);
            } else {
                ctx.strokeRect(startX, startY, maxW, maxH);
            }
        } 
        else if(type === 'pocket') {
            // ×§×™×¨
            ctx.setLineDash([5,5]); ctx.strokeStyle="#999";
            ctx.strokeRect(startX+maxW, startY, 100, maxH); // ×›×™×¡
            ctx.setLineDash([]); ctx.strokeStyle="#333";
            // ×¤×ª×—
            ctx.strokeRect(startX, startY, maxW, maxH);
            // ××¡×™×œ×” ×—×•×“×¨×ª
            ctx.beginPath(); ctx.moveTo(startX, startY+maxH-10); ctx.lineTo(startX+maxW+80, startY+maxH-10); ctx.stroke();
            ctx.fillText("×›×™×¡", startX+maxW+20, startY+maxH/2);
        }
        else if(type === 'shutter') {
            const isExt = card.querySelector('.sht-box').value.includes('×—×™×¦×•× ×™');
            let boxH = 40;
            if(isExt) {
                ctx.fillStyle = "#eee"; ctx.fillRect(startX, startY-boxH, maxW, boxH); ctx.strokeRect(startX, startY-boxH, maxW, boxH);
                ctx.fillStyle="black"; ctx.fillText("××¨×’×– ×—×™×¦×•× ×™", startX+20, startY-15);
            } else {
                ctx.setLineDash([5,5]); ctx.strokeRect(startX, startY-boxH, maxW, boxH); ctx.setLineDash([]);
                ctx.fillText("××¨×’×– × ×¡×ª×¨", startX+20, startY-15);
            }
            ctx.strokeRect(startX, startY, maxW, maxH);
            // ×©×œ×‘×™×
            const isLight = card.querySelector('.sht-type').value.includes('××•×¨');
            const gap = isLight ? 20 : 10;
            for(let y=0; y<maxH; y+=gap) { ctx.strokeRect(startX, startY+y, maxW, gap-2); }
        }
        else if(type === 'door') {
            const topH = parseFloat(card.querySelector('.dr-top')?.value) || 0;
            const sideW = parseFloat(card.querySelector('.dr-side')?.value) || 0;
            
            let currentY = startY;
            let currentX = startX;
            let doorH = maxH;
            let doorW = maxW;

            if(topH > 0) {
                ctx.strokeRect(startX, startY, maxW, 50); // ×§×‘×•×¢ ×¢×œ×™×•×Ÿ ×•×™×–×•××œ×™
                ctx.fillText("×§×‘×•×¢ ×¢×œ×™×•×Ÿ", startX+maxW/2-30, startY+30);
                currentY += 50; doorH -= 50;
            }
            if(sideW > 0) {
                ctx.strokeRect(startX, currentY, 50, doorH); // ×§×‘×•×¢ ×¦×“ ×•×™×–×•××œ×™
                ctx.fillText("×¦×“", startX+10, currentY+doorH/2);
                currentX += 50; doorW -= 50;
            }
            
            ctx.strokeRect(currentX, currentY, doorW, doorH); // ×”×“×œ×ª
            
            // ××—×–×™×¨ ×©××Ÿ
            const closer = card.querySelector('.dr-closer').value;
            if(closer !== 'none') {
                ctx.beginPath(); ctx.moveTo(currentX+doorW-10, currentY); ctx.lineTo(currentX+doorW-40, currentY); ctx.lineTo(currentX+doorW-10, currentY+30); ctx.fill();
            }
        }
        else if(type === 'screen_roll') {
            // ×§×¡×˜×”
            ctx.fillStyle="#ddd"; ctx.fillRect(startX, startY, maxW, 40); ctx.strokeRect(startX, startY, maxW, 40);
            ctx.fillStyle="black"; ctx.fillText("×§×¡×˜×” ×¨×©×ª", startX+maxW/2-30, startY+25);
            // ×¨×©×ª
            ctx.strokeRect(startX, startY+40, maxW, maxH-40);
        }
        else {
            // ×‘×¨×™×¨×ª ××—×“×œ
            ctx.strokeRect(startX, startY, maxW, maxH);
        }

        // ×˜×§×¡×˜ ××™×“×•×ª
        ctx.fillStyle = "black"; ctx.font = "20px Arial";
        ctx.fillText(`${w}`, startX + maxW/2, startY - 10);
        ctx.fillText(`${h}`, startX + maxW + 10, startY + maxH/2);

        // ×”×›× ×¡×ª ×”×ª××•× ×” ×œ-DOM
        const img = new Image();
        img.src = canvas.toDataURL();
        img.style.maxWidth = "100%";
        img.style.border = "1px solid #ccc";
        container.innerHTML = '';
        container.appendChild(img);
    }

    // --- ×•×•××˜×¡××¤ ---
    function openPreview() {
        let txt = `*×”×¦×¢×ª ××—×™×¨ - ×™×”×•× ×ª×Ÿ ××œ×•××™× ×™×•×*\n×œ×§×•×—: ${document.getElementById('clientName').value}\n\n`;
        document.querySelectorAll('.item-card').forEach(c => {
            const typeSelect = c.querySelector('.item-type');
            const typeName = typeSelect.options[typeSelect.selectedIndex].text;
            
            if(typeSelect.value === 'joker') {
                txt += `ğŸ”¹ *${c.querySelector('.joker-title').value}*\n${c.querySelector('.joker-desc').value}\n`;
            } else {
                const profile = c.querySelector('.profile-select').value;
                const w = c.querySelector('.w-input').value;
                const h = c.querySelector('.h-input').value;
                txt += `ğŸ”¹ *${typeName}* (${profile})\n××™×“×•×ª: ${w}x${h}\n`;
            }
            const q = c.querySelector('.qty-input').value;
            const p = c.querySelector('.price-input').value;
            txt += `×›××•×ª: ${q} | ××—×™×¨: ${p} â‚ª\n\n`;
        });
        txt += `*×¡×”"×›: ${document.getElementById('totalFinal').innerText}*`;
        document.getElementById('previewText').value = txt;
        document.getElementById('previewModal').style.display = 'flex';
    }

    function sendWhatsapp() {
        const txt = encodeURIComponent(document.getElementById('previewText').value);
        window.open(`https://wa.me/?text=${txt}`);
    }

</script>
</body>
</html>
